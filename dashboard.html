<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Masters Of Oops (MOO) - Dashboard</title>
  <link rel="icon" href="moo-portal.png" type="image/png">
  <script src="config.js"></script>
  <script src="portal-shim.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      text-align: center;
      padding: 32px 8px 60px 8px;
      min-height: 100vh;
      background-attachment: fixed;
    }

    /* Top Tabs */
    .tab-nav {
      background: rgba(30, 34, 40, 0.95);
      border-bottom: 1px solid #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      position: sticky; top: 0; z-index: 1000;
    }
    .tab-nav-container { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; padding: 0 16px; }
    .nav-brand { font-size: 20px; font-weight: 700; color: #ffb300; padding: 16px 0; margin-right: 32px; white-space: nowrap; display: flex; align-items: center; gap: 8px; text-shadow: 0 2px 8px #000a; }
    .nav-brand img { height: 32px; width: auto; }
    .tab-buttons {
      display: flex;
      gap: 4px;
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      align-items: center;
      height: 100px;
    }
    .tab-btn { 
      padding: 12px 16px; 
      background: none; 
      border: none; 
      color: #e0e0e0; 
      font-size: 28px; 
      font-weight: 500; 
      border-bottom: 3px solid transparent; 
      transition: all 0.2s; 
      white-space: nowrap; 
      text-decoration: none;
      display: block;
      cursor: pointer; 
      position: relative; 
    }
    .tab-btn:hover { color: #ffb300; background: #232526; }
    .tab-btn.active { color: #ffb300; border-bottom-color: #ffb300; }
    .tab-btn[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: -42px;
      left: 50%;
      transform: translateX(-50%);
      background: #232526;
      color: #ffb300;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1001;
      border: 1px solid #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .tab-btn .tab-icon {
      width: 56px;
      height: 56px;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 2px 8px #000a);
    }

    /* Tab Content */
    .tab-content { display: none; padding: 16px; max-width: 1400px; margin: 0 auto; background: rgba(30, 34, 40, 0.95); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.25); }
    .tab-content.active { display: block; }
    h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #ffb300; text-shadow: 0 2px 8px #000a; }
    h2 { font-size: 18px; font-weight: 500; margin-top: 24px; margin-bottom: 12px; color: #e0e0e0; }
    .loading { text-align: center; padding: 32px; color: #e0e0e0; }
    .note { font-size: 12px; color: #e0e0e0; margin-top: 4px; }

    /* Dashboard */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { background: #232526; border-radius: 8px; padding: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.25); text-align: center; border: 1px solid #444; }
    .card-value { font-size: 28px; font-weight: 700; color: #ffb300; margin-bottom: 4px; text-shadow: 0 2px 8px #000a; }
    .card-label { font-size: 12px; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.5px; }
    .player-list { background: #232526; border-radius: 8px; padding: 0; box-shadow: 0 1px 6px rgba(0,0,0,0.25); margin-bottom: 16px; overflow: auto; max-height: 70vh; border: 1px solid #444; }
    .chest-table { display: table; width: 100%; border-collapse: collapse; background: #232526; border-radius: 8px; overflow: hidden; }
    .table-header { display: table-row; background: #232526; border-bottom: 2px solid #444; }
    .header-cell { display: table-cell; padding: 12px 8px; font-weight: 600; font-size: 11px; color: #ffb300; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; border-right: 1px solid #444; white-space: nowrap; position: sticky; top: 0; background: #232526; z-index: 2; }
    .header-cell:first-child { text-align: center; position: sticky; left: 0; z-index: 3; min-width: 45px; max-width: 50px; width: 50px; background: #232526; }
    .header-cell:nth-child(2) { text-align: left; position: sticky; left: 50px; z-index: 3; min-width: 150px; background: #232526; }
    .header-cell.rank-col { min-width: 45px !important; max-width: 50px !important; width: 50px !important; padding: 12px 4px; text-align: center !important; }
    .cell.rank-col { min-width: 45px !important; max-width: 50px !important; width: 50px !important; padding: 12px 4px; text-align: center !important; }
    .type-total-header { cursor: pointer; user-select: none; background: #33343a; font-weight: 600; color: #ffb300; }
    .type-total-header:hover { background: #444; }
    .toggle-icon { display: inline-block; width: 16px; text-align: center; margin-right: 4px; transition: transform 0.15s; }
    .type-total-header.expanded .toggle-icon { transform: rotate(90deg); }
    .level-header { background: #33343a; display: none; color: #ffb300; }
    .level-header.visible { display: table-cell; }
    .player-row { display: table-row; border-bottom: 1px solid #444; background: #232526; }
    .player-row:hover { background: #33343a; }
    .cell { display: table-cell; padding: 12px 8px; border-right: 1px solid #444; text-align: center; font-size: 13px; vertical-align: middle; white-space: nowrap; color: #e0e0e0; background: #232526; }
    .cell:first-child { text-align: center; font-weight: 500; position: sticky; left: 0; background: #232526; z-index: 1; min-width: 45px; max-width: 50px; width: 50px; }
    .cell:nth-child(2) { text-align: left; font-weight: 500; position: sticky; left: 50px; background: #232526; z-index: 1; min-width: 150px; }
    .player-row:hover .cell:first-child, .player-row:hover .cell:nth-child(2) { background: #33343a; }
    .level-cell { background: #33343a; display: none; font-size: 12px; color: #ffb300; }
    .level-cell.visible { display: table-cell; }
    .count-zero { color: #444; }
    .player-red { color: #ff5252; font-weight: 500; }
    .player-orange { color: #ffb300; font-weight: 500; }
    .player-green { color: #8bc34a; font-weight: 600; }
    .date-filter {
      background: #232526;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      margin-bottom: 16px;
      border: 1px solid #444;
    }
    .date-filter-label { font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #ffb300; }
    .date-preset-btns { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .preset-btn {
      padding: 6px 12px;
      background: #232526;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #e0e0e0;
    }
    .preset-btn:hover { background: #333; color: #ffb300; border-color: #ffb300; }
    .preset-btn.active { background: #ffb300; color: #232526; border-color: #ffb300; }
    .date-range-display {
      margin-top: 12px;
      padding: 8px 12px;
      background: #33343a;
      border-radius: 4px;
      font-size: 13px;
      color: #ffb300;
      font-weight: 500;
      border: 1px solid #444;
    }
    
    /* READ-ONLY MODE STYLES */
    .read-only-mode input,
    .read-only-mode select,
    .read-only-mode textarea {
      pointer-events: none !important;
      background: #f5f5f5 !important;
      color: #666 !important;
      cursor: not-allowed !important;
      opacity: 0.7 !important;
      border-color: #ddd !important;
    }
  </style>
</head>
<body>
  <!-- Google Sign-In integration -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // --- Google Sign-In for edit access ---
    const BACKEND_VERIFY_URL = window.GAS_WEB_APP_URL;
    const AUTH_KEY = 'moo_portal_google_auth';
    const AUTH_EMAIL_KEY = 'moo_portal_google_email';

    function setReadOnlyMode(enabled) {
      if (enabled) {
        document.documentElement.classList.add('read-only-mode');
        if (document.body) document.body.classList.add('read-only-mode');
        console.log('[INFO] Portal loaded in READ-ONLY mode');
      } else {
        document.documentElement.classList.remove('read-only-mode');
        if (document.body) document.body.classList.remove('read-only-mode');
        console.log('[INFO] Portal loaded in EDITABLE mode');
      }
    }

    function updateSignedInBadge(email) {
      const badge = document.getElementById('signedInUserBadge');
      const logoutBtn = document.getElementById('logoutBtn');
      if (!badge) return;
      if (email) {
        badge.innerHTML = `<img src="cute_cow.png" alt="User" style="height:16px;width:16px;vertical-align:-3px;margin-right:6px;">${email}`;
        badge.style.display = 'inline-block';
        if (logoutBtn) logoutBtn.style.display = 'inline-block';
      } else {
        badge.textContent = '';
        badge.style.display = 'none';
        if (logoutBtn) logoutBtn.style.display = 'none';
      }
    }

    function handleLogout() {
      try { localStorage.removeItem(AUTH_KEY); } catch (e) {}
      try { localStorage.removeItem(AUTH_EMAIL_KEY); } catch (e) {}
      setReadOnlyMode(true);
      updateSignedInBadge(null);
      setTimeout(() => { window.location.reload(); }, 200);
    }

    function showGoogleLogin() {
      const loginDiv = document.createElement('div');
      loginDiv.id = 'login-overlay';
      loginDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
      loginDiv.innerHTML = `
        <div style="background:#232526;padding:32px 24px;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.5);display:flex;flex-direction:column;align-items:center;gap:16px;min-width:300px;border:1px solid #444;">
          <h2 style="margin-bottom:8px;color:#ffb300;">Sign in to Manage</h2>
          <p style="font-size:14px;color:#e0e0e0;text-align:center;margin:0 0 8px 0;">Use your Google account to access management features</p>
          <div id="g_id_onload"
            data-client_id="47674606892-0m90hd0cd01kijo69ssuqtn1j3igp32i.apps.googleusercontent.com"
            data-callback="onGoogleSignIn"
            data-auto_prompt="false"
            data-ux_mode="popup"
            ></div>
          <div id="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="signin" data-shape="rectangular" data-logo_alignment="left"></div>
          <div style="width:100%;height:1px;background:#444;margin:8px 0;"></div>
          <button id="guest-btn" style="width:100%;margin-top:8px;padding:12px 20px;border:1px solid #444;background:#232526;color:#ffb300;font-size:15px;font-weight:600;border-radius:6px;cursor:pointer;transition:all 0.2s;">Continue as Guest (Read-Only)</button>
          <div id="login-error" style="color:#ff5252;font-size:13px;display:none;"></div>
        </div>
      `;
      document.body.appendChild(loginDiv);
      // Add guest button logic
      setTimeout(() => {
        const guestBtn = document.getElementById('guest-btn');
        if (guestBtn) {
          guestBtn.onclick = function() {
            // Remove overlay and set read-only mode
            document.getElementById('login-overlay').remove();
            setReadOnlyMode(true);
            // Remove any previous auth
            try { localStorage.removeItem(AUTH_KEY); } catch (e) {}
            try { localStorage.removeItem(AUTH_EMAIL_KEY); } catch (e) {}
            updateSignedInBadge(null);
          };
        }
          // Initialize Google Sign-In library before rendering button
          if (window.google && google.accounts && google.accounts.id) {
            try {
              google.accounts.id.initialize({
                client_id: '47674606892-0m90hd0cd01kijo69ssuqtn1j3igp32i.apps.googleusercontent.com',
                callback: onGoogleSignIn,
                auto_select: false,
                ux_mode: 'popup'
              });
              google.accounts.id.renderButton(
                document.getElementById('g_id_signin'),
                { 
                  type: 'standard', 
                  size: 'large', 
                  theme: 'outline',
                  text: 'signin',
                  shape: 'rectangular',
                  logo_alignment: 'left'
                }
              );
            } catch (e) {
              console.error('Error rendering Google Sign-In button:', e);
            }
          }
      }, 100);
    }

    window.onGoogleSignIn = async function(response) {
      const idToken = response.credential;
      console.log('[DEBUG] Google Sign-In initiated with token');
      try {
        // Step 1: Verify token via Cloudflare Worker (handles Google API call without OAuth issues)
        const cfWorkerUrl = window.CLOUDFLARE_WORKER_URL || window.GAS_WEB_APP_URL;
        console.log('[DEBUG] Verifying token via: ' + cfWorkerUrl);
        
        let tokenRes = await fetch(cfWorkerUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });
        let tokenData = await tokenRes.json();
        console.log('[DEBUG] Token verification response:', JSON.stringify(tokenData, null, 2));
        
        if (!tokenData.success || !tokenData.token_verified) {
          throw new Error(tokenData.error || 'Token verification failed');
        }
        
        // Step 2: Send verified email to GAS backend for permission check
        const email = tokenData.email;
        console.log('[DEBUG] Token verified, checking permissions for: ' + email);
        
        const res = await fetch(BACKEND_VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();
        console.log('[DEBUG] Backend response:', JSON.stringify(data, null, 2));
        
        if (data.debug) {
          console.log('[DEBUG INFO]', data.debug);
        }
        
        if (data.success && data.allowed) {
          console.log('[SUCCESS] User authorized: ' + email);
          localStorage.setItem(AUTH_KEY, '1');
          localStorage.setItem(AUTH_EMAIL_KEY, email);
          updateSignedInBadge(email);
          document.getElementById('login-overlay').remove();
          setReadOnlyMode(false);
          setTimeout(() => { window.location.reload(); }, 200);
        } else {
          setReadOnlyMode(true);
          updateSignedInBadge(null);
          const errorMsg = data.error || 'Access denied: not an authorized user.';
          const debugInfo = data.debug ? `\n\nðŸ“‹ DEBUG INFO:\n${data.debug}` : '';
          const emailInfo = `\n\nYour email: ${email}`;
          const finalMsg = errorMsg + emailInfo + debugInfo;
          document.getElementById('login-error').textContent = finalMsg;
          document.getElementById('login-error').style.display = 'block';
          document.getElementById('login-error').style.whiteSpace = 'pre-wrap';
          document.getElementById('login-error').style.fontSize = '11px';
          document.getElementById('login-error').style.maxWidth = '400px';
          console.error('[LOGIN FAILED]', finalMsg);
        }
      } catch (err) {
        console.error('[VERIFICATION ERROR]', err);
        setReadOnlyMode(true);
        updateSignedInBadge(null);
        document.getElementById('login-error').textContent = 'Login failed: ' + err.message + '\n\nCheck browser console (F12) for details.';
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('login-error').style.whiteSpace = 'pre-wrap';
      }
    };

    // On load: default to guest (read-only) mode
    let isAuthed = false;
    try { isAuthed = localStorage.getItem(AUTH_KEY) === '1'; } catch (e) {}
    let authedEmail = null;
    try { authedEmail = localStorage.getItem(AUTH_EMAIL_KEY); } catch (e) {}
    if (!isAuthed) {
      setReadOnlyMode(true);
      // Show a 'Sign in to Manage' button in the nav bar
      window.addEventListener('DOMContentLoaded', function() {
        updateSignedInBadge(null);
        let nav = document.querySelector('.tab-nav-container');
        if (nav && !document.getElementById('signInManageBtn')) {
          const btn = document.createElement('button');
          btn.id = 'signInManageBtn';
          btn.textContent = 'ðŸ”‘ Sign in to Manage';
          btn.style = 'margin-left:16px;padding:8px 18px;background:#1a73e8;color:#fff;border:none;border-radius:5px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s;';
          btn.onclick = showGoogleLogin;
          nav.appendChild(btn);
        }
      });
    } else {
      setReadOnlyMode(false);
      window.addEventListener('DOMContentLoaded', function() {
        updateSignedInBadge(authedEmail);
      });
    }
  </script>
  
  <nav class="tab-nav">
    <div class="tab-nav-container">
      <div class="nav-brand" id="navBrand"><img src="moo-portal.png" alt="MOO"> MOO Portal</div>
      <div class="tab-buttons">
        <a href="dashboard.html" class="tab-btn active" title="Dashboard"><img src="chests.png" alt="Dashboard" class="tab-icon"></a>
        <a href="events.html" class="tab-btn" title="Events"><img src="events.png" alt="Events" class="tab-icon"></a>
        <a href="members.html" class="tab-btn" title="Members"><img src="members.png" alt="Members" class="tab-icon"></a>
        <a href="troops.html" class="tab-btn" title="Troops"><img src="troops.png" alt="Troops" class="tab-icon"></a>
        <a href="progress.html" class="tab-btn" title="Progress"><img src="progress.png" alt="Progress" class="tab-icon"></a>
        <a href="compensation.html" class="tab-btn" title="Compensation"><img src="compensation.png" alt="Compensation" class="tab-icon"></a>
        <a href="points.html" class="tab-btn" title="Points Reference"><img src="chest_points.png" alt="Points Reference" class="tab-icon"></a>
      </div>
      <div id="readOnlyBadge" style="display: none; padding: 8px 12px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">ðŸ”’ Read-Only Mode</div>
      <div id="signedInUserBadge" style="display: none; margin-left: auto; padding: 8px 12px; background: #1a1b1c; border-radius: 4px; font-size: 12px; color: #ffb300; border: 1px solid #444;"></div>
      <button id="logoutBtn" onclick="handleLogout()" style="display: none; margin-left: 8px; padding: 8px 10px; background: #c62828; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Log out</button>
    </div>
  </nav>

  <div id="dashboard" class="tab-content active">
    <h1><img src="chests.png" alt="" style="height: 64px; vertical-align: middle; margin-right: 8px;"> Chest Tracker Dashboard</h1>
    <div class="date-filter">
      <div class="date-filter-label">ðŸ“… Date Range Filter</div>
      <div class="date-preset-btns">
        <button class="preset-btn" data-preset="lastday" onclick="setDateRange('lastday')">Active Period (Sunâ€“Sat)</button>
        <button class="preset-btn" data-preset="prevweek" onclick="setDateRange('prevweek')">Previous Week (Sunâ€“Sat)</button>
        <button class="preset-btn" data-preset="currentmonth" onclick="setDateRange('currentmonth')">Current Month</button>
        <button class="preset-btn" data-preset="lastmonth" onclick="setDateRange('lastmonth')">Last Month</button>
      </div>
      <div class="date-range-display" id="dateRangeDisplay">Viewing: All Time</div>
      <div class="date-range-display" id="lastUpdatedDisplay" style="font-size: 12px; color: #5f6368; margin-top: 8px;">Last Date Available: Loading...</div>
      <input type="date" id="startDate" style="display:none;">
      <input type="date" id="endDate" style="display:none;">
    </div>

    <div class="summary-cards" id="summaryCards">
      <div class="card"><div class="card-value" id="totalChests">-</div><div class="card-label">Total Chests</div></div>
      <div class="card"><div class="card-value" id="totalMembers">-</div><div class="card-label">Clan Members</div></div>
      <div class="card"><div class="card-value" id="totalPlayers">-</div><div class="card-label">Active Players</div></div>
      <div class="card"><div class="card-value" id="totalPoints">-</div><div class="card-label">Total Points</div></div>
    </div>

    <h2>ðŸ¥‡ Player Rankings</h2>
    <div class="player-list" id="playerList"><div class="loading">Loading player stats...</div></div>
  </div>

  <script>
    const isSidebar = false;
    const expandedTypes = new Set();
    
    // Update UI based on read-only mode
    function updateReadOnlyUI() {
      if (document.documentElement.classList.contains('read-only-mode')) {
        const navBrand = document.getElementById('navBrand');
        if (navBrand) navBrand.innerHTML = '<img src="moo-portal.png" alt="MOO"> Masters Of Oops (MOO)';
        const badge = document.getElementById('readOnlyBadge');
        if (badge) badge.style.display = 'block';
      } else {
        const navBrand = document.getElementById('navBrand');
        if (navBrand) navBrand.innerHTML = '<img src="moo-portal.png" alt="MOO"> MOO Portal';
        const badge = document.getElementById('readOnlyBadge');
        if (badge) badge.style.display = 'none';
      }
    }
    window.addEventListener('DOMContentLoaded', updateReadOnlyUI);

    // ============ RESPONSE NORMALIZATION ============
    // Normalizes API responses to consistent format {success: bool, data: ?, error: ?}
    function normalizeResponse(result) {
      if (!result) return { success: false, error: 'No result' };
      if (result.success !== undefined) return result; // Already normalized
      if (Array.isArray(result)) return { success: true, data: result };
      if (result.error) return { success: false, error: result.error };
      if (result.message && !result.data) return { success: true, message: result.message };
      // Handle objects with data - preserve both data and specific keys
      if (typeof result === 'object') {
        return { success: true, data: result, ...result };
      }
      return { success: true, data: result }; // Default
    }

    // Dashboard
    window.onload = function() { setDateRange('lastday'); };
    
    function setDateRange(preset) {
      const today = new Date();
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      const displayElement = document.getElementById('dateRangeDisplay');
      
      // Format date as YYYY-MM-DD using LOCAL timezone (not UTC)
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      const formatDisplayDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-preset="${preset}"]`)?.classList.add('active');
      if (preset === 'lastday') {
        // Active Period: Sunday to Saturday (current week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        const end = new Date(start);
        // Saturday (6 days after start)
        end.setDate(start.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Active Period (Sunâ€“Sat): ${formatDisplayDate(start)} â€“ ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'prevweek') {
        // Previous Week: Sunday to Saturday (last week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        // Go back one full week
        start.setDate(start.getDate() - 7);
        const end = new Date(start);
        // Saturday (6 days after start)
        end.setDate(start.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Previous Week (Sunâ€“Sat): ${formatDisplayDate(start)} â€“ ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'currentmonth') {
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        // Get the last day of current month
        const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Current Month: ${formatDisplayDate(start)} â€“ ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'lastmonth') {
        const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const end = new Date(today.getFullYear(), today.getMonth(), 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Last Month: ${formatDisplayDate(start)} â€“ ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
    }
    
    function loadDashboard() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      document.getElementById('playerList').innerHTML = '<div class="loading">Loading...</div>';
      // Use CORS proxy (Cloudflare Worker) for API calls
      // 1. Get summary
      fetch(window.GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getStatsSummary', startDate, endDate })
      })
        .then(res => res.json())
        .then(displaySummary)
        .catch(e => console.error('Summary error:', e));

      // 2. Get player stats
      fetch(window.GAS_WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'getPlayerStats', startDate, endDate })
      })
        .then(res => res.json())
        .then(displayPlayerStats)
        .catch(e => {
          console.error('Stats error:', e);
          document.getElementById('playerList').innerHTML = '<div class="loading" style="color:#d93025;">Error loading player stats</div>';
        });
    }
    
    function displaySummary(data) {
      document.getElementById('totalChests').textContent = data.totalChests ? data.totalChests.toLocaleString() : '0';
      document.getElementById('totalMembers').textContent = data.totalMembers || '0';
      document.getElementById('totalPlayers').textContent = data.totalPlayers || '0';
      document.getElementById('totalPoints').textContent = data.totalPoints ? data.totalPoints.toLocaleString() : '0';
      if (data.lastAvailableDate) {
        const dateObj = new Date(data.lastAvailableDate + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('lastUpdatedDisplay').textContent = `Last Date Available: ${dateStr} â€¢ Weekly target: 10 000 points`;
      } else {
        document.getElementById('lastUpdatedDisplay').textContent = 'Last Date Available: No data available â€¢ Weekly target: 10 000 points';
      }
    }
    
    function displayPlayerStats(stats) {
      const container = document.getElementById('playerList');
      console.log('[DEBUG] displayPlayerStats received:', stats, 'type:', typeof stats, 'isArray:', Array.isArray(stats));
      
      // Normalize response format
      const norm = normalizeResponse(stats);
      let playerArray = norm.data || norm.playerStats || stats;
      
      // If it's an object with summary data (totalChests, totalMembers), ignore it - wrong handler
      if (playerArray && typeof playerArray === 'object' && !Array.isArray(playerArray) && ('totalChests' in playerArray || 'totalMembers' in playerArray)) {
        console.warn('[DEBUG] displayPlayerStats ignoring summary data (wrong handler called)');
        return;
      }
      
      // Ensure we have an array
      if (!Array.isArray(playerArray)) playerArray = [];
      
      if (playerArray.length === 0) { container.innerHTML = '<div class="loading">No data found</div>'; return; }
      const typeData = {};
      playerArray.forEach(player => {
        if (player.chestsByTypeGrouped) {
          Object.entries(player.chestsByTypeGrouped).forEach(([type,data]) => {
            if (!typeData[type]) typeData[type] = { levels:new Set(), total:0 };
            if (data.levels) Object.keys(data.levels).forEach(level => typeData[type].levels.add(level));
            typeData[type].total += data.total || 0;
          });
        }
      });
      const sortedTypes = Object.entries(typeData).sort((a,b)=>b[1].total-a[1].total).map(([name,data])=>({ name, levels: Array.from(data.levels).map(l=>parseInt(l)).sort((a,b)=>a-b) }));
      let headerHtml = '<div class="table-header">';
      headerHtml += '<div class="header-cell rank-col">Rank</div><div class="header-cell">Player</div><div class="header-cell">Pts</div><div class="header-cell">Total</div>';
      sortedTypes.forEach(type=>{ headerHtml += `<div class="header-cell type-total-header" onclick="toggleType('${type.name}')" data-type="${type.name}"><span class="toggle-icon">â–¶</span>${type.name}</div>`; type.levels.forEach(level=>{ headerHtml += `<div class="header-cell level-header" data-type="${type.name}" data-level="${level}">Lvl ${level}</div>`;}); });
      headerHtml += '</div>';
      let rowsHtml = '';
      playerArray.forEach((player,idx)=>{
        const commonCryptInfo = player.chestsByTypeGrouped?.['Common Crypt'];
        const totalPointsVal = player.totalPoints || 0;
        const pointsClass = totalPointsVal >= 10000 ? 'player-green' : (totalPointsVal >= 5000 ? 'player-orange' : 'player-red');
        rowsHtml += '<div class="player-row">';
        rowsHtml += `<div class="cell rank-col">${idx+1}</div><div class="cell ${pointsClass}">${player.player}</div><div class="cell">${totalPointsVal || '-'}</div>`;
        // Calculate total chests: use totalChests if available, otherwise sum from chestsByTypeGrouped (don't double-count eventChests!)
        let totalChests = player.totalChests || 0;
        if (totalChests === 0 && player.chestsByTypeGrouped) {
          Object.values(player.chestsByTypeGrouped).forEach(t=>{ totalChests += t.total || 0; });
        }
        rowsHtml += `<div class="cell">${totalChests||'-'}</div>`;
        sortedTypes.forEach(type=>{
          const typeInfo = player.chestsByTypeGrouped?.[type.name]; const totalCount = typeInfo?.total || 0;
          const totalClass = (type.name === 'Common Crypt' && ((commonCryptInfo?.levels?.['5']||0)>0 || (commonCryptInfo?.levels?.['10']||0)>0)) ? 'player-red' : '';
          rowsHtml += `<div class="cell" data-type="${type.name}"><span class="${totalCount===0?'count-zero':''} ${totalClass}">${totalCount||'-'}</span></div>`;
          type.levels.forEach(level=>{
            const levelCount = typeInfo?.levels?.[level] || 0;
            const badCrypt = (type.name === 'Common Crypt' && (level === 5 || level === 10) && levelCount > 0) ? 'player-red' : '';
            rowsHtml += `<div class="cell level-cell" data-type="${type.name}" data-level="${level}"><span class="${levelCount===0?'count-zero':''} ${badCrypt}">${levelCount||'-'}</span></div>`;
          });
        });
        rowsHtml += '</div>';
      });
      container.innerHTML = `<div class="chest-table">${headerHtml}${rowsHtml}</div>`;
    }
    
    function toggleType(typeName) {
      const header = document.querySelector(`.type-total-header[data-type="${typeName}"]`);
      const isExpanded = expandedTypes.has(typeName);
      if (isExpanded) { expandedTypes.delete(typeName); header.classList.remove('expanded'); } else { expandedTypes.add(typeName); header.classList.add('expanded'); }
      document.querySelectorAll(`[data-type="${typeName}"]`).forEach(el=>{ if (el.classList.contains('level-header')||el.classList.contains('level-cell')) el.classList.toggle('visible'); });
    }
  </script>
</body>
</html>

