<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOO Chest Tracker</title>
  <link rel="icon" href="moo-dashboard.png" type="image/png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 2px solid #e8eaed;
    }

    .tab-btn {
      padding: 12px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #5f6368;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      color: #1a73e8;
    }

    .tab-btn.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .points-reference-table {
      background: white;
      border-radius: 8px;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      overflow-x: auto;
      display: inline-block;
    }

    .points-table {
      width: auto;
      border-collapse: collapse;
    }

    .points-table thead {
      background: #f8f9fa;
      border-bottom: 2px solid #e8eaed;
    }

    .points-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 1;
    }

    .points-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e8eaed;
      font-size: 13px;
      color: #202124;
    }

    .points-table tbody tr:hover {
      background: #f8f9fa;
    }

    .points-table .type-cell {
      font-weight: 500;
      min-width: 140px;
    }

    .points-table .level-cell {
      min-width: 160px;
      display: table-cell !important;
      background: #fafbfc;
      font-size: 12px;
    }

    .points-table .points-cell {
      text-align: center;
      font-weight: 600;
      color: #1a73e8;
      width: 80px;
    }
    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      padding: 16px;
      background: #f8f9fa;
      color: #202124;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #1a73e8;
    }
    
    h2 {
      font-size: 18px;
      font-weight: 500;
      margin-top: 24px;
      margin-bottom: 12px;
      color: #5f6368;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      text-align: center;
    }
    
    .card-value {
      font-size: 28px;
      font-weight: 500;
      color: #1a73e8;
      margin-bottom: 4px;
    }
    
    .card-label {
      font-size: 12px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .player-list {
      background: white;
      border-radius: 8px;
      padding: 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      margin-bottom: 16px;
      overflow: auto;
      max-height: 70vh;
    }
    
    .chest-table {
      display: table;
      width: 100%;
      border-collapse: collapse;
    }
    
    .table-header {
      display: table-row;
      background: #f8f9fa;
      border-bottom: 2px solid #e8eaed;
    }
    
    .header-cell {
      display: table-cell;
      padding: 12px 8px;
      font-weight: 600;
      font-size: 11px;
      color: #5f6368;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-align: center;
      border-right: 1px solid #e8eaed;
      white-space: nowrap;
      position: sticky;
      top: 0;
      background: #f8f9fa;
      z-index: 2;
    }
    
    .header-cell:first-child {
      text-align: center;
      position: sticky;
      left: 0;
      z-index: 3;
      min-width: 45px;
      max-width: 50px;
      width: 50px;
      background: #f8f9fa;
    }
    
    .header-cell:nth-child(2) {
      text-align: left;
      position: sticky;
      left: 50px;
      z-index: 3;
      min-width: 70px;
      background: #f8f9fa;
    }
    
    .header-cell.rank-col {
      min-width: 45px;
      max-width: 50px;
      width: 50px;
      padding: 12px 4px;
      text-align: center !important;
    }
    
    .cell.rank-col {
      min-width: 45px;
      max-width: 50px;
      width: 50px;
      padding: 12px 4px;
      text-align: center !important;
    }
    
    .type-total-header {
      cursor: pointer;
      user-select: none;
      background: #e8eaed;
      font-weight: 600;
    }
    
    .type-total-header:hover {
      background: #dadce0;
    }
    
    .toggle-icon {
      display: inline-block;
      width: 16px;
      text-align: center;
      margin-right: 4px;
      transition: transform 0.15s;
    }
    
    .type-total-header.expanded .toggle-icon {
      transform: rotate(90deg);
    }
    
    .level-header {
      background: #f1f3f4;
      display: none;
    }
    
    .level-header.visible {
      display: table-cell;
    }
    
    .player-row {
      display: table-row;
      border-bottom: 1px solid #e8eaed;
    }
    
    .player-row:hover {
      background: #f8f9fa;
    }
    
    .cell {
      display: table-cell;
      padding: 12px 8px;
      border-right: 1px solid #e8eaed;
      text-align: center;
      font-size: 13px;
      vertical-align: middle;
      white-space: nowrap;
    }
    
    .cell:first-child {
      text-align: center;
      font-weight: 500;
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
      min-width: 45px;
      max-width: 50px;
      width: 50px;
    }
    
    .cell:nth-child(2) {
      text-align: left;
      font-weight: 500;
      position: sticky;
      left: 50px;
      background: white;
      z-index: 1;
      min-width: 70px;
    }
    
    .player-row:hover .cell:first-child,
    .player-row:hover .cell:nth-child(2) {
      background: #f8f9fa;
    }
    
    .level-cell {
      background: #fafbfc;
      display: none;
      font-size: 12px;
    }
    
    .level-cell.visible {
      display: table-cell;
    }
    
    .count-zero {
      color: #dadce0;
    }
    
    .player-red {
      color: #d93025;
      font-weight: 500;
    }

    .player-orange {
      color: #f57c00;
      font-weight: 500;
    }

    .player-green {
      color: #1b5e20;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 32px;
      color: #5f6368;
    }
    
    .date-filter {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
      margin-bottom: 16px;
    }
    
    .date-filter-label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #5f6368;
    }
    
    .date-preset-btns {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    
    .preset-btn {
      padding: 6px 12px;
      background: #f8f9fa;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .preset-btn:hover {
      background: #e8eaed;
    }
    
    .preset-btn.active {
      background: #1a73e8;
      color: white;
      border-color: #1a73e8;
    }
    
    .date-range-display {
      margin-top: 12px;
      padding: 8px 12px;
      background: #e8f0fe;
      border-radius: 4px;
      font-size: 13px;
      color: #1967d2;
      font-weight: 500;
    }

    
  </style>
</head>
<body>
  <h1>üèÜ Chest Tracker Dashboard</h1>
  
  <div class="date-filter">
    <div class="date-filter-label">üìÖ Date Range Filter</div>
    <div class="date-preset-btns">
      <button class="preset-btn" data-preset="lastday" onclick="setDateRange('lastday')">Active Period (Sun‚ÄìSat)</button>
      <button class="preset-btn" data-preset="prevweek" onclick="setDateRange('prevweek')">Previous Week (Sun‚ÄìSat)</button>
      <button class="preset-btn" data-preset="currentmonth" onclick="setDateRange('currentmonth')">Current Month</button>
      <button class="preset-btn" data-preset="lastmonth" onclick="setDateRange('lastmonth')">Last Month</button>
    </div>
    <div class="date-range-display" id="dateRangeDisplay">Viewing: All Time</div>
    <div class="date-range-display" id="lastUpdatedDisplay" style="font-size: 12px; color: #5f6368; margin-top: 8px;">Last Date Available: Loading...</div>
    <input type="date" id="startDate" style="display:none;">
    <input type="date" id="endDate" style="display:none;">
  </div>
  
  <div class="summary-cards" id="summaryCards">
    <div class="card">
      <div class="card-value" id="totalChests">-</div>
      <div class="card-label">Total Chests</div>
    </div>
    <div class="card">
      <div class="card-value" id="totalMembers">-</div>
      <div class="card-label">Clan Members</div>
    </div>
    <div class="card">
      <div class="card-value" id="totalPlayers">-</div>
      <div class="card-label">Active Players</div>
    </div>
    <div class="card">
      <div class="card-value" id="totalPoints">-</div>
      <div class="card-label">Total Points</div>
    </div>
  </div>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button class="tab-btn" onclick="switchTab('points')">üìã Points Reference</button>
  </div>

  <div id="dashboard-tab" class="tab-content active">
    <h2>ü•á Player Rankings</h2>
    <div class="player-list" id="playerList">
      <div class="loading">Loading player stats...</div>
    </div>
  </div>

  <div id="points-tab" class="tab-content">
    <div class="points-reference-table">
      <table class="points-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Crypt / Level</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="type-cell">Arena</td><td class="level-cell">Arena</td><td class="points-cell">1</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 5 Crypt</td><td class="points-cell">1</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 10 Crypt</td><td class="points-cell">5</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 15 Crypt</td><td class="points-cell">25</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 20 Crypt</td><td class="points-cell">80</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 25 Crypt</td><td class="points-cell">275</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 10 Rare Crypt</td><td class="points-cell">8</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 15 Rare Crypt</td><td class="points-cell">40</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 20 Rare Crypt</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 25 Rare Crypt</td><td class="points-cell">360</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 30 Rare Crypt</td><td class="points-cell">600</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 15 Epic Crypt</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 20 Epic Crypt</td><td class="points-cell">225</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 25 Epic Crypt</td><td class="points-cell">450</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 30 Epic Crypt</td><td class="points-cell">700</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 35 Epic Crypt</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 10</td><td class="points-cell">8</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 15</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 20</td><td class="points-cell">225</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 25</td><td class="points-cell">450</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 30</td><td class="points-cell">700</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 35</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 10</td><td class="points-cell">4</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 15</td><td class="points-cell">20</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 20</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 25</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 30</td><td class="points-cell">300</td></tr>
          <tr><td class="type-cell">Cursed Citadel</td><td class="level-cell">Level 20</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Cursed Citadel</td><td class="level-cell">Level 25</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 16‚Äì19</td><td class="points-cell">25</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 20‚Äì24</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 25‚Äì30</td><td class="points-cell">150</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 31‚Äì34</td><td class="points-cell">350</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 35‚Äì40</td><td class="points-cell">625</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 41‚Äì45</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Epic Squad</td><td class="level-cell">Any Epic Squad</td><td class="points-cell">500</td></tr>
          <tr><td class="type-cell">Hermes Store</td><td class="level-cell">Store</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Mercenary Exchange</td><td class="level-cell">Exchange</td><td class="points-cell">250</td></tr>
          <tr><td class="type-cell">Ragnarok Shop</td><td class="level-cell">Shop</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Wooden</td><td class="points-cell">5</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Conqueror's</td><td class="points-cell">10</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Bronze</td><td class="points-cell">35</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Silver</td><td class="points-cell">125</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Golden</td><td class="points-cell">375</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Precious</td><td class="points-cell">625</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Magic</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Tournament</td><td class="level-cell">Authority Rush</td><td class="points-cell">10</td></tr>
          <tr><td class="type-cell">Union of Triumph</td><td class="level-cell">Union Chest (Personal)</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Ancient / Runic / Event Chests</td><td class="level-cell">All listed</td><td class="points-cell">0</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script src="config.js"></script>
  <script src="portal-shim.js"></script>
  <script>
    const isSidebar = typeof google !== 'undefined' && google.script && google.script.run;
    const expandedTypes = new Set();

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      document.getElementById(`${tabName}-tab`).classList.add('active');
      event.target.classList.add('active');
    }
    
    window.onload = function() {
      if (isSidebar) {
        setDateRange('lastday');
      } else {
        setDateRange('lastday');
      }
    };
    
    function setDateRange(preset) {
      const today = new Date();
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      const displayElement = document.getElementById('dateRangeDisplay');

      // Format date as YYYY-MM-DD using LOCAL timezone (not UTC)
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      const formatDisplayDate = (date) => date.toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric'
      });

      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-preset="${preset}"]`)?.classList.add('active');

      if (preset === 'lastday') {
        // Active Period: Sunday to Saturday (current week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        const end = new Date(start);
        // Saturday (6 days after Sunday)
        end.setDate(end.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Active Period (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'prevweek') {
        // Previous Week: Sunday to Saturday (last week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        // Go back one full week
        start.setDate(start.getDate() - 7);
        const end = new Date(start);
        // Saturday (6 days after Sunday)
        end.setDate(end.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Previous Week (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      
      if (preset === 'currentmonth') {
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        // Get the last day of current month
        const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Current Month: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'lastmonth') {
        const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const end = new Date(today.getFullYear(), today.getMonth(), 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Last Month: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
    }
    
    function loadDashboard() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      google.script.run
        .withSuccessHandler(displaySummary)
        .withFailureHandler((e) => console.error('Summary error:', e))
        .getStatsSummary(startDate, endDate);

      document.getElementById('playerList').innerHTML = '<div class="loading">Loading...</div>';
      
      google.script.run
        .withSuccessHandler(displayPlayerStats)
        .withFailureHandler((e) => {
          console.error('Stats error:', e);
          document.getElementById('playerList').innerHTML = '<div class="loading" style="color: #d93025;">Error loading player stats</div>';
        })
        .getPlayerStats(null, null, startDate, endDate);
    }
    
    function normalizeResponse(result) {
      if (!result) return { success: false, data: null };
      if (result.success === false || result.error) return result;
      if (result.ok === true) return { success: true, data: result.data, ...result };
      if (result.success === true) return result;
      return { success: true, data: result, ...result };
    }

    function displaySummary(data) {
      const norm = normalizeResponse(data);
      let summaryData = norm.data || norm;
      
      document.getElementById('totalChests').textContent = summaryData.totalChests ? summaryData.totalChests.toLocaleString() : '0';
      document.getElementById('totalMembers').textContent = summaryData.totalMembers || '0';
      document.getElementById('totalPlayers').textContent = summaryData.totalPlayers || '0';
      document.getElementById('totalPoints').textContent = summaryData.totalPoints ? summaryData.totalPoints.toLocaleString() : '0';
      
      if (summaryData.lastAvailableDate) {
        const dateObj = new Date(summaryData.lastAvailableDate + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('lastUpdatedDisplay').textContent = `Last Date Available: ${dateStr} ‚Ä¢ Weekly target: 10 000 points`;
      } else {
        document.getElementById('lastUpdatedDisplay').textContent = 'Last Date Available: No data available ‚Ä¢ Weekly target: 10 000 points';
      }
    }
    
    function displayPlayerStats(stats) {
      const container = document.getElementById('playerList');
      console.log('[DEBUG] displayPlayerStats received:', stats, 'type:', typeof stats, 'isArray:', Array.isArray(stats));
      
      const norm = normalizeResponse(stats);
      let playerArray = norm.data || norm.playerStats || stats;
      
      if (playerArray && typeof playerArray === 'object' && !Array.isArray(playerArray) && ('totalChests' in playerArray || 'totalMembers' in playerArray)) {
        console.warn('[DEBUG] displayPlayerStats ignoring summary data (wrong handler called)');
        return;
      }
      
      if (!Array.isArray(playerArray)) playerArray = [];
      
      if (playerArray.length === 0) {
        container.innerHTML = '<div class="loading">No data found</div>';
        return;
      }
      
      // Collect all types and levels
      const typeData = {};
      playerArray.forEach(player => {
        if (player.chestsByTypeGrouped) {
          Object.entries(player.chestsByTypeGrouped).forEach(([type, data]) => {
            if (!typeData[type]) {
              typeData[type] = { levels: new Set(), total: 0 };
            }
            if (data.levels) {
              Object.keys(data.levels).forEach(level => typeData[type].levels.add(level));
            }
            typeData[type].total += data.total || 0;
          });
        }
      });
      
      // Sort types by total count
      const sortedTypes = Object.entries(typeData)
        .sort((a, b) => b[1].total - a[1].total)
        .map(([name, data]) => ({
          name,
          levels: Array.from(data.levels).map(l => parseInt(l)).sort((a, b) => a - b)
        }));
      
      // Build header row 1: type totals
      let headerHtml = '<div class="table-header">';
      headerHtml += '<div class="header-cell rank-col">Rank</div>';
      headerHtml += '<div class="header-cell">Player</div>';
      headerHtml += '<div class="header-cell">Pts</div>';
      headerHtml += '<div class="header-cell">Total</div>';
      
      sortedTypes.forEach(type => {
        headerHtml += `<div class="header-cell type-total-header" onclick="toggleType('${type.name}')" data-type="${type.name}">
          <span class="toggle-icon">‚ñ∂</span>${type.name}
        </div>`;
        
        // Add level headers (hidden by default)
        type.levels.forEach(level => {
          headerHtml += `<div class="header-cell level-header" data-type="${type.name}" data-level="${level}">Lvl ${level}</div>`;
        });
      });
      
      headerHtml += '</div>';
      
      // Build player rows
      let rowsHtml = '';
      playerArray.forEach((player, idx) => {
        const commonCryptInfo = player.chestsByTypeGrouped?.['Common Crypt'];
        const totalPointsVal = player.totalPoints || 0;
        const pointsClass = totalPointsVal >= 10000 ? 'player-green' : (totalPointsVal >= 5000 ? 'player-orange' : 'player-red');
        rowsHtml += '<div class="player-row">';
        rowsHtml += `<div class="cell rank-col">${idx + 1}</div>`;
        rowsHtml += `<div class="cell ${pointsClass}">${player.player}</div>`;
        rowsHtml += `<div class="cell">${totalPointsVal || '-'}</div>`;

        // Calculate total chests: use totalChests if available, otherwise sum from chestsByTypeGrouped (don't double-count eventChests!)
        let totalChests = player.totalChests || 0;
        if (totalChests === 0 && player.chestsByTypeGrouped) {
          Object.values(player.chestsByTypeGrouped).forEach(typeInfo => {
            totalChests += typeInfo.total || 0;
          });
        }
        rowsHtml += `<div class="cell">${totalChests || '-'}</div>`;

        sortedTypes.forEach(type => {
          const typeInfo = player.chestsByTypeGrouped?.[type.name];
          const totalCount = typeInfo?.total || 0;
          const totalClass = (type.name === 'Common Crypt' && ((commonCryptInfo?.levels?.['5'] || 0) > 0 || (commonCryptInfo?.levels?.['10'] || 0) > 0)) ? 'player-red' : '';
          rowsHtml += `<div class="cell" data-type="${type.name}">
            <span class="${totalCount === 0 ? 'count-zero' : ''} ${totalClass}">${totalCount || '-'}</span>
          </div>`;

          type.levels.forEach(level => {
            const levelCount = typeInfo?.levels?.[level] || 0;
            const badCrypt = (type.name === 'Common Crypt' && (level === 5 || level === 10) && levelCount > 0) ? 'player-red' : '';
            rowsHtml += `<div class="cell level-cell" data-type="${type.name}" data-level="${level}">
              <span class="${levelCount === 0 ? 'count-zero' : ''} ${badCrypt}">${levelCount || '-'}</span>
            </div>`;
          });
        });

        rowsHtml += '</div>';
      });
      
      container.innerHTML = `<div class="chest-table">${headerHtml}${rowsHtml}</div>`;
    }
    
    function toggleType(typeName) {
      // Toggle expanded state
      const header = document.querySelector(`.type-total-header[data-type="${typeName}"]`);
      const isExpanded = expandedTypes.has(typeName);
      
      if (isExpanded) {
        expandedTypes.delete(typeName);
        header.classList.remove('expanded');
      } else {
        expandedTypes.add(typeName);
        header.classList.add('expanded');
      }
      
      // Toggle visibility of level headers and cells for this type
      document.querySelectorAll(`[data-type="${typeName}"]`).forEach(el => {
        if (el.classList.contains('level-header') || el.classList.contains('level-cell')) {
          el.classList.toggle('visible');
        }
      });
    }
  </script>
</body>
</html>

