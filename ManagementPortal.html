<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MOO Portal</title>
  <link rel="icon" href="moo-portal.png" type="image/png">
  <script src="config.js"></script>
  <script src="portal-shim.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, #232526 0%, #414345 100%);
      color: #f3f3f3;
      text-align: center;
      padding: 32px 8px 60px 8px;
      min-height: 100vh;
      background-attachment: fixed;
    }

    /* Top Tabs */
    .tab-nav {
      background: rgba(30, 34, 40, 0.95);
      border-bottom: 1px solid #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      position: sticky; top: 0; z-index: 1000;
    }
    .tab-nav-container { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; padding: 0 16px; }
    .nav-brand { font-size: 20px; font-weight: 700; color: #ffb300; padding: 16px 0; margin-right: 32px; white-space: nowrap; display: flex; align-items: center; gap: 8px; text-shadow: 0 2px 8px #000a; }
    .nav-brand img { height: 32px; width: auto; }
    .tab-buttons {
      display: flex;
      gap: 4px;
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      align-items: center;
      height: 100px;
    }
    .tab-btn { padding: 12px 16px; background: none; border: none; color: #e0e0e0; font-size: 28px; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; cursor: pointer; position: relative; }
    .tab-btn:hover { color: #ffb300; background: #232526; }
    .tab-btn.active { color: #ffb300; border-bottom-color: #ffb300; }
    .tab-btn[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: -42px;
      left: 50%;
      transform: translateX(-50%);
      background: #232526;
      color: #ffb300;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1001;
      border: 1px solid #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .tab-btn .tab-icon {
      width: 52px;
      height: 52px;
      display: block;
      margin: 0 auto;
      filter: drop-shadow(0 2px 8px #000a);
    }

    /* Tab Content */
    .tab-content { display: none; padding: 16px; max-width: 1400px; margin: 0 auto; background: rgba(30, 34, 40, 0.95); border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.25); }
    .tab-content.active { display: block; }
    h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #ffb300; text-shadow: 0 2px 8px #000a; }
    h2 { font-size: 18px; font-weight: 500; margin-top: 24px; margin-bottom: 12px; color: #e0e0e0; }
    .loading { text-align: center; padding: 32px; color: #e0e0e0; }
    .note { font-size: 12px; color: #e0e0e0; margin-top: 4px; }

    /* Dashboard */
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { background: #232526; border-radius: 8px; padding: 16px; box-shadow: 0 1px 6px rgba(0,0,0,0.25); text-align: center; border: 1px solid #444; }
    .card-value { font-size: 28px; font-weight: 700; color: #ffb300; margin-bottom: 4px; text-shadow: 0 2px 8px #000a; }
    .card-label { font-size: 12px; color: #e0e0e0; text-transform: uppercase; letter-spacing: 0.5px; }
    .player-list { background: #232526; border-radius: 8px; padding: 0; box-shadow: 0 1px 6px rgba(0,0,0,0.25); margin-bottom: 16px; overflow: auto; max-height: 70vh; border: 1px solid #444; }
    .chest-table { display: table; width: 100%; border-collapse: collapse; background: #232526; border-radius: 8px; overflow: hidden; }
    .table-header { display: table-row; background: #232526; border-bottom: 2px solid #444; }
    .header-cell { display: table-cell; padding: 12px 8px; font-weight: 600; font-size: 11px; color: #ffb300; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; border-right: 1px solid #444; white-space: nowrap; position: sticky; top: 0; background: #232526; z-index: 2; }
    .header-cell:first-child { text-align: center; position: sticky; left: 0; z-index: 3; min-width: 45px; max-width: 50px; width: 50px; background: #232526; }
    .header-cell:nth-child(2) { text-align: left; position: sticky; left: 50px; z-index: 3; min-width: 150px; background: #232526; }
    .header-cell.rank-col { min-width: 45px !important; max-width: 50px !important; width: 50px !important; padding: 12px 4px; text-align: center !important; }
    .cell.rank-col { min-width: 45px !important; max-width: 50px !important; width: 50px !important; padding: 12px 4px; text-align: center !important; }
    .type-total-header { cursor: pointer; user-select: none; background: #33343a; font-weight: 600; color: #ffb300; }
    .type-total-header:hover { background: #444; }
    .toggle-icon { display: inline-block; width: 16px; text-align: center; margin-right: 4px; transition: transform 0.15s; }
    .type-total-header.expanded .toggle-icon { transform: rotate(90deg); }
    .level-header { background: #33343a; display: none; color: #ffb300; }
    .level-header.visible { display: table-cell; }
    .player-row { display: table-row; border-bottom: 1px solid #444; background: #232526; }
    .player-row:hover { background: #33343a; }
    .cell { display: table-cell; padding: 12px 8px; border-right: 1px solid #444; text-align: center; font-size: 13px; vertical-align: middle; white-space: nowrap; color: #e0e0e0; background: #232526; }
    .cell:first-child { text-align: center; font-weight: 500; position: sticky; left: 0; background: #232526; z-index: 1; min-width: 45px; max-width: 50px; width: 50px; }
    .cell:nth-child(2) { text-align: left; font-weight: 500; position: sticky; left: 50px; background: #232526; z-index: 1; min-width: 150px; }
    .player-row:hover .cell:first-child, .player-row:hover .cell:nth-child(2) { background: #33343a; }
    .level-cell { background: #33343a; display: none; font-size: 12px; color: #ffb300; }
    .level-cell.visible { display: table-cell; }
    .count-zero { color: #444; }
    .player-red { color: #ff5252; font-weight: 500; }
    .player-orange { color: #ffb300; font-weight: 500; }
    .player-green { color: #8bc34a; font-weight: 600; }
    .date-filter {
      background: #232526;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      margin-bottom: 16px;
      border: 1px solid #444;
    }
    .date-filter-label { font-size: 14px; font-weight: 500; margin-bottom: 8px; color: #ffb300; }
    .date-preset-btns { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .preset-btn {
      padding: 6px 12px;
      background: #232526;
      border: 1px solid #444;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      color: #e0e0e0;
    }
    .preset-btn:hover { background: #333; color: #ffb300; border-color: #ffb300; }
    .preset-btn.active { background: #ffb300; color: #232526; border-color: #ffb300; }
    .date-range-display {
      margin-top: 12px;
      padding: 8px 12px;
      background: #33343a;
      border-radius: 4px;
      font-size: 13px;
      color: #ffb300;
      font-weight: 500;
      border: 1px solid #444;
    }

    /* Events Tab */
    #events .header, #members .header, #progress .header, #troops .header { background: white; color: #202124; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; }
    #events .header h1, #members .header h1, #progress .header h1, #troops .header h1 { margin: 0 0 4px 0; font-weight: 600; color: #1a73e8; }
    #events .header p, #members .header p, #progress .header p, #troops .header p { font-size: 13px; color: #5f6368; }
    #events .tabs-container, #members .tabs-container, #troops .tabs-container { background: white; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; overflow: hidden; }
    #events .tabs, #members .tabs, #troops .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #e8eaed; }
    #events .tab, #members .tab, #troops .tab { flex: 1; padding: 12px 20px; text-align: center; cursor: pointer; border: none; background: none; font-size: 14px; font-weight: 600; color: #5f6368; transition: all 0.2s; border-bottom: 3px solid transparent; }
    #events .tab:hover, #members .tab:hover, #troops .tab:hover { background: #fff; color: #1a73e8; }
    #events .tab.active, #members .tab.active, #troops .tab.active { background: white; color: #1a73e8; border-bottom-color: #1a73e8; }
    #events .tab-content, #members .tab-content, #troops .tab-content { display: none; padding: 16px; }
    #events .tab-content.active, #members .tab-content.active, #troops .tab-content.active { display: block; }
    #events .form-grid, #members .form-grid, #troops .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px; }
    #events label, #members label, #troops label { display: block; font-size: 12px; font-weight: 600; color: #5f6368; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
    #events select, #events input[type="date"], #events input[type="number"], #events input[type="text"],
    #members select, #members input[type="date"], #members input[type="number"], #members input[type="text"],
    #troops select, #troops input[type="date"], #troops input[type="number"], #troops input[type="text"], #troops textarea {
      width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; background: #fff;
    }
    #events select:focus, #events input:focus,
    #members select:focus, #members input:focus,
    #troops select:focus, #troops input:focus, #troops textarea:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }
    #events .btn, #members .btn, #progress .btn, #troops .btn { padding: 10px 16px; border: 1px solid #1a73e8; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #1a73e8; color: white; }
    #events .btn:hover, #members .btn:hover, #progress .btn:hover, #troops .btn:hover { background: #1765c1; box-shadow: 0 1px 4px rgba(26,115,232,0.4); }
    #events .btn-secondary, #troops .btn-secondary { background: #5f6368; border-color: #5f6368; }
    #events .btn-secondary:hover, #troops .btn-secondary:hover { background: #3c4043; }
    #events .status, #members .status, #troops .status { font-size: 13px; margin-top: 8px; }
    #events .status.ok, #members .status.ok, #troops .status.ok { color: #1b5e20; }
    #events .status.err, #members .status.err, #troops .status.err { color: #c62828; }
    #events .table-container, #members .table-container, #progress .table-container, #troops .table-container { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: auto; margin-top: 16px; max-height: 70vh; }
    #events .table-container::-webkit-scrollbar, #members .table-container::-webkit-scrollbar, #progress .table-container::-webkit-scrollbar, #troops .table-container::-webkit-scrollbar { width: 12px; height: 12px; }
    #events .table-container::-webkit-scrollbar-track, #members .table-container::-webkit-scrollbar-track, #progress .table-container::-webkit-scrollbar-track, #troops .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 6px; }
    #events .table-container::-webkit-scrollbar-thumb, #members .table-container::-webkit-scrollbar-thumb, #progress .table-container::-webkit-scrollbar-thumb, #troops .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; }
    #events .table-container::-webkit-scrollbar-thumb:hover, #members .table-container::-webkit-scrollbar-thumb:hover, #progress .table-container::-webkit-scrollbar-thumb:hover, #troops .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
    #events table, #members table, #progress table, #troops table { width: 100%; border-collapse: collapse; }
    #troops #troopMembersTable { table-layout: fixed; }
    #events thead, #members thead, #progress thead, #troops thead { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; }
    #events th, #members th, #progress th, #troops th { padding: 15px; text-align: left; font-size: 12px; font-weight: 600; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e1e8ed; }
    #events th.rank-col, #members th.rank-col, #progress th.rank-col { width: 50px; max-width: 50px; min-width: 45px; padding: 15px 4px; text-align: center !important; }
    #events td, #members td, #progress td, #troops td { padding: 15px; font-size: 14px; }
    #events td.rank-col, #members td.rank-col, #progress td.rank-col { width: 50px; max-width: 50px; min-width: 45px; padding: 15px 4px; text-align: center !important; }
    #events tbody tr, #members tbody tr, #progress tbody tr, #troops tbody tr { border-bottom: 1px solid #e1e8ed; transition: background-color 0.2s; }
    #events tbody tr:hover, #members tbody tr:hover, #progress tbody tr:hover, #troops tbody tr:hover { background-color: #f8f9ff; }
    #events th:first-child, #members th:first-child, #progress th:first-child, #troops th:first-child {
      position: sticky;
      left: 0;
      background: #f8f9fa;
      z-index: 11;
    }
    #events td:first-child, #members td:first-child, #progress td:first-child, #troops td:first-child {
      position: sticky;
      left: 0;
      background: white;
      z-index: 10;
    }
    #events tbody tr:hover td:first-child, #members tbody tr:hover td:first-child, #progress tbody tr:hover td:first-child, #troops tbody tr:hover td:first-child {
      background-color: #f8f9ff;
    }
    #troopSummarySection .table-container { max-height: 70vh; overflow-y: auto; overflow-x: auto; }
    #troopSummarySection .table-container::-webkit-scrollbar { width: 12px; height: 12px; }
    #troopSummarySection .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 6px; }
    #troopSummarySection .table-container::-webkit-scrollbar-thumb { background: #888; border-radius: 6px; }
    #troopSummarySection .table-container::-webkit-scrollbar-thumb:hover { background: #555; }
    #troops #troopMembersTable { min-width: 780px; }
    #troops #troopMembersTable th:first-child, #troops #troopMembersTable td:first-child { width: 150px; min-width: 150px; max-width: 150px; }
    #troops #troopMembersTable th:not(:first-child), #troops #troopMembersTable td:not(:first-child) { width: 63px; min-width: 63px; }
    #troops th.center, #troops td.center { text-align: center; }
    #troops #troopMembersTable thead th { position: sticky; top: 0; z-index: 10; background: #f8f9fa; }
    #troops #troopMembersTable thead th:first-child { position: sticky; left: 0; top: 0; z-index: 12; background: #f8f9fa; }
    #troops #troopMembersTable tbody td:first-child { position: sticky; left: 0; z-index: 10; background: white; }
    #events .badge.chest { background: #d4edda; color: #155724; }
    #events .badge.manual { background: #cce5ff; color: #004085; }
    #events .action-btn { padding: 6px 12px; font-size: 12px; margin-right: 4px; }
    #events .checkbox-item { padding: 6px 0; display: flex; align-items: center; gap: 8px; }
    #events .checkbox-item label { margin: 0; text-transform: none; font-weight: normal; font-size: 14px; color: #202124; cursor: pointer; }
    #events .sortable, #troops .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
    #events .sortable::after, #troops .sortable::after { content: '‚áÖ'; position: absolute; right: 5px; opacity: 0.3; font-size: 10px; }
    #events .sortable.asc::after, #troops .sortable.asc::after { content: '‚ñ≤'; opacity: 1; }
    #events .sortable.desc::after, #troops .sortable.desc::after { content: '‚ñº'; opacity: 1; }
    #events .filter-row { background: #f8f9fa; }
    #events .filter-select { width: 100%; padding: 6px 8px; border: 1px solid #dadce0; border-radius: 4px; font-size: 12px; background: white; }
    #events .filter-select:focus { outline: none; border-color: #1a73e8; }
    #members .stat-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; text-align: left; }
    #members .stat-card h3 { font-size: 11px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
    #members .stat-card .value { font-size: 26px; font-weight: 600; color: #1a73e8; }
    #members .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px; }
    #members .controls, #progress .controls { background: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    #members .search-box, #progress .search-box { flex: 1; min-width: 250px; }
    #members .search-box input, #progress .search-box input { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; background: #fff; }
    #members .search-box input:focus, #progress .search-box input:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }
    #members .loading .spinner, #events .loading .spinner, #progress .loading .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #1a73e8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #members th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
    #members th.sortable::after { content: '‚áÖ'; position: absolute; right: 5px; opacity: 0.3; font-size: 10px; }
    #members th.sortable.sorted-asc::after { content: '‚ñ≤'; opacity: 1; color: #1a73e8; }
    #members th.sortable.sorted-desc::after { content: '‚ñº'; opacity: 1; color: #1a73e8; }
    .summary-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; }
    .summary-card h3 { margin: 0 0 6px 0; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368; font-weight: 600; }
    .summary-card .value { font-size: 24px; font-weight: 700; color: #1a73e8; }
    .summary-card .subtitle { font-size: 12px; color: #5f6368; }
    #progress .summary-cards { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px; }
    #progress .highlight-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px; }
    #progress .highlight-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    #progress .highlight-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    #progress .highlight-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    #progress .highlight-card h3 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; opacity: 0.9; font-weight: 600; }
    #progress .highlight-card .member-name { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    #progress .highlight-card .stats { font-size: 14px; opacity: 0.95; }
    #progress th { cursor: pointer; user-select: none; }
    #progress th::after { content: ' ‚áÖ'; opacity: 0.3; }
    #progress th.sorted-asc::after { content: ' ‚Üë'; opacity: 1; color: #1a73e8; }
    #progress th.sorted-desc::after { content: ' ‚Üì'; opacity: 1; color: #1a73e8; }
    #progress .member-name { font-weight: 600; color: #2c3e50; }
    #progress .stat-cell { text-align: center; font-family: 'Courier New', monospace; color: #27ae60; }
    #progress .event-cell { text-align: center; font-size: 18px; font-weight: 600; }
    #progress .checkmark { color: #27ae60; }
    #progress .cross { color: #c33; }
    #progress .warning { color: #ff9800; }
    #progress .points-cell { color: #1a73e8; font-weight: 600; }
    
    /* Compensation Tab */
    #compensation h2 { font-size: 14px; font-weight: 600; color: #5f6368; text-transform: uppercase; letter-spacing: 0.4px; margin-top: 20px; margin-bottom: 12px; }
    #compensation .form-grid { display: grid; gap: 12px; margin-bottom: 12px; }
    #compensation label { display: block; font-size: 12px; font-weight: 600; color: #5f6368; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
    #compensation input[type="text"],
    #compensation input[type="number"],
    #compensation select {
      width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; background: #fff;
    }
    #compensation input:focus,
    #compensation select:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }
    #compensation .btn { padding: 10px 16px; border: 1px solid #1a73e8; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #1a73e8; color: white; }
    #compensation .btn:hover { background: #1765c1; box-shadow: 0 1px 4px rgba(26,115,232,0.4); }
    #compensation .btn-secondary { background: #5f6368; border-color: #5f6368; }
    #compensation .btn-secondary:hover { background: #3c4043; }
    #compensation .status { font-size: 13px; }
    #compensation .status.ok { color: #1b5e20; }
    #compensation .status.err { color: #c62828; }
    
    /* Points Reference Tab */
    #points .points-reference-table { background: white; border-radius: 8px; padding: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.12); overflow-x: auto; display: inline-block; }
    #points .points-table { width: auto; border-collapse: collapse; }
    #points .points-table thead { background: #f8f9fa; border-bottom: 2px solid #e8eaed; }
    #points .points-table th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
    #points .points-table td { padding: 12px 16px; border-bottom: 1px solid #e8eaed; font-size: 13px; color: #202124; }
    #points .points-table tbody tr:hover { background: #f8f9fa; }
    #points .type-cell { font-weight: 500; min-width: 140px; }
    #points .level-cell { min-width: 160px; display: table-cell !important; }
    #points .points-cell { text-align: center; font-weight: 600; color: #1a73e8; width: 80px; }

    /* Troops Tab */
    #troops .form-group { margin-bottom: 16px; }
    #troops textarea { width: 100%; padding: 10px 12px; border: 1px solid #dadce0; border-radius: 6px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit; resize: vertical; }
    #troops textarea:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }
    #troops .history-table { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e8eaed; margin-top: 12px; }
    #troops .table-header { display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; background: #f8f9fa; border-bottom: 2px solid #e8eaed; padding: 12px 16px; font-weight: 600; font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; }
    #troops .table-row { display: grid; grid-template-columns: 2fr 1fr 1fr 2fr; padding: 12px 16px; border-bottom: 1px solid #e8eaed; font-size: 13px; }
    #troops .table-row:hover { background: #f8f9fa; }
    #troops .table-cell.timestamp { color: #5f6368; font-size: 12px; }
    #troops .table-cell.level { font-weight: 600; color: #1a73e8; }
    #troops .summary-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    #troops .summary-card { background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid #e8eaed; }
    #troops .summary-card-player { font-weight: 600; font-size: 14px; margin-bottom: 12px; color: #202124; border-bottom: 2px solid #1a73e8; padding-bottom: 8px; }
    #troops .summary-card-level { font-size: 20px; font-weight: 600; display: inline-block; width: 50px; text-align: center; }
    #troops .summary-card-label { font-size: 11px; color: #5f6368; display: inline-block; width: 50px; text-align: center; margin-right: 8px; }
    #troops .summary-card-crypt { margin-top: 12px; padding-top: 12px; border-top: 1px solid #e8eaed; background: #fff3e0; padding: 8px; border-radius: 4px; font-size: 13px; font-weight: 500; color: #e65100; text-align: center; }
    #troops .no-data { padding: 32px 16px; text-align: center; color: #5f6368; font-size: 14px; }
    
    /* READ-ONLY MODE STYLES */
    .read-only-mode input,
    .read-only-mode select,
    .read-only-mode textarea {
      pointer-events: none !important;
      background: #f5f5f5 !important;
      color: #666 !important;
      cursor: not-allowed !important;
      opacity: 0.7 !important;
      border-color: #ddd !important;
    }
    
    /* Hide only the CREATE/EDIT/DELETE tabs, not the viewing tabs */
    .read-only-mode #events #createTab {
      display: none !important;
    }
    
    /* Hide action buttons for editing/deleting/calculating in read-only mode */
    .read-only-mode .action-btn[data-action="edit"],
    .read-only-mode .action-btn[data-action="delete"],
    .read-only-mode .action-btn[data-action="calc"],
    .read-only-mode .action-btn[data-action="edit-type"],
    .read-only-mode .action-btn[data-action="delete-type"] {
      display: none !important;
    }
    
    /* Hide create/save buttons in forms in read-only mode */
    .read-only-mode #events .btn[onclick*="addEvent"],
    .read-only-mode #events .btn[onclick*="addEventType"],
    .read-only-mode #events .btn[onclick*="addManualEvent"],
    .read-only-mode #events #manualEventsTab button,
    .read-only-mode #members .btn[onclick*="addMember"],
    .read-only-mode #members .btn[onclick*="updateMember"],
    .read-only-mode #compensation .btn {
      display: none !important;
    }
    
    /* Keep view/load buttons visible */
    .read-only-mode #events .btn[onclick*="loadEvents"],
    .read-only-mode #members .btn[onclick*="loadMembers"] {
      display: inline-block !important;
      pointer-events: auto !important;
      opacity: 1 !important;
      background: #1a73e8 !important;
      cursor: pointer !important;
    }
  </style>
</head>
<body>
  <!-- Google Sign-In integration -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // --- Google Sign-In for edit access ---
    const BACKEND_VERIFY_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec?action=verifyGoogleLogin'; // TODO: Replace with your deployed Apps Script URL
    const AUTH_KEY = 'moo_portal_google_auth';

    function setReadOnlyMode(enabled) {
      if (enabled) {
        document.documentElement.classList.add('read-only-mode');
        if (document.body) document.body.classList.add('read-only-mode');
        console.log('[INFO] Portal loaded in READ-ONLY mode');
      } else {
        document.documentElement.classList.remove('read-only-mode');
        if (document.body) document.body.classList.remove('read-only-mode');
        console.log('[INFO] Portal loaded in EDITABLE mode');
      }
    }

    function showGoogleLogin() {
      const loginDiv = document.createElement('div');
      loginDiv.id = 'login-overlay';
      loginDiv.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;';
      loginDiv.innerHTML = `
        <div style="background:white;padding:32px 24px;border-radius:12px;box-shadow:0 4px 24px #0002;display:flex;flex-direction:column;align-items:center;gap:16px;min-width:300px;">
          <h2 style=\"margin-bottom:8px;color:#1a73e8;\">Sign in to Edit</h2>
          <div id=\"g_id_onload\"
            data-client_id=\"47674606892-0m90hd0cd01kijo69ssuqtn1j3igp32i.apps.googleusercontent.com\"
            data-callback=\"onGoogleSignIn\"
            data-auto_prompt=\"false\"
            data-ux_mode=\"popup\"
            ></div>
          <div class=\"g_id_signin\" data-type=\"standard\" data-size=\"large\" data-theme=\"outline\" data-text=\"sign_in_with\" data-shape=\"rectangular\" data-logo_alignment=\"left\"></div>
          <button id=\"guest-btn\" style=\"margin-top:8px;padding:8px 20px;border:none;background:#f1f3f4;color:#1a73e8;font-size:15px;font-weight:600;border-radius:6px;cursor:pointer;transition:background 0.2s;\">Continue as Guest</button>
          <div id=\"login-error\" style=\"color:#d93025;font-size:13px;display:none;\"></div>
        </div>
      `;
      document.body.appendChild(loginDiv);
      // Add guest button logic
      setTimeout(() => {
        const guestBtn = document.getElementById('guest-btn');
        if (guestBtn) {
          guestBtn.onclick = function() {
            // Remove overlay and set read-only mode
            document.getElementById('login-overlay').remove();
            setReadOnlyMode(true);
            // Remove any previous auth
            try { localStorage.removeItem(AUTH_KEY); } catch (e) {}
          };
        }
      }, 0);
    }

    window.onGoogleSignIn = async function(response) {
      const idToken = response.credential;
      try {
        const res = await fetch(BACKEND_VERIFY_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idToken })
        });
        const data = await res.json();
        if (data.success && data.allowed) {
          localStorage.setItem(AUTH_KEY, '1');
          document.getElementById('login-overlay').remove();
          setReadOnlyMode(false);
        } else {
          setReadOnlyMode(true);
          document.getElementById('login-error').textContent = data.error || 'Access denied: not an authorized user.';
          document.getElementById('login-error').style.display = 'block';
        }
      } catch (err) {
        setReadOnlyMode(true);
        document.getElementById('login-error').textContent = 'Login failed. Please try again.';
        document.getElementById('login-error').style.display = 'block';
      }
    };

    // On load: default to guest (read-only) mode
    let isAuthed = false;
    try { isAuthed = localStorage.getItem(AUTH_KEY) === '1'; } catch (e) {}
    if (!isAuthed) {
      setReadOnlyMode(true);
      // Show a 'Sign in to Manage' button in the nav bar
      window.addEventListener('DOMContentLoaded', function() {
        let nav = document.querySelector('.tab-nav-container');
        if (nav && !document.getElementById('signInManageBtn')) {
          const btn = document.createElement('button');
          btn.id = 'signInManageBtn';
          btn.textContent = 'üîë Sign in to Manage';
          btn.style = 'margin-left:16px;padding:8px 18px;background:#1a73e8;color:#fff;border:none;border-radius:5px;font-size:14px;font-weight:600;cursor:pointer;transition:background 0.2s;';
          btn.onclick = showGoogleLogin;
          nav.appendChild(btn);
        }
      });
    } else {
      setReadOnlyMode(false);
    }
  </script>
  
  <nav class="tab-nav">
    <div class="tab-nav-container">
      <div class="nav-brand" id="navBrand"><img src="moo-portal.png" alt="MOO"> MOO Portal</div>
      <div class="tab-buttons">
        <button class="tab-btn active" onclick="switchTab('dashboard')" title="Dashboard"><img src="chests.png" alt="Dashboard" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('events')" title="Events"><img src="events.png" alt="Events" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('members')" title="Members"><img src="members.png" alt="Members" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('troops')" title="Troops"><img src="troops.png" alt="Troops" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('progress')" title="Progress"><img src="progress.png" alt="Progress" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('compensation')" title="Compensation"><img src="compensation.png" alt="Compensation" class="tab-icon"></button>
        <button class="tab-btn" onclick="switchTab('points')" title="Points Reference"><img src="chest_points.png" alt="Points Reference" class="tab-icon"></button>
      </div>
      <div id="readOnlyBadge" style="display: none; margin-left: auto; padding: 8px 12px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">üîí Read-Only Mode</div>
    </div>
  </nav>

  <div id="dashboard" class="tab-content active">
    <h1><img src="moo-dashboard.png" alt="" style="height: 32px; vertical-align: middle; margin-right: 8px;"> Chest Tracker Dashboard</h1>
    <div class="date-filter">
      <div class="date-filter-label">üìÖ Date Range Filter</div>
      <div class="date-preset-btns">
        <button class="preset-btn" data-preset="lastday" onclick="setDateRange('lastday')">Active Period (Sun‚ÄìSat)</button>
        <button class="preset-btn" data-preset="prevweek" onclick="setDateRange('prevweek')">Previous Week (Sun‚ÄìSat)</button>
        <button class="preset-btn" data-preset="currentmonth" onclick="setDateRange('currentmonth')">Current Month</button>
        <button class="preset-btn" data-preset="lastmonth" onclick="setDateRange('lastmonth')">Last Month</button>
      </div>
      <div class="date-range-display" id="dateRangeDisplay">Viewing: All Time</div>
      <div class="date-range-display" id="lastUpdatedDisplay" style="font-size: 12px; color: #5f6368; margin-top: 8px;">Last Date Available: Loading...</div>
      <input type="date" id="startDate" style="display:none;">
      <input type="date" id="endDate" style="display:none;">
    </div>

    <div class="summary-cards" id="summaryCards">
      <div class="card"><div class="card-value" id="totalChests">-</div><div class="card-label">Total Chests</div></div>
      <div class="card"><div class="card-value" id="totalMembers">-</div><div class="card-label">Clan Members</div></div>
      <div class="card"><div class="card-value" id="totalPlayers">-</div><div class="card-label">Active Players</div></div>
      <div class="card"><div class="card-value" id="totalPoints">-</div><div class="card-label">Total Points</div></div>
    </div>

    <h2>ü•á Player Rankings</h2>
    <div class="player-list" id="playerList"><div class="loading">Loading player stats...</div></div>
  </div>

  <div id="events" class="tab-content">
    <div class="header"><h1>üéØ Event Management</h1><p>Track clan events and member participation</p></div>
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" onclick="EventsTab.switchTab('manageTab', event)">üìã Manage Events</button>
        <button class="tab" onclick="EventsTab.switchTab('chestEventsTab', event)">üìä Chest Events</button>
        <button class="tab" onclick="EventsTab.switchTab('manualEventsTab', event)">‚úèÔ∏è Manual Events</button>
        <button class="tab" onclick="EventsTab.switchTab('createTab', event)">‚ûï Create Event</button>
        <button class="tab" onclick="EventsTab.switchTab('eventTypesTab', event)">‚öôÔ∏è Event Types</button>
      </div>
      <div id="manageTab" class="tab-content active">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">All Events</h3>
        <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
          <button class="btn" onclick="EventsTab.loadEvents()">üîÑ Refresh</button>
        </div>
        <div class="table-container">
          <div id="eventsLoading" class="loading"><div class="spinner"></div><p>Loading events...</p></div>
          <table id="eventsTable" style="display:none;">
            <thead><tr><th class="sortable" data-sort="eventName">Event Name</th><th class="sortable" data-sort="eventType">Event Type</th><th class="sortable" data-sort="startDate">Start Date</th><th class="sortable" data-sort="endDate">End Date</th><th>Tracking Method</th><th>Actions</th></tr></thead>
            <tbody id="eventsTableBody"></tbody>
          </table>
          <div id="eventsEmpty" style="display:none; text-align:center; padding:40px; color:#7f8c8d;"><p>No events found. Create your first event!</p></div>
        </div>
      </div>
      <div id="chestEventsTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Chest-Based Events</h3>
        <p style="margin-bottom:12px; color:#5f6368;">View and calculate participation for chest-based events. Participation is automatically calculated from chest data during the event period (including 1 day after).</p>
        <div style="margin-bottom:12px;"><label for="chestEventSelect">Select Event</label><select id="chestEventSelect" onchange="EventsTab.onChestEventSelected()" style="max-width:400px;"><option value="">-- Select Chest Event --</option></select></div>
        <div id="chestEventActions" style="display:none; margin-bottom:12px;">
          <button class="btn" onclick="EventsTab.calculateChestParticipation()">üîÑ Calculate Participation</button>
          <div id="chestCalcStatus" class="status"></div>
        </div>
        <div id="chestParticipationData" style="display:none; margin-top:12px;">
          <h4 id="chestParticipationHeading" style="margin:0 0 12px 0;">Participation Results</h4>
          <div id="chestLoadingIndicator" class="loading">Loading participation data...</div>
          <div class="table-container"><table><thead id="chestParticipationTableHead"></thead><tbody id="chestParticipationTableBody"></tbody></table></div>
        </div>
      </div>
      <div id="manualEventsTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Manual Events</h3>
        <p style="margin-bottom:12px; color:#5f6368;">Manually track participation for events that don't use chest data.</p>
        <div class="form-grid" style="margin-bottom:12px;">
          <div><label for="manualEventSelect">Event</label><select id="manualEventSelect" onchange="EventsTab.onManualEventSelected()"><option value="">-- Select Event --</option></select></div>
          <div><label for="manualMember">Member</label><select id="manualMember"><option value="">-- Select Member --</option></select></div>
          <div><label for="manualPoints">Points</label><input type="number" id="manualPoints" placeholder="Enter points" onkeypress="if(event.key==='Enter'){EventsTab.submitManualEntry();}"></div>
        </div>
        <div style="margin-bottom:12px;"><button class="btn" onclick="EventsTab.submitManualEntry()">üíæ Save Entry</button><button class="btn btn-secondary" onclick="EventsTab.calculateManualNonParticipants()">üôÖ‚Äç‚ôÇÔ∏è Fill Non-Participants</button><div id="manualEntryStatus" class="status"></div><div id="manualNonPartStatus" class="status"></div></div>
        <div id="manualParticipationData" style="display:none; margin-top:12px;"><h4 id="manualParticipationHeading" style="margin:0 0 12px 0;">Participation Entries</h4><div id="manualLoadingIndicator" class="loading">Loading participation data...</div><div class="table-container"><table><thead id="manualParticipationTableHead"></thead><tbody id="manualParticipationTableBody"></tbody></table></div></div>
      </div>
      <div id="createTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Create New Event</h3>
        <div class="form-grid">
          <div><label for="eventName">Event Name</label><input type="text" id="eventName" placeholder="e.g., Summer Ragnarok 2026"></div>
          <div><label for="eventType">Event Type</label><select id="eventType"><option value="">-- Select Event Type --</option></select></div>
        </div>
        <div class="form-grid"><div><label for="eventStartDate">Start Date</label><input type="date" id="eventStartDate"></div><div><label for="eventEndDate">End Date</label><input type="date" id="eventEndDate"></div></div>
        <button class="btn" onclick="EventsTab.submitCreateEvent()">üéØ Create Event</button><div id="createStatus" class="status"></div>
      </div>
      <div id="eventTypesTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Manage Event Types</h3>
        <div style="margin-bottom:16px; padding:16px; background:#e8f0fe; border-radius:6px;">
          <h4 style="margin:0 0 8px 0; font-size:14px; color:#1a73e8;">Add New Event Type</h4>
          <div class="form-grid"><div><label for="newEventTypeName">Event Type Name</label><input type="text" id="newEventTypeName" placeholder="e.g., Alliance War"></div><div><label for="newEventTypeMethod">Tracking Method</label><select id="newEventTypeMethod" onchange="EventsTab.updateEventTypeMethod()"><option value="" selected>-- Select Method --</option><option value="chest-based">Chest-Based</option><option value="manual-entry">Manual Entry</option><option value="troop-based">Troop-Based</option></select></div></div>
          <div id="chestTypeSection" style="display:none; margin-bottom:12px;"><label>Chest Types for This Event Type</label><div id="chestTypesList" style="max-height:200px; overflow-y:auto; border:1px solid #dadce0; border-radius:6px; padding:8px; background:#fff;"><div class="loading" style="padding:20px; text-align:center; color:#5f6368;">Loading chest types...</div></div><div class="note">Select which chest types count for this event type. Leave empty to include all chests.</div></div>
          <div id="troopTargetSection" style="display:none; margin-bottom:12px;">
            <label style="display:block; margin-bottom:8px; font-weight:600;">G Level Targets</label>
            <p style="color:#5f6368; font-size:12px; margin-bottom:12px;">Set target points for each G level (1-9). Only enter the levels you need.</p>
            <div id="troopTargetsList" style="border:1px solid #dadce0; border-radius:6px; padding:12px; background:#fafbfc; margin-bottom:12px; max-height:250px; overflow-y:auto;">
              <!-- Targets will be added dynamically here -->
            </div>
            <button type="button" class="btn" style="width:100%; margin-bottom:12px;" onclick="EventsTab.addTroopTargetRow()">‚ûï Add G Level Target</button>
          </div>
          <div style="margin-bottom:12px;"><label for="newEventTypeDesc">Description (Optional)</label><input type="text" id="newEventTypeDesc" placeholder="Brief description"></div>
          <div style="margin-bottom:12px;"><label for="newEventTypeThreshold">Threshold (Optional)</label><input type="number" id="newEventTypeThreshold" placeholder="0" min="0" step="1"><div class="note">For manual events: minimum points required. For chest-based: target chest count. For troop-based: number of troops meeting target (leave 0 to disable).</div></div>
          <button class="btn" id="saveEventTypeBtn" onclick="EventsTab.submitAddEventType()">‚ûï Add Event Type</button>
          <button class="btn btn-secondary" id="cancelEditTypeBtn" style="display:none;" onclick="EventsTab.cancelEditEventType()">‚úñ Cancel Edit</button>
          <div id="addTypeStatus" class="status"></div>
        </div>
        <h4 style="margin:0 0 12px 0; font-size:14px; font-weight:600;">Existing Event Types</h4>
        <button class="btn" onclick="EventsTab.renderEventTypesTable()">üîÑ Refresh</button>
        <div class="table-container">
          <div id="typesLoading" class="loading"><div class="spinner"></div><p>Loading event types...</p></div>
          <table id="eventTypesTable" style="display:none;">
            <thead><tr><th>Event Type Name</th><th>Tracking Method</th><th>Chest Types</th><th>Description</th><th>Threshold</th><th></th>Actions</th></tr></thead>
            <tbody id="eventTypesTableBody"></tbody>
          </table>
          <div id="typesEmpty" style="display:none; text-align:center; padding:40px; color:#7f8c8d;"><p>No event types configured.</p></div>
        </div>
      </div>
    </div>
  </div>

  <div id="members" class="tab-content">
    <div class="header"><h1>üë• Member Management</h1><p>View and manage clan members</p></div>
    <div class="stats-cards" id="memberStatsCards">
      <div class="stat-card"><h3>Total Members</h3><div class="value" id="memberTotal">-</div></div>
      <div class="stat-card"><h3>Total Might</h3><div class="value" id="memberTotalMight">-</div></div>
      <div class="stat-card"><h3>Average Might</h3><div class="value" id="memberAverageMight">-</div></div>
    </div>
    <div class="controls"><div class="search-box"><input type="text" id="memberSearchInput" placeholder="üîç Search by member name..."></div><button class="btn" onclick="MembersTab.loadMembers()">üîÑ Refresh</button></div>
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" onclick="MembersTab.switchTab('mightTab', event)">üìä Track Might</button>
        <button class="tab" onclick="MembersTab.switchTab('addMemberTab', event)">‚ûï Add Member</button>
        <button class="tab" onclick="MembersTab.switchTab('nameTab', event)">‚úèÔ∏è Change Name</button>
        <button class="tab" onclick="MembersTab.switchTab('removeMemberTab', event)">üö™ Remove Member</button>
      </div>
      <div id="mightTab" class="tab-content active">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Track Member Might</h3>
        <div class="form-grid"><div><label for="mightMemberSelect">Member</label><select id="mightMemberSelect"></select></div><div><label for="mightValue">Might</label><input type="number" id="mightValue" placeholder="Enter current might" onkeypress="if(event.key==='Enter'){MembersTab.submitMightEntry();}"></div><div><label for="mightDate">Date</label><input type="date" id="mightDate"><div class="note">Defaults to today; change only if needed</div></div></div>
        <button class="btn" onclick="MembersTab.submitMightEntry()">üíæ Save Might</button><div id="mightStatus" class="status"></div>
      </div>
      <div id="addMemberTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Add New Member</h3>
        <div class="form-grid"><div><label for="newMemberNameInput">Member Name</label><input type="text" id="newMemberNameInput" placeholder="Enter member name"></div><div><label for="joinDate">Join Date</label><input type="date" id="joinDate"><div class="note">Date member joined</div></div><div><label for="startMight">Starting Might</label><input type="number" id="startMight" placeholder="Enter starting might" onkeypress="if(event.key==='Enter'){MembersTab.submitAddMember();}"></div></div>
        <button class="btn" onclick="MembersTab.submitAddMember()">‚ûï Add Member</button><div id="addMemberStatus" class="status"></div>
      </div>
      <div id="nameTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Change Member Name</h3>
        <div class="form-grid"><div><label for="oldMemberSelect">Current Member</label><select id="oldMemberSelect"></select></div><div><label for="newMemberName">New Name</label><input type="text" id="newMemberName" placeholder="Enter new member name"></div></div>
        <button class="btn" onclick="MembersTab.submitNameChange()">‚úèÔ∏è Update Name</button><div id="nameChangeStatus" class="status"></div>
      </div>
      <div id="removeMemberTab" class="tab-content">
        <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600; color:#202124;">Remove Member</h3>
        <div class="form-grid"><div><label for="removeMemberSelect">Member to Remove</label><select id="removeMemberSelect"></select></div><div><label for="endDate">End Date</label><input type="date" id="endDate"><div class="note">Date member left</div></div></div>
        <button class="btn" onclick="MembersTab.submitRemoveMember()">üö™ Remove Member</button><div id="removeMemberStatus" class="status"></div>
      </div>
    </div>
    <div class="table-container">
      <div id="memberLoading" class="loading"><div class="spinner"></div><p>Loading members...</p></div>
      <div id="memberError" class="error" style="display:none;"></div>
      <table id="membersTable" style="display:none;">
        <thead><tr><th class="sortable" data-column="name">Member Name</th><th class="sortable" data-column="startMight">Starting Might</th><th class="sortable" data-column="joinDate">Start Date</th><th class="sortable" data-column="growth">Total Growth %</th><th class="sortable" data-column="latestMight">Latest Might</th><th class="sortable" data-column="latestMightDate">Recorded On</th><th class="sortable" data-column="recentGrowth">Recent Growth %</th></tr></thead>
        <tbody id="membersTableBody"></tbody>
      </table>
      <div id="memberEmpty" class="loading" style="display:none;">No members match your search criteria</div>
    </div>
  </div>

  <!-- TROOPS TAB -->
  <div id="troops" class="tab-content">
    <div class="header">
      <h1>‚öîÔ∏è Troop Level Tracker</h1>
      <p>Track and manage troop levels (G, M, S, E) and crypt levels for each member</p>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab active" onclick="TroopsTab.switchSubTab('entry')">Add Entry</button>
        <button class="tab" onclick="TroopsTab.switchSubTab('player')">View Player History</button>
      </div>

      <!-- ADD ENTRY SUB-TAB -->
      <div id="troopEntry" class="tab-content active">
        <div style="display: flex; gap: 12px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 16px;"><div><label for="troopPlayerName">Player Name *</label><select id="troopPlayerName" required onchange="TroopsTab.updatePlayerHistory()" style="width: auto; min-width: 150px;"><option value="">-- Select Player --</option></select></div><div><label for="troopType">Type *</label><select id="troopType" required style="width: auto; min-width: 140px;"><option value="">-- Select Type --</option><option value="G">Guardsmen (G)</option><option value="M">Monsters (M)</option><option value="S">Specialists (S)</option><option value="E">Engineering (E)</option><option value="C">Crypt (C)</option></select></div><div><label for="troopLevel">Level *</label><input type="number" id="troopLevel" required min="0" placeholder="45" style="width: 80px;" /></div><div><label for="troopResearch">Research</label><input type="text" id="troopResearch" placeholder="e.g., [START] or notes" style="width: 200px;" /></div><div style="display: flex; align-items: center; gap: 8px;"><input type="checkbox" id="troopIsStarting" /><label for="troopIsStarting" style="margin: 0; font-weight: normal; text-transform: none;">Starting</label></div><div style="display: flex; gap: 8px;"><button type="button" class="btn" onclick="TroopsTab.submitTroopEntry()">Add Entry</button><button type="button" class="btn btn-secondary" onclick="TroopsTab.resetTroopForm()">Clear</button></div></div>

        <div id="troopEntryMessage" class="status" style="margin-top: 8px;"></div>

        <div id="troopPlayerHistoryContainer" style="margin-top: 20px; display: none;">
          <h2>Recent History for Selected Player</h2>
          <div id="troopPlayerHistoryTable"></div>
        </div>
      </div>

      <!-- PLAYER HISTORY SUB-TAB -->
      <div id="troopPlayer" class="tab-content">
        <div class="form-group">
          <label for="troopHistoryPlayerSelect">Select Player</label>
          <select id="troopHistoryPlayerSelect" onchange="TroopsTab.loadPlayerHistory()">
            <option value="">-- Select Player --</option>
          </select>
        </div>

        <div id="troopPlayerHistoryContent"></div>
      </div>

    </div>

    <!-- SUMMARY SECTION - Always Visible -->
    <div id="troopSummarySection" style="margin-top: 30px;">
      <h2>All Members - Latest Troop Levels</h2>
      <div id="troopSummaryContent" class="loading">Loading...</div>
      <div class="table-container" style="margin-top: 20px; overflow-x: auto;">
        <table id="troopMembersTable" style="display: none;">
          <thead>
            <tr>
              <th class="sortable" data-column="playerName" rowspan="2">Member Name</th>
              <th class="center" colspan="2">G</th>
              <th class="center" colspan="2">M</th>
              <th class="center" colspan="2">S</th>
              <th class="center" colspan="2">E</th>
              <th class="center crypt-col" colspan="2">C</th>
            </tr>
            <tr>
              <th class="center sortable" data-column="G_currentLevel">Level</th>
              <th class="center sortable" data-column="G_currentDate">Date</th>
              <th class="center sortable" data-column="M_currentLevel">Level</th>
              <th class="center sortable" data-column="M_currentDate">Date</th>
              <th class="center sortable" data-column="S_currentLevel">Level</th>
              <th class="center sortable" data-column="S_currentDate">Date</th>
              <th class="center sortable" data-column="E_currentLevel">Level</th>
              <th class="center sortable" data-column="E_currentDate">Date</th>
              <th class="center crypt-col sortable" data-column="C_currentLevel">Level</th>
              <th class="center crypt-col sortable" data-column="C_currentDate">Date</th>
            </tr>
          </thead>
          <tbody id="troopMembersTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="progress" class="tab-content">
    <div class="header"><h1>üìä Progress Dashboard</h1><p>Track member participation, growth, and activity</p></div>
    <div class="period-tabs" style="display:flex; gap:8px; margin-bottom:20px; border-bottom:2px solid #e8eaed; padding-bottom:12px;">
  <div id="compensation" class="tab-content">
    <h1>üí∞ Compensation Calculator</h1>
    <p style="color: #5f6368; margin-bottom: 16px;">Calculate compensation for illegal attacks and save the calculation for future reference</p>
    
    <!-- QUICK ADD SECTION -->
    <div style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 16px; border-left: 4px solid #1a73e8;">
      <h2 style="margin-top: 0; margin-bottom: 16px;">‚ö° Quick Add Losses</h2>
      
      <!-- Heroes & Captains Quick Add -->
      <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e8eaed;">
        <div style="font-size: 13px; font-weight: 600; color: #5f6368; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.4px;">Heroes & Captains</div>
        <div style="display: grid; grid-template-columns: 2fr 1fr 2fr auto; gap: 12px; align-items: end;">
          <div>
            <label for="quickLeaderType">Type</label>
            <select id="quickLeaderType">
              <option value="hero">Hero</option>
              <option value="captain">Captain</option>
            </select>
          </div>
          <div>
            <label for="quickLeaderLevel">Level</label>
            <input type="number" id="quickLeaderLevel" placeholder="1-30" min="1" max="30" value="1">
          </div>
          <div>
            <label for="quickLeaderAmount">Amount</label>
            <input type="number" id="quickLeaderAmount" placeholder="0" min="0">
          </div>
          <button class="btn" onclick="CompensationTab.quickAddLeader()" style="padding: 10px 20px;">‚ûï Add</button>
        </div>
      </div>

      <!-- Troops Quick Add -->
      <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e8eaed;">
        <div style="font-size: 13px; font-weight: 600; color: #5f6368; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.4px;">Troops</div>
        <div style="display: grid; grid-template-columns: 2fr 1fr 2fr auto; gap: 12px; align-items: end;">
          <div>
            <label for="quickTroopType">Type</label>
            <select id="quickTroopType">
              <option value="guardsmen">Guardsmen</option>
              <option value="specialists">Specialists</option>
              <option value="siege">Siege Engines</option>
              <option value="mercenary">Mercenaries</option>
            </select>
          </div>
          <div>
            <label for="quickTroopLevel">Level</label>
            <input type="number" id="quickTroopLevel" placeholder="1-9" min="1" max="9" value="1">
          </div>
          <div>
            <label for="quickTroopAmount">Amount</label>
            <input type="number" id="quickTroopAmount" placeholder="0" min="0">
          </div>
          <button class="btn" onclick="CompensationTab.quickAddTroop()" style="padding: 10px 20px;">‚ûï Add</button>
        </div>
      </div>

      <!-- Monsters Quick Add -->
      <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e8eaed;">
        <div style="font-size: 13px; font-weight: 600; color: #5f6368; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.4px;">Monsters & Creatures</div>
        <div style="display: grid; grid-template-columns: 2fr 2fr auto; gap: 12px; align-items: end;">
          <div>
            <label for="quickMonsterType">Type</label>
            <select id="quickMonsterType">
              <option value="monsterIII">Monster III</option>
              <option value="monsterIV">Monster IV</option>
              <option value="monsterV">Monster V</option>
              <option value="monsterVI">Monster VI</option>
              <option value="monsterVII">Monster VII</option>
              <option value="monsterVIII">Monster VIII</option>
              <option value="monsterIX">Monster IX</option>
              <option value="griffinV">Griffin V</option>
              <option value="griffinVI">Griffin VI</option>
              <option value="griffinVII">Griffin VII</option>
              <option value="coraxI">Corax I</option>
              <option value="coraxII">Corax II</option>
            </select>
          </div>
          <div>
            <label for="quickMonsterAmount">Amount</label>
            <input type="number" id="quickMonsterAmount" placeholder="0" min="0">
          </div>
          <button class="btn" onclick="CompensationTab.quickAddMonster()" style="padding: 10px 20px;">‚ûï Add</button>
        </div>
      </div>

      <!-- Buildings Quick Add -->
      <div>
        <div style="font-size: 13px; font-weight: 600; color: #5f6368; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.4px;">Buildings & Resources</div>
        <div style="display: grid; grid-template-columns: 2fr 2fr auto; gap: 12px; align-items: end;">
          <div>
            <label for="quickBuildingType">Type</label>
            <select id="quickBuildingType">
              <option value="clanCapital">Clan Capital</option>
              <option value="otherBuildingsCount">Other Buildings</option>
              <option value="portalsCount">Portals</option>
              <option value="cityWallCount">City Walls</option>
              <option value="goldAmount">Gold (millions)</option>
              <option value="tarAmount">Tar (millions)</option>
            </select>
          </div>
          <div>
            <label for="quickBuildingAmount">Amount</label>
            <input type="number" id="quickBuildingAmount" placeholder="0" min="0">
          </div>
          <button class="btn" onclick="CompensationTab.quickAddBuilding()" style="padding: 10px 20px;">‚ûï Add</button>
        </div>
      </div>

      <div id="quickAddStatus" class="status" style="margin-top: 12px;"></div>
    </div>

    <div style="background: white; border-radius: 8px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 16px;">
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
        
        <!-- LEFT COLUMN -->
        <div>
          <h2 style="margin-top: 0; margin-bottom: 12px;">Incident Information</h2>
          <div>
            <label for="compensationName">Incident Name/Description</label>
            <input type="text" id="compensationName" placeholder="e.g., Attack on Player123 - Jan 30">
          </div>

          <h2>Heroes & Captains by Level</h2>
          <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div><label for="heroL1">Hero Lvl 1</label><input type="number" id="heroL1" placeholder="0" min="0"></div>
            <div><label for="heroL2">Hero Lvl 2</label><input type="number" id="heroL2" placeholder="0" min="0"></div>
            <div><label for="heroL3">Hero Lvl 3</label><input type="number" id="heroL3" placeholder="0" min="0"></div>
            <div><label for="heroL4">Hero Lvl 4</label><input type="number" id="heroL4" placeholder="0" min="0"></div>
            <div><label for="heroL5">Hero Lvl 5</label><input type="number" id="heroL5" placeholder="0" min="0"></div>
            <div><label for="heroL6">Hero Lvl 6</label><input type="number" id="heroL6" placeholder="0" min="0"></div>
            <div><label for="heroL7">Hero Lvl 7</label><input type="number" id="heroL7" placeholder="0" min="0"></div>
            <div><label for="heroL8">Hero Lvl 8</label><input type="number" id="heroL8" placeholder="0" min="0"></div>
            <div><label for="heroL9">Hero Lvl 9</label><input type="number" id="heroL9" placeholder="0" min="0"></div>
            <div><label for="heroL10">Hero Lvl 10</label><input type="number" id="heroL10" placeholder="0" min="0"></div>
            <div><label for="heroL11">Hero Lvl 11</label><input type="number" id="heroL11" placeholder="0" min="0"></div>
            <div><label for="heroL12">Hero Lvl 12</label><input type="number" id="heroL12" placeholder="0" min="0"></div>
            <div><label for="heroL13">Hero Lvl 13</label><input type="number" id="heroL13" placeholder="0" min="0"></div>
            <div><label for="heroL14">Hero Lvl 14</label><input type="number" id="heroL14" placeholder="0" min="0"></div>
            <div><label for="heroL15">Hero Lvl 15</label><input type="number" id="heroL15" placeholder="0" min="0"></div>
            <div><label for="heroL16">Hero Lvl 16</label><input type="number" id="heroL16" placeholder="0" min="0"></div>
            <div><label for="heroL17">Hero Lvl 17</label><input type="number" id="heroL17" placeholder="0" min="0"></div>
            <div><label for="heroL18">Hero Lvl 18</label><input type="number" id="heroL18" placeholder="0" min="0"></div>
            <div><label for="heroL19">Hero Lvl 19</label><input type="number" id="heroL19" placeholder="0" min="0"></div>
            <div><label for="heroL20">Hero Lvl 20</label><input type="number" id="heroL20" placeholder="0" min="0"></div>
            <div><label for="heroL21">Hero Lvl 21</label><input type="number" id="heroL21" placeholder="0" min="0"></div>
            <div><label for="heroL22">Hero Lvl 22</label><input type="number" id="heroL22" placeholder="0" min="0"></div>
            <div><label for="heroL23">Hero Lvl 23</label><input type="number" id="heroL23" placeholder="0" min="0"></div>
            <div><label for="heroL24">Hero Lvl 24</label><input type="number" id="heroL24" placeholder="0" min="0"></div>
            <div><label for="heroL25">Hero Lvl 25</label><input type="number" id="heroL25" placeholder="0" min="0"></div>
            <div><label for="heroL26">Hero Lvl 26</label><input type="number" id="heroL26" placeholder="0" min="0"></div>
            <div><label for="heroL27">Hero Lvl 27</label><input type="number" id="heroL27" placeholder="0" min="0"></div>
            <div><label for="heroL28">Hero Lvl 28</label><input type="number" id="heroL28" placeholder="0" min="0"></div>
            <div><label for="heroL29">Hero Lvl 29</label><input type="number" id="heroL29" placeholder="0" min="0"></div>
            <div><label for="heroL30">Hero Lvl 30</label><input type="number" id="heroL30" placeholder="0" min="0"></div>
            <div><label for="captainL1">Captain Lvl 1</label><input type="number" id="captainL1" placeholder="0" min="0"></div>
            <div><label for="captainL2">Captain Lvl 2</label><input type="number" id="captainL2" placeholder="0" min="0"></div>
            <div><label for="captainL3">Captain Lvl 3</label><input type="number" id="captainL3" placeholder="0" min="0"></div>
            <div><label for="captainL4">Captain Lvl 4</label><input type="number" id="captainL4" placeholder="0" min="0"></div>
            <div><label for="captainL5">Captain Lvl 5</label><input type="number" id="captainL5" placeholder="0" min="0"></div>
            <div><label for="captainL6">Captain Lvl 6</label><input type="number" id="captainL6" placeholder="0" min="0"></div>
            <div><label for="captainL7">Captain Lvl 7</label><input type="number" id="captainL7" placeholder="0" min="0"></div>
            <div><label for="captainL8">Captain Lvl 8</label><input type="number" id="captainL8" placeholder="0" min="0"></div>
            <div><label for="captainL9">Captain Lvl 9</label><input type="number" id="captainL9" placeholder="0" min="0"></div>
            <div><label for="captainL10">Captain Lvl 10</label><input type="number" id="captainL10" placeholder="0" min="0"></div>
            <div><label for="captainL11">Captain Lvl 11</label><input type="number" id="captainL11" placeholder="0" min="0"></div>
            <div><label for="captainL12">Captain Lvl 12</label><input type="number" id="captainL12" placeholder="0" min="0"></div>
            <div><label for="captainL13">Captain Lvl 13</label><input type="number" id="captainL13" placeholder="0" min="0"></div>
            <div><label for="captainL14">Captain Lvl 14</label><input type="number" id="captainL14" placeholder="0" min="0"></div>
            <div><label for="captainL15">Captain Lvl 15</label><input type="number" id="captainL15" placeholder="0" min="0"></div>
            <div><label for="captainL16">Captain Lvl 16</label><input type="number" id="captainL16" placeholder="0" min="0"></div>
            <div><label for="captainL17">Captain Lvl 17</label><input type="number" id="captainL17" placeholder="0" min="0"></div>
            <div><label for="captainL18">Captain Lvl 18</label><input type="number" id="captainL18" placeholder="0" min="0"></div>
            <div><label for="captainL19">Captain Lvl 19</label><input type="number" id="captainL19" placeholder="0" min="0"></div>
            <div><label for="captainL20">Captain Lvl 20</label><input type="number" id="captainL20" placeholder="0" min="0"></div>
            <div><label for="captainL21">Captain Lvl 21</label><input type="number" id="captainL21" placeholder="0" min="0"></div>
            <div><label for="captainL22">Captain Lvl 22</label><input type="number" id="captainL22" placeholder="0" min="0"></div>
            <div><label for="captainL23">Captain Lvl 23</label><input type="number" id="captainL23" placeholder="0" min="0"></div>
            <div><label for="captainL24">Captain Lvl 24</label><input type="number" id="captainL24" placeholder="0" min="0"></div>
            <div><label for="captainL25">Captain Lvl 25</label><input type="number" id="captainL25" placeholder="0" min="0"></div>
            <div><label for="captainL26">Captain Lvl 26</label><input type="number" id="captainL26" placeholder="0" min="0"></div>
            <div><label for="captainL27">Captain Lvl 27</label><input type="number" id="captainL27" placeholder="0" min="0"></div>
            <div><label for="captainL28">Captain Lvl 28</label><input type="number" id="captainL28" placeholder="0" min="0"></div>
            <div><label for="captainL29">Captain Lvl 29</label><input type="number" id="captainL29" placeholder="0" min="0"></div>
            <div><label for="captainL30">Captain Lvl 30</label><input type="number" id="captainL30" placeholder="0" min="0"></div>
          </div>

          <h2>Guardsmen by Level</h2>
          <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div><label for="guardsmenL1">Lvl 1</label><input type="number" id="guardsmenL1" placeholder="0" min="0"></div>
            <div><label for="guardsmenL2">Lvl 2</label><input type="number" id="guardsmenL2" placeholder="0" min="0"></div>
            <div><label for="guardsmenL3">Lvl 3</label><input type="number" id="guardsmenL3" placeholder="0" min="0"></div>
            <div><label for="guardsmenL4">Lvl 4</label><input type="number" id="guardsmenL4" placeholder="0" min="0"></div>
            <div><label for="guardsmenL5">Lvl 5</label><input type="number" id="guardsmenL5" placeholder="0" min="0"></div>
            <div><label for="guardsmenL6">Lvl 6</label><input type="number" id="guardsmenL6" placeholder="0" min="0"></div>
            <div><label for="guardsmenL7">Lvl 7</label><input type="number" id="guardsmenL7" placeholder="0" min="0"></div>
            <div><label for="guardsmenL8">Lvl 8</label><input type="number" id="guardsmenL8" placeholder="0" min="0"></div>
            <div><label for="guardsmenL9">Lvl 9</label><input type="number" id="guardsmenL9" placeholder="0" min="0"></div>
          </div>

          <h2>Specialists by Level</h2>
          <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div><label for="specialistsL1">Lvl 1</label><input type="number" id="specialistsL1" placeholder="0" min="0"></div>
            <div><label for="specialistsL2">Lvl 2</label><input type="number" id="specialistsL2" placeholder="0" min="0"></div>
            <div><label for="specialistsL3">Lvl 3</label><input type="number" id="specialistsL3" placeholder="0" min="0"></div>
            <div><label for="specialistsL4">Lvl 4</label><input type="number" id="specialistsL4" placeholder="0" min="0"></div>
            <div><label for="specialistsL5">Lvl 5</label><input type="number" id="specialistsL5" placeholder="0" min="0"></div>
            <div><label for="specialistsL6">Lvl 6</label><input type="number" id="specialistsL6" placeholder="0" min="0"></div>
            <div><label for="specialistsL7">Lvl 7</label><input type="number" id="specialistsL7" placeholder="0" min="0"></div>
            <div><label for="specialistsL8">Lvl 8</label><input type="number" id="specialistsL8" placeholder="0" min="0"></div>
            <div><label for="specialistsL9">Lvl 9</label><input type="number" id="specialistsL9" placeholder="0" min="0"></div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
          <h2 style="margin-top: 0;">Siege Engines by Level</h2>
          <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div><label for="siegeL1">Lvl 1</label><input type="number" id="siegeL1" placeholder="0" min="0"></div>
            <div><label for="siegeL2">Lvl 2</label><input type="number" id="siegeL2" placeholder="0" min="0"></div>
            <div><label for="siegeL3">Lvl 3</label><input type="number" id="siegeL3" placeholder="0" min="0"></div>
            <div><label for="siegeL4">Lvl 4</label><input type="number" id="siegeL4" placeholder="0" min="0"></div>
            <div><label for="siegeL5">Lvl 5</label><input type="number" id="siegeL5" placeholder="0" min="0"></div>
            <div><label for="siegeL6">Lvl 6</label><input type="number" id="siegeL6" placeholder="0" min="0"></div>
            <div><label for="siegeL7">Lvl 7</label><input type="number" id="siegeL7" placeholder="0" min="0"></div>
            <div><label for="siegeL8">Lvl 8</label><input type="number" id="siegeL8" placeholder="0" min="0"></div>
            <div><label for="siegeL9">Lvl 9</label><input type="number" id="siegeL9" placeholder="0" min="0"></div>
          </div>

          <h2>Mercenaries by Level</h2>
          <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div><label for="mercenaryL1">Lvl 1</label><input type="number" id="mercenaryL1" placeholder="0" min="0"></div>
            <div><label for="mercenaryL2">Lvl 2</label><input type="number" id="mercenaryL2" placeholder="0" min="0"></div>
            <div><label for="mercenaryL3">Lvl 3</label><input type="number" id="mercenaryL3" placeholder="0" min="0"></div>
            <div><label for="mercenaryL4">Lvl 4</label><input type="number" id="mercenaryL4" placeholder="0" min="0"></div>
            <div><label for="mercenaryL5">Lvl 5</label><input type="number" id="mercenaryL5" placeholder="0" min="0"></div>
            <div><label for="mercenaryL6">Lvl 6</label><input type="number" id="mercenaryL6" placeholder="0" min="0"></div>
            <div><label for="mercenaryL7">Lvl 7</label><input type="number" id="mercenaryL7" placeholder="0" min="0"></div>
            <div><label for="mercenaryL8">Lvl 8</label><input type="number" id="mercenaryL8" placeholder="0" min="0"></div>
            <div><label for="mercenaryL9">Lvl 9</label><input type="number" id="mercenaryL9" placeholder="0" min="0"></div>
          </div>

          <h2>Monsters & Creatures</h2>
          <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
            <div><label for="monsterIII">Monster III</label><input type="number" id="monsterIII" placeholder="0" min="0"></div>
            <div><label for="monsterIV">Monster IV</label><input type="number" id="monsterIV" placeholder="0" min="0"></div>
            <div><label for="monsterV">Monster V</label><input type="number" id="monsterV" placeholder="0" min="0"></div>
            <div><label for="monsterVI">Monster VI</label><input type="number" id="monsterVI" placeholder="0" min="0"></div>
            <div><label for="monsterVII">Monster VII</label><input type="number" id="monsterVII" placeholder="0" min="0"></div>
            <div><label for="monsterVIII">Monster VIII</label><input type="number" id="monsterVIII" placeholder="0" min="0"></div>
            <div><label for="monsterIX">Monster IX</label><input type="number" id="monsterIX" placeholder="0" min="0"></div>
            <div><label for="griffinV">Griffin V</label><input type="number" id="griffinV" placeholder="0" min="0"></div>
            <div><label for="griffinVI">Griffin VI</label><input type="number" id="griffinVI" placeholder="0" min="0"></div>
            <div><label for="griffinVII">Griffin VII</label><input type="number" id="griffinVII" placeholder="0" min="0"></div>
            <div><label for="coraxI">Corax I</label><input type="number" id="coraxI" placeholder="0" min="0"></div>
            <div><label for="coraxII">Corax II</label><input type="number" id="coraxII" placeholder="0" min="0"></div>
          </div>

          <h2>Buildings & Resources</h2>
          <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
            <div><label for="clanCapital">Clan Capital Lost?</label><select id="clanCapital"><option value="">No</option><option value="1">Yes</option></select></div>
            <div><label for="otherBuildingsCount">Other Buildings</label><input type="number" id="otherBuildingsCount" placeholder="0" min="0"></div>
            <div><label for="portalsCount">Portals</label><input type="number" id="portalsCount" placeholder="0" min="0"></div>
            <div><label for="cityWallCount">City Walls</label><input type="number" id="cityWallCount" placeholder="0" min="0"></div>
            <div><label for="goldAmount">Gold Lost (millions)</label><input type="number" id="goldAmount" placeholder="0" min="0"></div>
            <div><label for="tarAmount">Tar Lost (millions)</label><input type="number" id="tarAmount" placeholder="0" min="0"></div>
          </div>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div style="margin-top: 32px; display: flex; gap: 12px; padding-top: 24px; border-top: 1px solid #e8eaed;">
        <button class="btn" onclick="CompensationTab.calculate()">üí∞ Calculate & Save</button>
        <button class="btn btn-secondary" onclick="CompensationTab.clearForm()">Clear Form</button>
      </div>
      
      <div id="compensationStatus" class="status" style="margin-top: 12px;"></div>
    </div>

    <!-- RESULTS SECTION -->
    <div id="compensationResult" style="display: none;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border-left: 4px solid #1a73e8;">
          <div style="font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">Heroes & Captains</div>
          <div id="resultHeroes" style="font-size: 24px; font-weight: 700; color: #1a73e8;">0</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border-left: 4px solid #34a853;">
          <div style="font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">Troops</div>
          <div id="resultTroops" style="font-size: 24px; font-weight: 700; color: #34a853;">0</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border-left: 4px solid #fbbc04;">
          <div style="font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">Monsters & Creatures</div>
          <div id="resultMonsters" style="font-size: 24px; font-weight: 700; color: #fbbc04;">0</div>
        </div>
        <div style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border-left: 4px solid #ea4335;">
          <div style="font-size: 12px; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px;">Buildings & Resources</div>
          <div id="resultBuildings" style="font-size: 24px; font-weight: 700; color: #ea4335;">0</div>
        </div>
      </div>

      <div style="background: linear-gradient(135deg, #1a73e8 0%, #1765c1 100%); color: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
        <div style="font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.9; font-weight: 600; margin-bottom: 12px;">Grand Total Compensation</div>
        <div id="resultGrandTotal" style="font-size: 40px; font-weight: 700; margin-bottom: 16px;">0</div>
        <div style="font-size: 12px; opacity: 0.95; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px;">
          Saved to sheet: <span id="resultSheetName" style="font-weight: 600;"></span>
        </div>
      </div>
    </div>

    <!-- REPORT HISTORY -->
    <div style="margin-top: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h2 style="margin: 0; font-size: 18px; color: #5f6368;">üìã Compensation History</h2>
        <button class="btn btn-secondary" onclick="CompensationTab.loadReports()" style="padding: 8px 16px; font-size: 13px;">üîÑ Refresh List</button>
      </div>
      
      <div id="compensationReportsLoading" class="loading" style="display: none; padding: 20px;">
        <div class="spinner"></div>
        <p>Loading reports...</p>
      </div>
      
      <div id="compensationReportsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px;">
        <!-- Reports will be populated here -->
      </div>
      
      <div id="compensationReportsEmpty" style="display: none; background: white; border-radius: 8px; padding: 40px; text-align: center; color: #5f6368; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        No compensation reports found
      </div>
    </div>

    <!-- REPORT DETAIL MODAL -->
    <div id="compensationDetailModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; padding: 40px;" onclick="if(event.target===this) CompensationTab.closeDetail()">
      <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); max-height: calc(100vh - 80px); overflow-y: auto;">
        <div style="padding: 24px; border-bottom: 1px solid #e8eaed; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 20px; color: #1a73e8;">üìÑ Compensation Report Details</h2>
          <button onclick="CompensationTab.closeDetail()" style="background: none; border: none; font-size: 24px; color: #5f6368; cursor: pointer; padding: 0; width: 32px; height: 32px; line-height: 32px; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">√ó</button>
        </div>
        <div id="compensationDetailContent" style="padding: 24px;">
          <!-- Detail content will be populated here -->
        </div>
      </div>
    </div>
  </div>

  <div id="points" class="tab-content">
    <h1>üìã Points Reference</h1>
    <p style="color: #5f6368; margin-bottom: 16px;">Reference table for all chest types and their corresponding point values</p>
    <div class="points-reference-table">
      <table class="points-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Crypt / Level</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="type-cell">Arena</td><td class="level-cell">Arena</td><td class="points-cell">1</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 5 Crypt</td><td class="points-cell">1</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 10 Crypt</td><td class="points-cell">5</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 15 Crypt</td><td class="points-cell">25</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 20 Crypt</td><td class="points-cell">80</td></tr>
          <tr><td class="type-cell">Common Crypt</td><td class="level-cell">Level 25 Crypt</td><td class="points-cell">275</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 10 Rare Crypt</td><td class="points-cell">8</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 15 Rare Crypt</td><td class="points-cell">40</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 20 Rare Crypt</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 25 Rare Crypt</td><td class="points-cell">360</td></tr>
          <tr><td class="type-cell">Rare Crypt</td><td class="level-cell">Level 30 Rare Crypt</td><td class="points-cell">600</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 15 Epic Crypt</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 20 Epic Crypt</td><td class="points-cell">225</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 25 Epic Crypt</td><td class="points-cell">450</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 30 Epic Crypt</td><td class="points-cell">700</td></tr>
          <tr><td class="type-cell">Epic Crypt</td><td class="level-cell">Level 35 Epic Crypt</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 10</td><td class="points-cell">8</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 15</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 20</td><td class="points-cell">225</td><td class="points-cell">225</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 25</td><td class="points-cell">450</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 30</td><td class="points-cell">700</td></tr>
          <tr><td class="type-cell">Tartaros Crypt</td><td class="level-cell">Level 35</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 10</td><td class="points-cell">4</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 15</td><td class="points-cell">20</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 20</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 25</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Elven Citadel</td><td class="level-cell">Level 30</td><td class="points-cell">300</td></tr>
          <tr><td class="type-cell">Cursed Citadel</td><td class="level-cell">Level 20</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Cursed Citadel</td><td class="level-cell">Level 25</td><td class="points-cell">140</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 16‚Äì19</td><td class="points-cell">25</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 20‚Äì24</td><td class="points-cell">60</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 25‚Äì30</td><td class="points-cell">150</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 31‚Äì34</td><td class="points-cell">350</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 35‚Äì40</td><td class="points-cell">625</td></tr>
          <tr><td class="type-cell">Heroic Monster</td><td class="level-cell">Level 41‚Äì45</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Epic Squad</td><td class="level-cell">Any Epic Squad</td><td class="points-cell">500</td></tr>
          <tr><td class="type-cell">Hermes Store</td><td class="level-cell">Store</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Mercenary Exchange</td><td class="level-cell">Exchange</td><td class="points-cell">250</td></tr>
          <tr><td class="type-cell">Ragnarok Shop</td><td class="level-cell">Shop</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Wooden</td><td class="points-cell">5</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Conqueror's</td><td class="points-cell">10</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Bronze</td><td class="points-cell">35</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Silver</td><td class="points-cell">125</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Golden</td><td class="points-cell">375</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Precious</td><td class="points-cell">625</td></tr>
          <tr><td class="type-cell">Store (Bank)</td><td class="level-cell">Magic</td><td class="points-cell">1000</td></tr>
          <tr><td class="type-cell">Tournament</td><td class="level-cell">Authority Rush</td><td class="points-cell">10</td></tr>
          <tr><td class="type-cell">Union of Triumph</td><td class="level-cell">Union Chest (Personal)</td><td class="points-cell">50</td></tr>
          <tr><td class="type-cell">Ancient / Runic / Event Chests</td><td class="level-cell">All listed</td><td class="points-cell">0</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const isSidebar = typeof google !== 'undefined' && google.script && google.script.run;
    const expandedTypes = new Set();
    let eventsInitialized = false;
    
    // Update UI based on read-only mode
    function updateReadOnlyUI() {
      if (document.documentElement.classList.contains('read-only-mode')) {
        const navBrand = document.getElementById('navBrand');
        if (navBrand) navBrand.innerHTML = '<img src="moo-portal.png" alt="MOO"> Masters Of Oops (MOO)';
        const badge = document.getElementById('readOnlyBadge');
        if (badge) badge.style.display = 'block';
      } else {
        const navBrand = document.getElementById('navBrand');
        if (navBrand) navBrand.innerHTML = '<img src="moo-portal.png" alt="MOO"> MOO Portal';
        const badge = document.getElementById('readOnlyBadge');
        if (badge) badge.style.display = 'none';
      }
    }
    window.addEventListener('DOMContentLoaded', updateReadOnlyUI);
    let membersInitialized = false;
    let troopsInitialized = false;
    let progressInitialized = false;
    let compensationInitialized = false;

    // ============ RESPONSE NORMALIZATION ============
    // Normalizes API responses to consistent format {success: bool, data: ?, error: ?}
    function normalizeResponse(result) {
      if (!result) return { success: false, error: 'No result' };
      if (result.success !== undefined) return result; // Already normalized
      if (Array.isArray(result)) return { success: true, data: result };
      if (result.error) return { success: false, error: result.error };
      if (result.message && !result.data) return { success: true, message: result.message };
      // Handle objects with data - preserve both data and specific keys
      if (typeof result === 'object') {
        return { success: true, data: result, ...result };
      }
      return { success: true, data: result }; // Default
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId)?.classList.add('active');
      const tabNames = ['dashboard','events','members','troops','progress','compensation','points'];
      const idx = tabNames.indexOf(tabId);
      const btns = document.querySelectorAll('.tab-btn');
      if (idx >= 0 && btns[idx]) btns[idx].classList.add('active');
      loadTabContent(tabId);
    }

    function loadTabContent(tabId) {
      if (tabId === 'dashboard') return;
      if (tabId === 'events') {
        if (!eventsInitialized) {
          eventsInitialized = true;
          if (typeof EventsTab !== 'undefined' && EventsTab && typeof EventsTab.init === 'function') {
            EventsTab.init();
          }
        } else {
          if (typeof EventsTab !== 'undefined' && EventsTab && typeof EventsTab.switchTab === 'function') {
            EventsTab.switchTab('manageTab');
            if (typeof EventsTab.loadEvents === 'function') EventsTab.loadEvents();
          }
        }
      }
      if (tabId === 'members' && !membersInitialized) {
        membersInitialized = true;
        if (typeof MembersTab !== 'undefined' && MembersTab && typeof MembersTab.init === 'function') {
          MembersTab.init();
        }
      }
      if (tabId === 'troops') {
        if (!troopsInitialized) {
          troopsInitialized = true;
          if (typeof TroopsTab !== 'undefined' && TroopsTab && typeof TroopsTab.init === 'function') {
            TroopsTab.init();
          }
        } else {
          if (typeof TroopsTab !== 'undefined' && TroopsTab && typeof TroopsTab.switchSubTab === 'function') {
            TroopsTab.switchSubTab('summary');
          }
        }
      }
      if (tabId === 'progress' && !progressInitialized) {
        progressInitialized = true;
        if (typeof ProgressTab !== 'undefined' && ProgressTab && typeof ProgressTab.init === 'function') {
          ProgressTab.init();
        }
      }
      if (tabId === 'compensation' && !compensationInitialized) {
        compensationInitialized = true;
        if (typeof CompensationTab !== 'undefined' && CompensationTab && typeof CompensationTab.init === 'function') {
          CompensationTab.init();
        }
      }
    }

    // Dashboard
    window.onload = function() { if (isSidebar) { setDateRange('lastday'); } else { setDateRange('lastday'); } };
    function setDateRange(preset) {
      const today = new Date();
      const startInput = document.getElementById('startDate');
      const endInput = document.getElementById('endDate');
      const displayElement = document.getElementById('dateRangeDisplay');
      
      // Format date as YYYY-MM-DD using LOCAL timezone (not UTC)
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };
      const formatDisplayDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`[data-preset="${preset}"]`)?.classList.add('active');
      if (preset === 'lastday') {
        // Active Period: Sunday to Saturday (current week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        const end = new Date(start);
        // Saturday (6 days after start)
        end.setDate(start.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Active Period (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'prevweek') {
        // Previous Week: Sunday to Saturday (last week)
        const start = new Date(today);
        // Move to last Sunday (0 = Sunday)
        start.setDate(start.getDate() - start.getDay());
        // Go back one full week
        start.setDate(start.getDate() - 7);
        const end = new Date(start);
        // Saturday (6 days after start)
        end.setDate(start.getDate() + 6);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Previous Week (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'currentmonth') {
        const start = new Date(today.getFullYear(), today.getMonth(), 1);
        // Get the last day of current month
        const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Current Month: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
      if (preset === 'lastmonth') {
        const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const end = new Date(today.getFullYear(), today.getMonth(), 0);
        startInput.value = formatDate(start);
        endInput.value = formatDate(end);
        displayElement.textContent = `Viewing: Last Month: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        loadDashboard();
        return;
      }
    }
    function loadDashboard() {
      if (!isSidebar) { document.getElementById('playerList').innerHTML = '<div class="loading" style="color:#d93025;">‚ö†Ô∏è Dashboard must be opened from the spreadsheet menu.</div>'; return; }
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      google.script.run.withSuccessHandler(displaySummary).withFailureHandler((e)=>console.error('Summary error:',e)).getStatsSummary(startDate,endDate);
      document.getElementById('playerList').innerHTML = '<div class="loading">Loading...</div>';
      google.script.run.withSuccessHandler(displayPlayerStats).withFailureHandler((e)=>{console.error('Stats error:',e); document.getElementById('playerList').innerHTML='<div class="loading" style="color:#d93025;">Error loading player stats</div>';}).getPlayerStats(null,null,startDate,endDate);
    }
    function displaySummary(data) {
      document.getElementById('totalChests').textContent = data.totalChests ? data.totalChests.toLocaleString() : '0';
      document.getElementById('totalMembers').textContent = data.totalMembers || '0';
      document.getElementById('totalPlayers').textContent = data.totalPlayers || '0';
      document.getElementById('totalPoints').textContent = data.totalPoints ? data.totalPoints.toLocaleString() : '0';
      if (data.lastAvailableDate) {
        const dateObj = new Date(data.lastAvailableDate + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        document.getElementById('lastUpdatedDisplay').textContent = `Last Date Available: ${dateStr} ‚Ä¢ Weekly target: 10 000 points`;
      } else {
        document.getElementById('lastUpdatedDisplay').textContent = 'Last Date Available: No data available ‚Ä¢ Weekly target: 10 000 points';
      }
    }
    function displayPlayerStats(stats) {
      const container = document.getElementById('playerList');
      console.log('[DEBUG] displayPlayerStats received:', stats, 'type:', typeof stats, 'isArray:', Array.isArray(stats));
      
      // Normalize response format
      const norm = normalizeResponse(stats);
      let playerArray = norm.data || norm.playerStats || stats;
      
      // If it's an object with summary data (totalChests, totalMembers), ignore it - wrong handler
      if (playerArray && typeof playerArray === 'object' && !Array.isArray(playerArray) && ('totalChests' in playerArray || 'totalMembers' in playerArray)) {
        console.warn('[DEBUG] displayPlayerStats ignoring summary data (wrong handler called)');
        return;
      }
      
      // Ensure we have an array
      if (!Array.isArray(playerArray)) playerArray = [];
      
      if (playerArray.length === 0) { container.innerHTML = '<div class="loading">No data found</div>'; return; }
      const typeData = {};
      playerArray.forEach(player => {
        if (player.chestsByTypeGrouped) {
          Object.entries(player.chestsByTypeGrouped).forEach(([type,data]) => {
            if (!typeData[type]) typeData[type] = { levels:new Set(), total:0 };
            if (data.levels) Object.keys(data.levels).forEach(level => typeData[type].levels.add(level));
            typeData[type].total += data.total || 0;
          });
        }
      });
      const sortedTypes = Object.entries(typeData).sort((a,b)=>b[1].total-a[1].total).map(([name,data])=>({ name, levels: Array.from(data.levels).map(l=>parseInt(l)).sort((a,b)=>a-b) }));
      let headerHtml = '<div class="table-header">';
      headerHtml += '<div class="header-cell rank-col">Rank</div><div class="header-cell">Player</div><div class="header-cell">Pts</div><div class="header-cell">Total</div>';
      sortedTypes.forEach(type=>{ headerHtml += `<div class="header-cell type-total-header" onclick="toggleType('${type.name}')" data-type="${type.name}"><span class="toggle-icon">‚ñ∂</span>${type.name}</div>`; type.levels.forEach(level=>{ headerHtml += `<div class="header-cell level-header" data-type="${type.name}" data-level="${level}">Lvl ${level}</div>`;}); });
      headerHtml += '</div>';
      let rowsHtml = '';
      playerArray.forEach((player,idx)=>{
        const commonCryptInfo = player.chestsByTypeGrouped?.['Common Crypt'];
        const totalPointsVal = player.totalPoints || 0;
        const pointsClass = totalPointsVal >= 10000 ? 'player-green' : (totalPointsVal >= 5000 ? 'player-orange' : 'player-red');
        rowsHtml += '<div class="player-row">';
        rowsHtml += `<div class="cell rank-col">${idx+1}</div><div class="cell ${pointsClass}">${player.player}</div><div class="cell">${totalPointsVal || '-'}</div>`;
        // Calculate total chests: use totalChests if available, otherwise sum from chestsByTypeGrouped (don't double-count eventChests!)
        let totalChests = player.totalChests || 0;
        if (totalChests === 0 && player.chestsByTypeGrouped) {
          Object.values(player.chestsByTypeGrouped).forEach(t=>{ totalChests += t.total || 0; });
        }
        rowsHtml += `<div class="cell">${totalChests||'-'}</div>`;
        sortedTypes.forEach(type=>{
          const typeInfo = player.chestsByTypeGrouped?.[type.name]; const totalCount = typeInfo?.total || 0;
          const totalClass = (type.name === 'Common Crypt' && ((commonCryptInfo?.levels?.['5']||0)>0 || (commonCryptInfo?.levels?.['10']||0)>0)) ? 'player-red' : '';
          rowsHtml += `<div class="cell" data-type="${type.name}"><span class="${totalCount===0?'count-zero':''} ${totalClass}">${totalCount||'-'}</span></div>`;
          type.levels.forEach(level=>{
            const levelCount = typeInfo?.levels?.[level] || 0;
            const badCrypt = (type.name === 'Common Crypt' && (level === 5 || level === 10) && levelCount > 0) ? 'player-red' : '';
            rowsHtml += `<div class="cell level-cell" data-type="${type.name}" data-level="${level}"><span class="${levelCount===0?'count-zero':''} ${badCrypt}">${levelCount||'-'}</span></div>`;
          });
        });
        rowsHtml += '</div>';
      });
      container.innerHTML = `<div class="chest-table">${headerHtml}${rowsHtml}</div>`;
    }
    function toggleType(typeName) {
      const header = document.querySelector(`.type-total-header[data-type="${typeName}"]`);
      const isExpanded = expandedTypes.has(typeName);
      if (isExpanded) { expandedTypes.delete(typeName); header.classList.remove('expanded'); } else { expandedTypes.add(typeName); header.classList.add('expanded'); }
      document.querySelectorAll(`[data-type="${typeName}"]`).forEach(el=>{ if (el.classList.contains('level-header')||el.classList.contains('level-cell')) el.classList.toggle('visible'); });
    }

    // Events Tab
    const EventsTab = (() => {
      let eventsData = [];
      let selectedEvent = null;
      let membersData = [];
      let eventTypesData = [];
      let availableChestTypes = [];
      let participationRawData = [];
      let currentSortColumn = null;
      let currentSortDirection = 'asc';
      let manualSortColumn = 'points';
      let manualSortDirection = 'desc';
      let currentParticipationEventName = null;
      let editingTypeOriginalName = null;

      function init() {
        switchTab('manageTab');
        loadEvents();
        loadMembers();
        loadChestTypes();
        loadEventTypes();
        updateEventTypeMethod();
      }

      function switchTab(tabId, evt) {
        document.querySelectorAll('#events .tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('#events .tab').forEach(t=>t.classList.remove('active'));
        document.getElementById(tabId)?.classList.add('active');
        if (evt && evt.target) evt.target.classList.add('active');
        if (tabId === 'manageTab') loadEvents();
        if (tabId === 'chestEventsTab') populateChestEventSelect();
        if (tabId === 'manualEventsTab') populateManualEventSelect();
        if (tabId === 'eventTypesTab') loadEventTypes();
      }

      function loadEvents() {
        document.getElementById('eventsLoading').style.display='block';
        document.getElementById('eventsTable').style.display='none';
        document.getElementById('eventsEmpty').style.display='none';
        google.script.run.withSuccessHandler(onEventsLoaded).withFailureHandler((error)=>{ console.error('Error loading events:',error); document.getElementById('eventsLoading').innerHTML = '<p style="color:#c33;">Error: '+error.message+'</p>'; }).getAllEvents();
      }
      function onEventsLoaded(result) {
        if (!result || !result.success) { document.getElementById('eventsLoading').innerHTML = '<p style="color:#c33;">Error loading events.</p>'; return; }
        eventsData = result.events || [];
        document.getElementById('eventsLoading').style.display='none';
        if (eventsData.length===0) { document.getElementById('eventsEmpty').style.display='block'; return; }
        renderEventsTable();
        document.getElementById('eventsTable').style.display='table';
      }
      let eventSortConfig = { field: 'endDate', ascending: false };
      
      function renderEventsTable() {
        const tbody = document.getElementById('eventsTableBody'); tbody.innerHTML='';
        const sortedEvents = [...eventsData].sort((a,b)=> {
          const aVal = a[eventSortConfig.field];
          const bVal = b[eventSortConfig.field];
          let comparison = 0;
          if (aVal < bVal) comparison = -1;
          if (aVal > bVal) comparison = 1;
          return eventSortConfig.ascending ? comparison : -comparison;
        });
        sortedEvents.forEach(event=>{
          const methodBadge = event.participationMethod==='chest-based' ? '<span class="badge chest">Chest-Based</span>' : '<span class="badge manual">Manual Entry</span>';
          const calcBtn = event.participationMethod==='chest-based' ? `<button class="btn action-btn" data-action="calc" data-event-name="${escapeHtml(event.eventName)}">üîÑ Calc</button>` : '';
          const viewBtn = `<button class="btn action-btn" data-action="view" data-event-name="${escapeHtml(event.eventName)}">üëÅ View</button>`;
          const editBtn = `<button class="btn action-btn" data-action="edit" data-event-name="${escapeHtml(event.eventName)}">‚úèÔ∏è Edit</button>`;
          const deleteBtn = `<button class="btn action-btn btn-secondary" data-action="delete" data-event-name="${escapeHtml(event.eventName)}">üóëÔ∏è Delete</button>`;
          const row = document.createElement('tr');
          row.innerHTML = `<td class="event-name">${escapeHtml(event.eventName)}</td><td>${escapeHtml(event.eventType)}</td><td>${event.startDate}</td><td>${event.endDate}</td><td>${methodBadge}</td><td>${calcBtn}${viewBtn}${editBtn}${deleteBtn}</td>`;
          tbody.appendChild(row);
        });
        tbody.querySelectorAll('button[data-action]').forEach(btn=>{
          btn.addEventListener('click',function(){ const action=this.getAttribute('data-action'); const eventName=this.getAttribute('data-event-name'); if (action==='calc') calculateEventParticipation(eventName); if (action==='view') viewEventParticipation(eventName); if (action==='edit') editEvent(eventName); if (action==='delete') deleteEvent(eventName); });
        });
        attachSortHandlers();
      }
      
      function attachSortHandlers() {
        document.querySelectorAll('th.sortable').forEach(th => {
          th.style.cursor = 'pointer';
          th.style.userSelect = 'none';
          th.addEventListener('click', function() {
            const field = this.getAttribute('data-sort');
            if (eventSortConfig.field === field) {
              eventSortConfig.ascending = !eventSortConfig.ascending;
            } else {
              eventSortConfig.field = field;
              eventSortConfig.ascending = false;
            }
            renderEventsTable();
          });
          // Add visual indicator
          if (eventSortConfig.field === th.getAttribute('data-sort')) {
            th.textContent += eventSortConfig.ascending ? ' ‚Üë' : ' ‚Üì';
          }
        });
      }
      
      let editingEventName = null;
      
      function editEvent(eventName) {
        const event = eventsData.find(e => e.eventName === eventName);
        if (!event) { alert('Event not found.'); return; }
        
        editingEventName = eventName;
        document.getElementById('eventName').value = event.eventName;
        document.getElementById('eventType').value = event.eventType;
        document.getElementById('eventStartDate').value = event.startDate;
        document.getElementById('eventEndDate').value = event.endDate;
        
        const submitBtn = document.querySelector('button[onclick="EventsTab.submitCreateEvent()"]');
        submitBtn.textContent = 'üíæ Update Event';
        
        EventsTab.switchTab('createTab');
      }

      function loadMembers() { google.script.run.withSuccessHandler((result)=>{ membersData = result||[]; populateMemberSelects(); }).getMembersList(); }
      function populateMemberSelects() {
        const sorted = [...membersData].sort((a,b)=>a.name.localeCompare(b.name));
        const options = ['<option value="">-- Select member --</option>'].concat(sorted.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`)).join('');
        const manualMember = document.getElementById('manualMember'); if (manualMember) manualMember.innerHTML = options || '<option value="">-- No members --</option>';
      }
      function populateChestEventSelect() {
        const select = document.getElementById('chestEventSelect');
        if (!eventsData || eventsData.length===0) { select.innerHTML='<option value="">-- No events available --</option>'; return; }
        const chestEvents = eventsData.filter(e=>e.participationMethod==='chest-based');
        if (chestEvents.length===0) { select.innerHTML='<option value="">-- No chest-based events --</option>'; return; }
        select.innerHTML = ['<option value="">-- Select Chest Event --</option>'].concat(chestEvents.map(e=>`<option value="${escapeHtml(e.eventName)}">${escapeHtml(e.eventName)}</option>`)).join('');
      }
      function populateManualEventSelect() {
        const select = document.getElementById('manualEventSelect');
        if (!eventsData || eventsData.length===0) { select.innerHTML='<option value="">-- No events available --</option>'; return; }
        const manualEvents = eventsData.filter(e=>e.participationMethod==='manual-entry');
        if (manualEvents.length===0) { select.innerHTML='<option value="">-- No manual events --</option>'; return; }
        select.innerHTML = ['<option value="">-- Select Event --</option>'].concat(manualEvents.map(e=>`<option value="${escapeHtml(e.eventName)}">${escapeHtml(e.eventName)}</option>`)).join('');
      }
      function calculateEventParticipation(eventName) {
        const evt = eventsData.find(e=>e.eventName===eventName); if (!evt) { alert('Event not found.'); return; }
        if (evt.participationMethod!=='chest-based') { alert('Participation calculation applies to chest-based events only.'); return; }
        const status = document.createElement('div'); status.className='status'; status.textContent=`‚è≥ Calculating participation for "${evt.eventName}"...`; status.style.cssText='position:fixed; top:20px; right:20px; background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1000; min-width:300px;'; document.body.appendChild(status);
        google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { status.textContent='‚úì '+result.message; status.classList.add('ok'); status.style.background='#d4edda'; status.style.color='#155724'; selectedEvent=evt; currentParticipationEventName=evt.eventName; loadChestParticipationData(evt.eventName); } else { status.textContent='‚úï '+(result?.message||'Failed to calculate.'); status.classList.add('err'); status.style.background='#f8d7da'; status.style.color='#721c24'; } setTimeout(()=>status.remove(),5000); }).withFailureHandler((error)=>{ status.textContent=`‚úï Error: ${error.message}`; status.classList.add('err'); status.style.background='#f8d7da'; status.style.color='#721c24'; setTimeout(()=>status.remove(),5000); }).calculateChestParticipation(evt.eventName, evt.startDate, evt.endDate, evt.eventType);
      }
      function viewEventParticipation(eventName) {
        const evt = eventsData.find(e=>e.eventName===eventName); if (!evt) { alert('Event not found.'); return; }
        if (evt.participationMethod==='chest-based') { populateChestEventSelect(); switchTab('events'); switchTab('events'); switchTab('events'); EventsTab.switchTab('chestEventsTab'); document.getElementById('chestEventSelect').value = evt.eventName; selectedEvent=evt; currentParticipationEventName=evt.eventName; document.getElementById('chestEventActions').style.display='block'; loadChestParticipationData(evt.eventName); }
        else { populateManualEventSelect(); EventsTab.switchTab('manualEventsTab'); document.getElementById('manualEventSelect').value=evt.eventName; selectedEvent=evt; currentParticipationEventName=evt.eventName; populateMemberSelects(); loadManualParticipationData(evt.eventName); }
      }
      function submitCreateEvent() {
        const eventName = document.getElementById('eventName').value.trim();
        const eventType = document.getElementById('eventType').value;
        const startDate = document.getElementById('eventStartDate').value;
        const endDate = document.getElementById('eventEndDate').value;
        const status = document.getElementById('createStatus'); status.textContent=''; status.className='status';
        if (!eventName) { status.textContent='Please enter an event name.'; status.classList.add('err'); return; }
        if (!eventType) { status.textContent='Please select an event type.'; status.classList.add('err'); return; }
        if (!startDate || !endDate) { status.textContent='Please select start and end dates.'; status.classList.add('err'); return; }
        
        const isEditing = editingEventName !== null;
        status.textContent = isEditing ? 'Updating event...' : 'Creating event...';
        
        const onSuccess = (result) => {
          if (result && result.success) {
            status.textContent = result.message;
            status.classList.add('ok');
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = '';
            document.getElementById('eventStartDate').value = '';
            document.getElementById('eventEndDate').value = '';
            document.querySelector('button[onclick="EventsTab.submitCreateEvent()"]').textContent = 'üéØ Create Event';
            editingEventName = null;
            loadEvents();
          } else {
            status.textContent = result?.message || (isEditing ? 'Failed to update event.' : 'Failed to create event.');
            status.classList.add('err');
          }
        };
        
        const onError = (error) => {
          status.textContent = `Error: ${error.message}`;
          status.classList.add('err');
        };
        
        if (isEditing) {
          callFunction('updateEvent', [editingEventName, eventName, eventType, startDate, endDate])
            .then(onSuccess)
            .catch(onError);
        } else {
          callFunction('addEvent', [eventName, eventType, startDate, endDate])
            .then(onSuccess)
            .catch(onError);
        }
      }
      function onChestEventSelected() {
        const eventName = document.getElementById('chestEventSelect').value;
        if (!eventName) { document.getElementById('chestEventActions').style.display='none'; document.getElementById('chestParticipationData').style.display='none'; return; }
        selectedEvent = eventsData.find(e=>e.eventName===eventName); currentParticipationEventName=eventName; if (!selectedEvent) return; document.getElementById('chestEventActions').style.display='block'; loadChestParticipationData(eventName);
      }
      function onManualEventSelected() {
        const eventName = document.getElementById('manualEventSelect').value;
        if (!eventName) { document.getElementById('manualParticipationData').style.display='none'; return; }
        selectedEvent = eventsData.find(e=>e.eventName===eventName); currentParticipationEventName=eventName; if (!selectedEvent) return; populateMemberSelects(); loadManualParticipationData(eventName);
      }
      function calculateChestParticipation() {
        if (!selectedEvent) return; const status=document.getElementById('chestCalcStatus'); status.textContent='Calculating participation...'; status.className='status';
        google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { status.textContent=result.message; status.classList.add('ok'); loadChestParticipationData(selectedEvent.eventName); } else { status.textContent=result?.message||'Failed to calculate.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).calculateChestParticipation(selectedEvent.eventName, selectedEvent.startDate, selectedEvent.endDate, selectedEvent.eventType);
      }
      function calculateManualNonParticipants() {
        const status=document.getElementById('manualNonPartStatus'); status.textContent=''; status.className='status';
        if (!selectedEvent) { status.textContent='Please select a manual event first.'; status.classList.add('err'); return; }
        if (selectedEvent.participationMethod!=='manual-entry') { status.textContent='This action is only for manual-entry events.'; status.classList.add('err'); return; }
        status.textContent='Calculating non-participants...';
        google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { status.textContent=result.message; status.classList.add('ok'); loadManualParticipationData(selectedEvent.eventName); } else { status.textContent=result?.message||'Failed to calculate non-participants.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).calculateManualNonParticipants(selectedEvent.eventName);
      }
      function submitManualEntry() {
        const status=document.getElementById('manualEntryStatus'); status.textContent=''; status.className='status';
        if (!selectedEvent) { status.textContent='Please select an event first.'; status.classList.add('err'); return; }
        const memberName = document.getElementById('manualMember').value; const points = parseInt(document.getElementById('manualPoints').value)||0;
        if (!memberName) { status.textContent='Please select a member.'; status.classList.add('err'); return; }
        status.textContent='Saving...';
        google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { status.textContent=result.message; status.classList.add('ok'); document.getElementById('manualPoints').value=''; document.getElementById('manualMember').value=''; loadManualParticipationData(selectedEvent.eventName); } else { status.textContent=result?.message||'Failed to save.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).recordManualParticipation(selectedEvent.eventName, memberName, points, '', '');
      }
      function loadChestParticipationData(eventName) {
        const loadingIndicator=document.getElementById('chestLoadingIndicator');
        const participationDiv=document.getElementById('chestParticipationData');
        const thead=document.getElementById('chestParticipationTableHead');
        const tbody=document.getElementById('chestParticipationTableBody');
        participationDiv.style.display='block';
        thead.innerHTML='';
        tbody.innerHTML='';
        loadingIndicator.style.display='block';
        google.script.run.withSuccessHandler((result)=>{
          loadingIndicator.style.display='none';
          if (result && result.success && result.data && result.data.length>0) {
            renderChestParticipationData(result.data);
          } else {
            thead.innerHTML='';
            tbody.innerHTML='<tr><td colspan="4" style="text-align:center; padding:40px; color:#7f8c8d;"><div style="font-size:48px; margin-bottom:12px;">üìä</div><div style="font-size:16px; margin-bottom:8px;">No participation data yet</div><div style="font-size:13px;">Click "Calculate Participation" to generate data from chest records</div></td></tr>';
          }
        }).withFailureHandler((error)=>{
          loadingIndicator.style.display='none';
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:#c33;"><div style="font-size:16px; margin-bottom:8px;">Error loading data</div><div style="font-size:13px;">${escapeHtml(error.message||'Unknown error')}</div></td></tr>`;
        }).getEventParticipation(eventName);
      }
      function loadManualParticipationData(eventName) {
        const loadingIndicator=document.getElementById('manualLoadingIndicator');
        const participationDiv=document.getElementById('manualParticipationData');
        const thead=document.getElementById('manualParticipationTableHead');
        const tbody=document.getElementById('manualParticipationTableBody');
        participationDiv.style.display='block';
        thead.innerHTML='';
        tbody.innerHTML='';
        loadingIndicator.style.display='block';
        google.script.run.withSuccessHandler((result)=>{
          loadingIndicator.style.display='none';
          if (result && result.success && result.data && result.data.length>0) {
            renderManualParticipationData(result.data);
          } else {
            thead.innerHTML='';
            tbody.innerHTML='<tr><td colspan="4" style="text-align:center; padding:40px; color:#7f8c8d;"><div style="font-size:48px; margin-bottom:12px;">üìù</div><div style="font-size:16px; margin-bottom:8px;">No participation data yet</div><div style="font-size:13px;">Add participation entries using the form above</div></td></tr>';
          }
        }).withFailureHandler((error)=>{
          loadingIndicator.style.display='none';
          tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px; color:#c33;"><div style="font-size:16px; margin-bottom:8px;">Error loading data</div><div style="font-size:13px;">${escapeHtml(error.message||'Unknown error')}</div></td></tr>`;
        }).getEventParticipation(eventName);
      }
      function renderChestParticipationData(data) { participationRawData=data; currentSortColumn=null; currentSortDirection='asc'; applyChestFiltersAndSort(); }
      function calculateRankings(data) { const pointsMap=new Map(); data.forEach(p=>{ const pts=Number(p.value1??0); if(!pointsMap.has(pts)) pointsMap.set(pts,[]); pointsMap.get(pts).push(p.memberName); }); const rankMap=new Map(); let currentRank=1; Array.from(pointsMap.keys()).sort((a,b)=>b-a).forEach(pts=>{ const members=pointsMap.get(pts); members.forEach(name=>rankMap.set(name,currentRank)); currentRank+=members.length; }); return rankMap; }
      function renderManualParticipationData(data) {
        const thead=document.getElementById('manualParticipationTableHead'); const tbody=document.getElementById('manualParticipationTableBody'); participationRawData=data; const rankMap=calculateRankings(data); const sortedData=applyManualSorting(data);
        const getSortIndicator=(c)=>{ if (manualSortColumn!==c) return '‚áÖ'; return manualSortDirection==='asc'?'‚ñ≤':'‚ñº'; };
        
        // Get threshold from event type
        let threshold = 0;
        if (selectedEvent && selectedEvent.eventType) {
          const eventType = eventTypesData.find(et => et.name === selectedEvent.eventType);
          if (eventType) threshold = eventType.threshold || 0;
        }
        
        const participantCount = sortedData.filter(p=>Number(p.value1??0)>0).length;
        const nonParticipantCount = sortedData.filter(p=>{ const pts=Number(p.value1??0); const note=(p.value3||'').toString().toLowerCase(); return pts===0 && !note.includes('not applicable') && !note.includes('n/a'); }).length;
        const naCount = sortedData.filter(p=>{ const note=(p.value3||'').toString().toLowerCase(); return note.includes('not applicable')||note.includes('n/a'); }).length;
        const heading=document.getElementById('manualParticipationHeading'); const eventName=currentParticipationEventName||selectedEvent?.eventName||'';
        heading.innerHTML = `Participation Entries - ${escapeHtml(eventName)} <span style="font-size:13px; font-weight:normal; color:#5f6368;">(${participantCount} participated, ${nonParticipantCount} didn't, ${naCount} joined after)</span>`;
        thead.innerHTML = `<tr><th class="sortable rank-col" onclick="EventsTab.sortManualTable('rank')">Rank <span style="font-size:12px; opacity:0.7;">${getSortIndicator('rank')}</span></th><th class="sortable" onclick="EventsTab.sortManualTable('memberName')">Member Name <span style="font-size:12px; opacity:0.7;">${getSortIndicator('memberName')}</span></th><th class="sortable" onclick="EventsTab.sortManualTable('points')">Points <span style="font-size:12px; opacity:0.7;">${getSortIndicator('points')}</span></th><th class="sortable" onclick="EventsTab.sortManualTable('participated')">Participated <span style="font-size:12px; opacity:0.7;">${getSortIndicator('participated')}</span></th></tr>`;
        tbody.innerHTML='';
        sortedData.forEach(p=>{
          const pts=Number(p.value1??0); const rank=rankMap.get(p.memberName)||'-'; const note=(p.value3||'').toString().toLowerCase(); let status='No'; if (pts>0) status='Yes'; else if (note.includes('not applicable')||note.includes('n/a')) status='N/A';
          let icon;
          if (status==='Yes') {
            // Check threshold if enabled
            if (threshold > 0 && pts < threshold) {
              icon = '<span style="color:#ff9800; font-size:18px; font-weight:bold;">‚ö†</span>'; // Orange warning for below threshold
            } else {
              icon = '<span style="color:#34a853; font-size:18px; font-weight:bold;">‚úì</span>'; // Green checkmark
            }
          } else if (status==='N/A') {
            icon = '<span style="color:#9e9e9e; font-size:18px; font-weight:bold;">‚Äî</span>'; // Gray dash
          } else {
            icon = '<span style="color:#c5221f; font-size:18px; font-weight:bold;">‚úï</span>'; // Red X
          }
          const row=document.createElement('tr'); row.innerHTML = `<td class="rank-col">${rank}</td><td class="event-name">${escapeHtml(p.memberName)}</td><td>${pts.toLocaleString()}</td><td style="text-align:center;">${icon}</td>`; tbody.appendChild(row);
        });
      }
      function applyManualSorting(data) {
        const rankMap=calculateRankings(data); const sorted=[...data];
        sorted.sort((a,b)=>{
          let aVal,bVal; const getStatus=(p)=>{ const pts=Number(p.value1??0); const note=(p.value3||'').toString().toLowerCase(); if (pts>0) return 'Yes'; if (note.includes('not applicable')||note.includes('n/a')) return 'N/A'; return 'No'; };
          switch(manualSortColumn){
            case 'memberName': aVal=(a.memberName||'').toLowerCase(); bVal=(b.memberName||'').toLowerCase(); break;
            case 'points': aVal=Number(a.value1??0); bVal=Number(b.value1??0); break;
            case 'participated': aVal=getStatus(a); bVal=getStatus(b); break;
            case 'rank': aVal=rankMap.get(a.memberName)||999999; bVal=rankMap.get(b.memberName)||999999; break;
            default: return 0;
          }
          if (aVal<bVal) return manualSortDirection==='asc'?-1:1;
          if (aVal>bVal) return manualSortDirection==='asc'?1:-1;
          return 0;
        });
        return sorted;
      }
      function sortManualTable(column) {
        if (manualSortColumn===column) manualSortDirection = manualSortDirection==='asc'?'desc':'asc'; else { manualSortColumn=column; manualSortDirection = column==='points'?'desc':'asc'; }
        renderManualParticipationData(participationRawData);
      }
      function applyChestFiltersAndSort() {
        const thead=document.getElementById('chestParticipationTableHead'); const tbody=document.getElementById('chestParticipationTableBody'); const memberNameSet=new Set((membersData||[]).map(m=>(m.name||'').toLowerCase()));
        let filtered=[...participationRawData].filter(p=>{ if (!p||!p.memberName) return false; if (memberNameSet.size===0) return true; return memberNameSet.has(p.memberName.toLowerCase()); });
        if (currentSortColumn) {
          filtered.sort((a,b)=>{
            let aVal,bVal; switch(currentSortColumn){
              case 'memberName': aVal=(a.memberName||'').toLowerCase(); bVal=(b.memberName||'').toLowerCase(); return currentSortDirection==='asc'?aVal.localeCompare(bVal):bVal.localeCompare(aVal);
              case 'chestCount': aVal=a.value1??0; bVal=b.value1??0; return currentSortDirection==='asc'?aVal-bVal:bVal-aVal;
              case 'participated': const order={'Yes':1,'No':2,'N/A':3,'Not Applicable':3}; aVal=order[a.value3]||4; bVal=order[b.value3]||4; return currentSortDirection==='asc'?aVal-bVal:bVal-aVal;
              default: return 0;
            }
          });
        } else { filtered.sort((a,b)=>(a.memberName||'').localeCompare(b.memberName||'')); }
        const getSortIndicator=(c)=>{ if (currentSortColumn!==c) return '‚áÖ'; return currentSortDirection==='asc'?'‚ñ≤':'‚ñº'; };
        
        // Get threshold from event type
        let threshold = 0;
        if (selectedEvent && selectedEvent.eventType) {
          const eventType = eventTypesData.find(et => et.name === selectedEvent.eventType);
          if (eventType) threshold = eventType.threshold || 0;
        }
        
        const participantCount=filtered.filter(p=>p.value3==='Yes').length;
        const nonParticipantCount=filtered.filter(p=>p.value3==='No').length;
        const naCount=filtered.filter(p=>p.value3==='N/A'||p.value3==='Not Applicable').length;
        const heading=document.getElementById('chestParticipationHeading'); const eventName=currentParticipationEventName||selectedEvent?.eventName||'';
        heading.innerHTML = `Participation Results - ${escapeHtml(eventName)} <span style="font-size:13px; font-weight:normal; color:#5f6368;">(${participantCount} participated, ${nonParticipantCount} didn't, ${naCount} joined after)</span>`;
        thead.innerHTML = `<tr><th class="sortable" onclick="EventsTab.sortTable('memberName')">Member Name <span style="font-size:12px; opacity:0.7;">${getSortIndicator('memberName')}</span></th><th class="sortable" onclick="EventsTab.sortTable('chestCount')">Chest Count <span style="font-size:12px; opacity:0.7;">${getSortIndicator('chestCount')}</span></th><th class="sortable" onclick="EventsTab.sortTable('participated')">Participated <span style="font-size:12px; opacity:0.7;">${getSortIndicator('participated')}</span></th></tr>`;
        tbody.innerHTML='';
        filtered.forEach(p=>{
          let icon; 
          if (p.value3==='Yes') {
            // Check threshold if enabled
            if (threshold > 0 && (p.value1 ?? 0) < threshold) {
              icon='<span style="color:#ff9800; font-size:18px; font-weight:bold;">‚ö†</span>'; // Orange warning for below threshold
            } else {
              icon='<span style="color:#34a853; font-size:18px; font-weight:bold;">‚úì</span>'; // Green checkmark
            }
          } else if (p.value3==='N/A'||p.value3==='Not Applicable') {
            icon='<span style="color:#9e9e9e; font-size:18px; font-weight:bold;">‚Äî</span>'; // Gray dash
          } else {
            icon='<span style="color:#c5221f; font-size:18px; font-weight:bold;">‚úï</span>'; // Red X
          }
          const row=document.createElement('tr'); row.innerHTML=`<td class="event-name">${escapeHtml(p.memberName)}</td><td>${p.value1??0}</td><td style="text-align:center;">${icon}</td>`; tbody.appendChild(row);
        });
      }
      function sortTable(column) { if (currentSortColumn===column) currentSortDirection = currentSortDirection==='asc'?'desc':'asc'; else { currentSortColumn=column; currentSortDirection='asc'; } applyChestFiltersAndSort(); document.querySelectorAll('#events .sortable').forEach(th=>th.classList.remove('asc','desc')); const clicked=Array.from(document.querySelectorAll('#events .sortable')).find(th=>th.getAttribute('onclick')?.includes(column)); if (clicked) clicked.classList.add(currentSortDirection); }
      function deleteEvent(eventName) { if (!confirm(`Are you sure you want to delete "${eventName}"?`)) return; google.script.run.withSuccessHandler((result)=>{ if (result && result.success) loadEvents(); else alert(result?.message||'Failed to delete event.'); }).withFailureHandler((error)=>alert(`Error: ${error.message}`)).deleteEvent(eventName); }
      function recalculateAllChestEvents() { if (!confirm('This will recalculate participation for all chest-based events from the ChestData sheet. Continue?')) return; const status=document.createElement('div'); status.className='status'; status.textContent='‚è≥ Recalculating all chest-based events...'; status.style.cssText='position:fixed; top:20px; right:20px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1000; min-width:300px;'; document.body.appendChild(status); google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { status.textContent='‚úì '+result.message; status.classList.add('ok'); status.style.background='#d4edda'; status.style.color='#155724'; loadEvents(); setTimeout(()=>status.remove(),5000); } else { status.textContent='‚úï '+(result?.message||'Failed to recalc.'); status.classList.add('err'); status.style.background='#f8d7da'; status.style.color='#721c24'; setTimeout(()=>status.remove(),5000); } }).withFailureHandler((error)=>{ status.textContent=`‚úï Error: ${error.message}`; status.classList.add('err'); status.style.background='#f8d7da'; status.style.color='#721c24'; setTimeout(()=>status.remove(),5000); }).recalculateAllChestEvents(); }
      function loadChestTypes() { google.script.run.withSuccessHandler((result)=>{ const norm=normalizeResponse(result); if (norm.success) { availableChestTypes=norm.chestTypes||norm.data||[]; renderChestTypesList(); } else { console.error('Failed to load chest types:', norm.error); } }).withFailureHandler((error)=>console.error('Failed to load chest types:',error)).getAvailableChestTypes(); }
      function renderChestTypesList() { const container=document.getElementById('chestTypesList'); if (!availableChestTypes || availableChestTypes.length===0) { container.innerHTML='<div style="padding:12px; color:#5f6368;">No chest types found</div>'; return; } container.innerHTML = availableChestTypes.map((type,index)=>`<div class="checkbox-item"><input type="checkbox" id="chest_${index}" value="${escapeHtml(type)}"><label for="chest_${index}">${escapeHtml(type)}</label></div>`).join(''); }
      function getSelectedChestTypes() { const checkboxes=document.querySelectorAll('#chestTypesList input[type="checkbox"]:checked'); return Array.from(checkboxes).map(cb=>cb.value); }
      function setSelectedChestTypes(typesCsv) { const types=(typesCsv||'').split(',').map(t=>t.trim()).filter(Boolean); document.querySelectorAll('#chestTypesList input[type="checkbox"]').forEach(cb=>{ cb.checked = types.includes(cb.value); }); }
      function submitAddEventType() {
        const typeName=document.getElementById('newEventTypeName').value.trim(); 
        const method=document.getElementById('newEventTypeMethod').value; 
        const description=document.getElementById('newEventTypeDesc').value.trim(); 
        const threshold=Number(document.getElementById('newEventTypeThreshold').value) || 0; 
        const status=document.getElementById('addTypeStatus'); 
        status.textContent=''; 
        status.className='status';
        
        if (!typeName) { status.textContent='Please enter an event type name.'; status.classList.add('err'); return; }
        if (!method) { status.textContent='Please select a tracking method.'; status.classList.add('err'); return; }
        
        let selectedChestTypes = '';
        let troopTargets = '';
        
        if (method==='chest-based') {
          selectedChestTypes = getSelectedChestTypes().join(',');
        } else if (method==='troop-based') {
          troopTargets = getTroopTargets();
          if (!troopTargets) {
            status.textContent='Please set at least one G level target.';
            status.classList.add('err');
            return;
          }
        }
        
        status.textContent = editingTypeOriginalName ? 'Updating event type...' : 'Adding event type...';
        
        const onSuccess=(result)=>{ 
          if (result && result.success) { 
            status.textContent=result.message; 
            status.classList.add('ok'); 
            resetEventTypeForm(); 
            loadEventTypes(); 
            renderEventTypesTable(); 
          } else { 
            status.textContent=result?.message||'Failed to save event type.'; 
            status.classList.add('err'); 
          } 
        };
        
        const onFailure=(error)=>{ 
          status.textContent=`Error: ${error.message}`; 
          status.classList.add('err'); 
        };
        
        if (editingTypeOriginalName) { 
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .updateEventType(editingTypeOriginalName, typeName, method, selectedChestTypes, description, threshold, troopTargets); 
        } else { 
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .addEventType(typeName, method, selectedChestTypes, description, threshold, troopTargets); 
        }
      }
      
      function getTroopTargets() {
        const rows = document.querySelectorAll('#troopTargetsList .troop-target-row');
        const targets = {};
        
        rows.forEach(row => {
          const level = row.querySelector('select').value;
          const points = row.querySelector('input[type="number"]').value;
          
          if (level && points) {
            targets[level] = parseInt(points);
          }
        });
        
        if (Object.keys(targets).length === 0) {
          return '';
        }
        
        return JSON.stringify(targets);
      }
      
      function setTroopTargets(targetsJson) {
        console.log('[setTroopTargets] Called with:', targetsJson);
        const container = document.getElementById('troopTargetsList');
        
        if (!container) {
          console.error('[setTroopTargets] Container not found');
          return;
        }
        
        container.innerHTML = '';
        
        if (!targetsJson) {
          console.log('[setTroopTargets] No targets to load');
          return;
        }
        
        try {
          const targets = JSON.parse(targetsJson);
          console.log('[setTroopTargets] Parsed targets:', targets);
          Object.entries(targets).forEach(([level, points]) => {
            console.log('[setTroopTargets] Adding row for level', level, 'with points', points);
            addTroopTargetRow(level, points);
          });
        } catch (e) {
          console.error('[setTroopTargets] Failed to parse troop targets:', e, 'Input:', targetsJson);
        }
      }
      
      function addTroopTargetRow(level = '', points = '') {
        const container = document.getElementById('troopTargetsList');
        if (!container) return;
        
        const rowId = 'troop-target-' + Date.now();
        const row = document.createElement('div');
        row.className = 'troop-target-row';
        row.id = rowId;
        row.style.cssText = 'display:grid; grid-template-columns:1fr 2fr auto; gap:8px; margin-bottom:8px; align-items:center;';
        
        row.innerHTML = `
          <select style="padding:6px; border:1px solid #dadce0; border-radius:4px; font-size:13px;">
            <option value="">-- Select Level --</option>
            <option value="1" ${level === '1' || level === 1 ? 'selected' : ''}>Level 1</option>
            <option value="2" ${level === '2' || level === 2 ? 'selected' : ''}>Level 2</option>
            <option value="3" ${level === '3' || level === 3 ? 'selected' : ''}>Level 3</option>
            <option value="4" ${level === '4' || level === 4 ? 'selected' : ''}>Level 4</option>
            <option value="5" ${level === '5' || level === 5 ? 'selected' : ''}>Level 5</option>
            <option value="6" ${level === '6' || level === 6 ? 'selected' : ''}>Level 6</option>
            <option value="7" ${level === '7' || level === 7 ? 'selected' : ''}>Level 7</option>
            <option value="8" ${level === '8' || level === 8 ? 'selected' : ''}>Level 8</option>
            <option value="9" ${level === '9' || level === 9 ? 'selected' : ''}>Level 9</option>
          </select>
          <input type="number" placeholder="Target points" value="${points}" style="padding:6px; border:1px solid #dadce0; border-radius:4px; font-size:13px;" min="0" step="1">
          <button type="button" class="btn btn-secondary" style="padding:4px 8px; font-size:12px;" onclick="EventsTab.removeTroopTargetRow('${rowId}')">‚úñ Remove</button>
        `;
        
        container.appendChild(row);
      }
      
      function removeTroopTargetRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
          row.remove();
        }
      }
      function updateEventTypeMethod() { 
        const method=document.getElementById('newEventTypeMethod').value; 
        const chestSection=document.getElementById('chestTypeSection'); 
        const troopSection=document.getElementById('troopTargetSection');
        if (method==='chest-based') {
          chestSection.style.display='block';
          troopSection.style.display='none';
        } else if (method==='troop-based') {
          chestSection.style.display='none';
          troopSection.style.display='block';
        } else {
          chestSection.style.display='none';
          troopSection.style.display='none';
        }
      }
      function editEventType(eventTypeName) { 
        const status=document.getElementById('addTypeStatus'); 
        status.textContent=''; 
        status.className='status'; 
        const eventType=eventTypesData.find(et=>et.name===eventTypeName); 
        if (!eventType) { 
          status.textContent='Unable to find that event type for editing.'; 
          status.classList.add('err'); 
          return; 
        } 
        console.log('[editEventType] Editing:', eventType);
        editingTypeOriginalName=eventTypeName; 
        document.getElementById('newEventTypeName').value=eventType.name||''; 
        document.getElementById('newEventTypeMethod').value=eventType.trackingMethod||''; 
        document.getElementById('newEventTypeDesc').value=eventType.description||''; 
        document.getElementById('newEventTypeThreshold').value=eventType.threshold||0; 
        document.getElementById('saveEventTypeBtn').textContent='üíæ Save Event Type'; 
        document.getElementById('cancelEditTypeBtn').style.display='inline-block'; 
        updateEventTypeMethod(); 
        if (eventType.trackingMethod==='chest-based') {
          setSelectedChestTypes(eventType.chestTypes);
        } else if (eventType.trackingMethod==='troop-based') {
          console.log('[editEventType] Loading troop targets:', eventType.troopTargets);
          // Small delay to ensure the section is visible
          setTimeout(() => {
            setTroopTargets(eventType.troopTargets);
          }, 50);
        }
        status.textContent=`Editing "${eventType.name}"...`; 
      }
      function cancelEditEventType() { resetEventTypeForm(); const status=document.getElementById('addTypeStatus'); status.textContent='Edit canceled.'; status.className='status'; }
      function resetEventTypeForm() { 
        editingTypeOriginalName=null; 
        document.getElementById('newEventTypeName').value=''; 
        document.getElementById('newEventTypeMethod').value=''; 
        document.getElementById('newEventTypeDesc').value=''; 
        document.getElementById('newEventTypeThreshold').value='0'; 
        document.getElementById('saveEventTypeBtn').textContent='‚ûï Add Event Type'; 
        document.getElementById('cancelEditTypeBtn').style.display='none'; 
        setSelectedChestTypes(''); 
        setTroopTargets('');
        updateEventTypeMethod(); 
      }
      function loadEventTypes() { 
        document.getElementById('typesLoading').style.display='block'; 
        document.getElementById('eventTypesTable').style.display='none'; 
        document.getElementById('typesEmpty').style.display='none';
        google.script.run.withSuccessHandler((result)=>{ 
          console.log('[DEBUG] loadEventTypes result:', result, 'type:', typeof result); 
          const norm=normalizeResponse(result); 
          if (norm.success) { 
            const data=norm.eventTypes||norm.data||[]; 
            eventTypesData=Array.isArray(data)?data:[]; 
            console.log('[DEBUG] loadEventTypes - set eventTypesData to:', eventTypesData); 
            populateEventTypeDropdown();
            renderEventTypesTable();
          } else { 
            console.error('Unexpected result format for getAllEventTypes'); 
            document.getElementById('typesLoading').innerHTML='<p style="color:#c33;">Error loading event types.</p>';
          } 
        }).withFailureHandler((error)=>{
          console.error('Failed to load event types:',error);
          document.getElementById('typesLoading').innerHTML='<p style="color:#c33;">Error loading event types.</p>';
        }).getAllEventTypes(); 
      }
      function populateEventTypeDropdown() { const select=document.getElementById('eventType'); const currentValue=select.value; console.log('[DEBUG] populateEventTypeDropdown - eventTypesData:', eventTypesData); if (!eventTypesData || !Array.isArray(eventTypesData)) { console.error('eventTypesData is not an array:', eventTypesData); eventTypesData=[]; } const options=['<option value="">-- Select Event Type --</option>'].concat(eventTypesData.map(et=>`<option value="${escapeHtml(et.name)}">${escapeHtml(et.name)}</option>`)); select.innerHTML=options.join(''); if (currentValue && eventTypesData.some(et=>et.name===currentValue)) select.value=currentValue; }
      function renderEventTypesTable() {
        // Render the table from eventTypesData (which should already be populated by loadEventTypes)
        console.log('[DEBUG] renderEventTypesTable: rendering from eventTypesData:', eventTypesData);
        document.getElementById('typesLoading').style.display='none'; 
        if (!Array.isArray(eventTypesData) || eventTypesData.length===0) { 
          document.getElementById('typesEmpty').style.display='block'; 
          document.getElementById('eventTypesTable').style.display='none';
          return; 
        } 
        const tbody=document.getElementById('eventTypesTableBody'); 
        tbody.innerHTML=''; 
        eventTypesData.forEach(eventType=>{ 
          const methodBadge=eventType.trackingMethod==='chest-based'?'<span class="badge chest">Chest-Based</span>':'<span class="badge manual">Manual Entry</span>'; 
          const chestTypesDisplay=eventType.chestTypes?escapeHtml(eventType.chestTypes):'<em style="color:#7f8c8d;">All chests</em>'; 
          const thresholdDisplay=(eventType.threshold && eventType.threshold > 0) ? eventType.threshold : '<em style="color:#9e9e9e;">‚Äî</em>'; 
          const row=document.createElement('tr'); 
          row.innerHTML=`<td class="event-name">${escapeHtml(eventType.name)}</td><td>${methodBadge}</td><td>${chestTypesDisplay}</td><td>${escapeHtml(eventType.description)}</td><td style="text-align:center;">${thresholdDisplay}</td><td><button class="btn action-btn" data-action="edit-type" data-type-name="${escapeHtml(eventType.name)}">‚úèÔ∏è Edit</button><button class="btn action-btn btn-secondary" data-action="delete-type" data-type-name="${escapeHtml(eventType.name)}">üóëÔ∏è Delete</button></td>`; 
          tbody.appendChild(row); 
        }); 
        tbody.querySelectorAll('button[data-action]').forEach(btn=>btn.addEventListener('click',function(){ 
          const action=this.getAttribute('data-action'); 
          const typeName=this.getAttribute('data-type-name'); 
          if (action==='edit-type') editEventType(typeName); 
          else if (action==='delete-type') deleteEventTypeConfirm(typeName); 
        })); 
        document.getElementById('eventTypesTable').style.display='table';
        console.log('[DEBUG] renderEventTypesTable: table rendered with', eventTypesData.length, 'items');
      }
      function deleteEventTypeConfirm(eventTypeName) { if (!confirm(`Are you sure you want to delete event type "${eventTypeName}"?\n\nThis will fail if any events are using this type.`)) return; google.script.run.withSuccessHandler((result)=>{ if (result && result.success) { alert(result.message); loadEventTypes(); renderEventTypesTable(); } else { alert(result?.message||'Failed to delete event type.'); } }).withFailureHandler((error)=>alert(`Error: ${error.message}`)).deleteEventType(eventTypeName); }
      function escapeHtml(text) { if (!text) return ''; const div=document.createElement('div'); div.textContent=text; return div.innerHTML; }
      function sortTableProxy(column){ sortTable(column); }
      return { init, switchTab, loadEvents, recalculateAllChestEvents, calculateChestParticipation, onChestEventSelected, onManualEventSelected, submitManualEntry, calculateManualNonParticipants, submitCreateEvent, sortTable: sortTableProxy, sortManualTable, updateEventTypeMethod, submitAddEventType, renderEventTypesTable, cancelEditEventType, addTroopTargetRow, removeTroopTargetRow };
    })();

    // Members Tab
    const MembersTab = (() => {
      let membersData=[]; let filteredData=[]; let currentSort={column:null,direction:'asc'};
      function init() {
        loadMembers(); setTodayDefault();
        document.getElementById('memberSearchInput').addEventListener('input',(e)=>filterMembers(e.target.value));
        document.querySelectorAll('#members th.sortable').forEach(th=>{ th.addEventListener('click',()=>sortTable(th.dataset.column)); });
      }
      function loadMembers() { console.log('[MembersTab.loadMembers] START'); showLoading(); google.script.run.withSuccessHandler(onMembersLoaded).withFailureHandler(onError).getMembersListWithProgress(); }
      function onMembersLoaded(data) {
        const result = normalizeResponse(data);
        console.log('[MembersTab.onMembersLoaded] Normalized data:', result);
        if (!result.success) { onError({message: result.error}); return; }
        const membersList = result.data || [];
        console.log('[MembersTab.onMembersLoaded] Members count:', membersList.length);
        membersData=membersList; filteredData=[...membersData]; filteredData.sort((a,b)=>{
          const aRecent = a.recentGrowthPercent||0;
          const bRecent = b.recentGrowthPercent||0;
          return bRecent - aRecent;
        }); currentSort={column:'recentGrowth',direction:'desc'}; populateMemberSelect(); if (membersData.length===0) { console.log('[MembersTab.onMembersLoaded] No members, showing empty'); showEmpty(); return; } console.log('[MembersTab.onMembersLoaded] Calling updateStats and renderTable'); updateStats(); renderTable(); const recentGrowthHeader=document.querySelector('#members th[data-column="recentGrowth"]'); if (recentGrowthHeader) recentGrowthHeader.classList.add('sorted-desc'); showTable();
      }
      function onError(error) { console.error('Error loading members:',error); document.getElementById('memberError').textContent='Error loading members: '+error.message; document.getElementById('memberError').style.display='block'; document.getElementById('memberLoading').style.display='none'; }
      function updateStats() { const total=membersData.length; const totalMight=membersData.reduce((sum,m)=>sum+(m.startMight||0),0); const avg=total>0?Math.round(totalMight/total):0; document.getElementById('memberTotal').textContent=total.toLocaleString(); document.getElementById('memberTotalMight').textContent=formatMight(totalMight); document.getElementById('memberAverageMight').textContent=formatMight(avg); }
      function filterMembers(searchTerm) { const term=searchTerm.toLowerCase().trim(); filteredData = term ? membersData.filter(m=>m.name.toLowerCase().includes(term)) : [...membersData]; renderTable(); if (filteredData.length===0) showEmpty(); else showTable(); }
      function sortTable(column) { if (currentSort.column===column) currentSort.direction = currentSort.direction==='asc'?'desc':'asc'; else { currentSort.column=column; currentSort.direction='asc'; }
        filteredData.sort((a,b)=>{ let aVal,bVal; switch(column){ case 'name': aVal=a.name.toLowerCase(); bVal=b.name.toLowerCase(); break; case 'joinDate': aVal=new Date(a.joinDate); bVal=new Date(b.joinDate); break; case 'startMight': aVal=a.startMight||0; bVal=b.startMight||0; break; case 'latestMight': aVal=a.latestMight||0; bVal=b.latestMight||0; break; case 'latestMightDate': aVal=a.latestMightDate?new Date(a.latestMightDate):new Date(0); bVal=b.latestMightDate?new Date(b.latestMightDate):new Date(0); break; case 'growth': aVal=(a.startMight&&a.latestMight&&a.startMight>0)?((a.latestMight-a.startMight)/a.startMight)*100:-Infinity; bVal=(b.startMight&&b.latestMight&&b.startMight>0)?((b.latestMight-b.startMight)/b.startMight)*100:-Infinity; break; case 'recentGrowth': aVal=a.recentGrowthPercent||0; bVal=b.recentGrowthPercent||0; break; default: aVal=0; bVal=0; }
          if (aVal<bVal) return currentSort.direction==='asc'?-1:1; if (aVal>bVal) return currentSort.direction==='asc'?1:-1; return 0; });
        document.querySelectorAll('#members th.sortable').forEach(th=>th.classList.remove('sorted-asc','sorted-desc')); const currentTh=document.querySelector(`#members th[data-column="${column}"]`); if (currentTh) currentTh.classList.add(`sorted-${currentSort.direction}`); renderTable(); }
      function renderTable() {
        const tbody=document.getElementById('membersTableBody'); tbody.innerHTML='';
        filteredData.forEach(member=>{
          let growthPercent='-'; if (member.startMight && member.latestMight && member.startMight>0) { const g=((member.latestMight-member.startMight)/member.startMight)*100; growthPercent=g.toFixed(1)+'%'; }
          let recentGrowthPercent='-'; if (member.recentGrowthPercent!==undefined && member.recentGrowthPercent!==null) { recentGrowthPercent=(member.recentGrowthPercent).toFixed(1)+'%'; }
          const row=document.createElement('tr'); row.innerHTML=`<td class="member-name">${escapeHtml(member.name)}</td><td class="might-value">${formatMight(member.startMight)}</td><td class="date-value">${formatDate(member.joinDate)}</td><td class="might-value">${growthPercent}</td><td class="might-value">${formatMight(member.latestMight)}</td><td class="date-value">${formatDate(member.latestMightDate)}</td><td class="might-value">${recentGrowthPercent}</td>`; tbody.appendChild(row);
        });
      }
      function populateMemberSelect() {
        const select=document.getElementById('mightMemberSelect'); const oldSelect=document.getElementById('oldMemberSelect'); const removeSelect=document.getElementById('removeMemberSelect');
        if (!membersData || membersData.length===0) { const empty='<option value="">-- No members --</option>'; [select,oldSelect,removeSelect].forEach(sel=>{ if (sel) sel.innerHTML=empty; }); return; }
        const sorted=[...membersData].sort((a,b)=>a.name.localeCompare(b.name)); const options=['<option value="">-- Select member --</option>'].concat(sorted.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`)).join(''); [select,oldSelect,removeSelect].forEach(sel=>{ if (sel) sel.innerHTML=options; });
      }
      function setTodayDefault() { const today=new Date().toISOString().split('T')[0]; ['mightDate','joinDate','endDate'].forEach(id=>{ const el=document.getElementById(id); if (el) el.value=today; }); }
      function submitMightEntry() {
        const member=document.getElementById('mightMemberSelect').value; const date=document.getElementById('mightDate').value; const mightRaw=document.getElementById('mightValue').value; const status=document.getElementById('mightStatus'); status.textContent=''; status.className='status';
        if (!member) { status.textContent='Please select a member.'; status.classList.add('err'); return; }
        if (!date) { status.textContent='Please choose a date.'; status.classList.add('err'); return; }
        const might=parseInt(mightRaw,10); if (isNaN(might)||might<=0) { status.textContent='Enter a valid might value (>0).'; status.classList.add('err'); return; }
        status.textContent='Saving...';
        google.script.run.withSuccessHandler((result)=>{ if (result&&result.success) { status.textContent=`Saved ${member} at ${formatMight(might)} for ${formatDate(date)}.`; status.classList.add('ok'); document.getElementById('mightValue').value=''; setTimeout(loadMembers,500); } else { status.textContent=result?.message||'Failed to save might.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).recordMemberMight(member,date,might);
      }
      function submitAddMember() {
        const name=document.getElementById('newMemberNameInput').value.trim(); const joinDate=document.getElementById('joinDate').value; const startMightRaw=document.getElementById('startMight').value; const status=document.getElementById('addMemberStatus'); status.textContent=''; status.className='status';
        if (!name) { status.textContent='Please enter a member name.'; status.classList.add('err'); return; }
        if (!joinDate) { status.textContent='Please select a join date.'; status.classList.add('err'); return; }
        const startMight=parseInt(startMightRaw,10); if (isNaN(startMight)||startMight<=0) { status.textContent='Enter a valid starting might (>0).'; status.classList.add('err'); return; }
        status.textContent='Adding member...';
        google.script.run.withSuccessHandler((result)=>{ if (result&&result.success) { status.textContent=`Successfully added "${name}" with ${formatMight(startMight)} might.`; status.classList.add('ok'); document.getElementById('newMemberNameInput').value=''; document.getElementById('startMight').value=''; setTimeout(loadMembers,800); } else { status.textContent=result?.message||'Failed to add member.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).addMember(name,joinDate,startMight);
      }
      function submitNameChange() {
        const oldName=document.getElementById('oldMemberSelect').value; const newName=document.getElementById('newMemberName').value.trim(); const status=document.getElementById('nameChangeStatus'); status.textContent=''; status.className='status';
        if (!oldName) { status.textContent='Please select a member.'; status.classList.add('err'); return; }
        if (!newName) { status.textContent='Please enter a new name.'; status.classList.add('err'); return; }
        if (oldName===newName) { status.textContent='New name is the same as old name.'; status.classList.add('err'); return; }
        status.textContent='Updating name across all sheets...';
        google.script.run.withSuccessHandler((result)=>{ if (result&&result.success) { status.textContent=result.message||`Successfully updated "${oldName}" to "${newName}".`; status.classList.add('ok'); document.getElementById('newMemberName').value=''; setTimeout(loadMembers,800); } else { status.textContent=result?.message||'Failed to update name.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).updateMemberName(oldName,newName);
      }
      function submitRemoveMember() {
        const memberName=document.getElementById('removeMemberSelect').value; const endDate=document.getElementById('endDate').value; const status=document.getElementById('removeMemberStatus'); status.textContent=''; status.className='status';
        if (!memberName) { status.textContent='Please select a member.'; status.classList.add('err'); return; }
        if (!endDate) { status.textContent='Please select an end date.'; status.classList.add('err'); return; }
        status.textContent='Removing member...';
        google.script.run.withSuccessHandler((result)=>{ if (result&&result.success) { status.textContent=result.message||`Successfully removed "${memberName}".`; status.classList.add('ok'); setTimeout(loadMembers,800); } else { status.textContent=result?.message||'Failed to remove member.'; status.classList.add('err'); } }).withFailureHandler((error)=>{ status.textContent=`Error: ${error.message}`; status.classList.add('err'); }).disableMember(memberName,endDate);
      }
      function switchTab(tabId, evt) { document.querySelectorAll('#members .tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('#members .tab').forEach(t=>t.classList.remove('active')); document.getElementById(tabId)?.classList.add('active'); if (evt&&evt.target) evt.target.classList.add('active'); }
      function formatMight(might) { if (!might||might===0) return '-'; return might.toLocaleString(); }
      function formatDate(dateStr) { if (!dateStr) return '-'; try { const date=new Date(dateStr); return date.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}); } catch(e){ return dateStr; } }
      function escapeHtml(text) { const div=document.createElement('div'); div.textContent=text; return div.innerHTML; }
      function showLoading() { document.getElementById('memberLoading').style.display='block'; document.getElementById('memberError').style.display='none'; document.getElementById('membersTable').style.display='none'; document.getElementById('memberEmpty').style.display='none'; }
      function showTable() { document.getElementById('memberLoading').style.display='none'; document.getElementById('memberError').style.display='none'; document.getElementById('membersTable').style.display='table'; document.getElementById('memberEmpty').style.display='none'; }
      function showEmpty() { document.getElementById('memberLoading').style.display='none'; document.getElementById('memberError').style.display='none'; document.getElementById('membersTable').style.display='none'; document.getElementById('memberEmpty').style.display='block'; }
      return { init, loadMembers, switchTab, submitMightEntry, submitAddMember, submitNameChange, submitRemoveMember };
    })();

    // Troops Tab
    const TroopsTab = (() => {
      let summaryData = [];
      let currentSort = { column: 'playerName', direction: 'asc' };

      function init() {
        setupSummarySorting();
        loadTroopSummary();
        // Delay loading to ensure google.script.run is ready
        setTimeout(() => {
          loadPlayerList();
          loadPlayerHistoryList();
        }, 100);
        switchSubTab('entry');
      }

      function switchSubTab(tabName, evt) {
        document.querySelectorAll('#troops .tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('#troops .tab').forEach(btn => btn.classList.remove('active'));
        const contentId = 'troop' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
        document.getElementById(contentId)?.classList.add('active');
        if (evt && evt.target) {
          evt.target.classList.add('active');
        } else {
          const buttons = document.querySelectorAll('#troops .tab');
          if (tabName === 'entry' && buttons[0]) buttons[0].classList.add('active');
          if (tabName === 'player' && buttons[1]) buttons[1].classList.add('active');
        }
      }

      function setupSummarySorting() {
        const headers = document.querySelectorAll('#troopMembersTable thead th[data-column]');
        headers.forEach(header => {
          header.addEventListener('click', () => {
            sortSummaryBy(header.dataset.column);
          });
        });
        const defaultHeader = document.querySelector('#troopMembersTable thead th[data-column="playerName"]');
        if (defaultHeader) defaultHeader.classList.add('asc');
      }

      function sortSummaryBy(column) {
        if (!column) return;
        if (currentSort.column === column) {
          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort = { column, direction: column === 'playerName' ? 'asc' : 'desc' };
        }

        document.querySelectorAll('#troopMembersTable thead th.sortable').forEach(th => {
          th.classList.remove('asc', 'desc');
        });
        const active = document.querySelector(`#troopMembersTable thead th[data-column="${column}"]`);
        if (active) active.classList.add(currentSort.direction);

        renderTroopSummary();
      }

      function getSortValue(member, column) {
        if (column === 'playerName') return (member.playerName || '').toLowerCase();
        if (column && column.endsWith('Date')) {
          const value = member[column];
          if (!value) return null;
          const date = new Date(value);
          return isNaN(date.getTime()) ? null : date.getTime();
        }
        const value = member[column];
        return value === null || value === undefined ? null : Number(value);
      }

      function renderTroopSummary() {
        const tableDiv = document.getElementById('troopMembersTable');
        const tbody = document.getElementById('troopMembersTableBody');
        if (!tableDiv || !tbody || !Array.isArray(summaryData)) return;

        const sorted = summaryData.slice().sort((a, b) => {
          const aVal = getSortValue(a, currentSort.column);
          const bVal = getSortValue(b, currentSort.column);

          if (aVal === null && bVal === null) return 0;
          if (aVal === null) return 1;
          if (bVal === null) return -1;

          let result = 0;
          if (currentSort.column === 'playerName') {
            result = aVal.localeCompare(bVal);
          } else {
            result = aVal - bVal;
          }

          return currentSort.direction === 'asc' ? result : -result;
        });

        const types = ['G', 'M', 'S', 'E', 'C'];

        tbody.innerHTML = '';
        sorted.forEach(member => {
          const row = document.createElement('tr');

          const nameCell = document.createElement('td');
          nameCell.style.fontWeight = '500';
          nameCell.textContent = member.playerName;
          row.appendChild(nameCell);

          types.forEach(type => {
            // Level cell
            const levelCell = document.createElement('td');
            const isCryptType = type === 'C';
            levelCell.className = isCryptType ? 'center crypt-col' : 'center';
            levelCell.style.fontWeight = '600';

            const currentLevelKey = `${type}_currentLevel`;
            const startLevelKey = `${type}_startLevel`;
            const currentLevel = member[currentLevelKey];
            const startLevel = member[startLevelKey];

            if (currentLevel !== null && currentLevel !== undefined) {
              levelCell.textContent = currentLevel;
              // Blue if no change, purple if updated
              if (currentLevel !== startLevel) {
                levelCell.style.color = '#7b1fa2'; // Purple for updated
              } else {
                levelCell.style.color = '#1a73e8'; // Blue for unchanged
              }
            } else {
              levelCell.textContent = '‚àí';
              levelCell.style.color = '#dadce0';
              levelCell.style.fontWeight = '400';
            }
            row.appendChild(levelCell);

            // Date cell
            const dateCell = document.createElement('td');
            dateCell.className = isCryptType ? 'center crypt-col' : 'center';
            dateCell.style.fontSize = '12px';

            const currentDateKey = `${type}_currentDate`;
            const currentDate = member[currentDateKey];

            if (currentDate !== null && currentDate !== undefined) {
              dateCell.textContent = formatSummaryDate(currentDate);
              // Apply same color as level cell
              if (currentLevel !== startLevel) {
                dateCell.style.color = '#7b1fa2'; // Purple for updated
              } else {
                dateCell.style.color = '#1a73e8'; // Blue for unchanged
              }
            } else {
              dateCell.textContent = '‚àí';
              dateCell.style.color = '#dadce0';
            }
            row.appendChild(dateCell);
          });

          tbody.appendChild(row);
        });

        tableDiv.style.display = 'table';
      }

      function formatSummaryDate(value) {
        try {
          const date = new Date(value);
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (error) {
          return '-';
        }
      }

      function loadPlayerList() {
        console.log('[TroopsTab.loadPlayerList] START');
        google.script.run
          .withSuccessHandler(members => {
            console.log('[TroopsTab.loadPlayerList] Data received:', members);
            const select = document.getElementById('troopPlayerName');
            select.innerHTML = '<option value="">-- Select Player --</option>';
            if (!Array.isArray(members)) {
              console.error('[TroopsTab.loadPlayerList] Members is not an array:', typeof members, members);
              select.innerHTML = '<option value="">-- Error: Invalid response --</option>';
              return;
            }
            members.forEach(member => {
              const name = (member && typeof member === 'object') ? (member.name || member.playerName || String(member)) : String(member);
              const option = document.createElement('option');
              option.value = name;
              option.textContent = name;
              select.appendChild(option);
            });
            console.log('[TroopsTab.loadPlayerList] Populated ' + members.length + ' members');
          })
          .withFailureHandler(error => {
            console.error('[TroopsTab.loadPlayerList] API ERROR:', error);
            const select = document.getElementById('troopPlayerName');
            select.innerHTML = '<option value="">-- Error loading members --</option>';
          })
          .getTroopMembersForForm();
      }

      function loadPlayerHistoryList() {
        console.log('[TroopsTab.loadPlayerHistoryList] START');
        google.script.run
          .withSuccessHandler(members => {
            console.log('[TroopsTab.loadPlayerHistoryList] Data received:', members);
            const select = document.getElementById('troopHistoryPlayerSelect');
            select.innerHTML = '<option value="">-- Select Player --</option>';
            if (!Array.isArray(members)) {
              console.error('[TroopsTab.loadPlayerHistoryList] Members is not an array:', typeof members, members);
              select.innerHTML = '<option value="">-- Error: Invalid response --</option>';
              return;
            }
            members.forEach(member => {
              const name = (member && typeof member === 'object') ? (member.name || member.playerName || String(member)) : String(member);
              const option = document.createElement('option');
              option.value = name;
              option.textContent = name;
              select.appendChild(option);
            });
            console.log('[TroopsTab.loadPlayerHistoryList] Populated ' + members.length + ' members');
          })
          .withFailureHandler(error => {
            console.error('[TroopsTab.loadPlayerHistoryList] API ERROR:', error);
            const select = document.getElementById('troopHistoryPlayerSelect');
            select.innerHTML = '<option value="">-- Error loading members --</option>';
          })
          .getTroopMembersForForm();
      }

      function showStatus(message, type) {
        const el = document.getElementById('troopEntryMessage');
        el.textContent = message;
        el.className = 'status ' + type;
        if (type === 'ok') {
          setTimeout(() => { el.className = 'status'; }, 4000);
        }
      }

      function submitTroopEntry() {
        const playerName = document.getElementById('troopPlayerName').value;
        const troopType = document.getElementById('troopType').value;
        const troopLevel = document.getElementById('troopLevel').value;
        const notes = document.getElementById('troopResearch').value;

        if (!playerName || !troopType || !troopLevel) {
          showStatus('Please fill in all required fields.', 'err');
          return;
        }

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              showStatus(result.message, 'ok');
              resetTroopForm();
              updatePlayerHistory();
            } else {
              showStatus(result.message, 'err');
            }
          })
          .withFailureHandler(error => {
            showStatus('Error: ' + error.toString(), 'err');
          })
          .addTroopEntry(playerName, troopType, parseInt(troopLevel), notes);
      }

      function resetTroopForm() {
        document.getElementById('troopPlayerName').value = '';
        document.getElementById('troopType').value = '';
        document.getElementById('troopLevel').value = '';
        document.getElementById('troopResearch').value = '';
        document.getElementById('troopPlayerHistoryContainer').style.display = 'none';
        document.getElementById('troopEntryMessage').className = 'status';
      }

      function updatePlayerHistory() {
        const playerName = document.getElementById('troopPlayerName').value;
        if (!playerName) {
          document.getElementById('troopPlayerHistoryContainer').style.display = 'none';
          return;
        }

        google.script.run
          .withSuccessHandler(history => {
            const container = document.getElementById('troopPlayerHistoryContainer');
            const tableDiv = document.getElementById('troopPlayerHistoryTable');

            if (history.length === 0) {
              tableDiv.innerHTML = '<div class="no-data">No history yet for this player</div>';
              container.style.display = 'block';
              return;
            }

            let html = '<div class="history-table">';
            html += '<div class="table-header"><div>Date</div><div>Type</div><div>Level</div><div>Notes</div></div>';

            history.slice(0, 10).forEach(entry => {
              const date = new Date(entry.timestamp).toLocaleString();
              html += `<div class="table-row">
                <div class="table-cell timestamp">${date}</div>
                <div class="table-cell">${entry.type}</div>
                <div class="table-cell level">${entry.level}</div>
                <div class="table-cell">${entry.notes || '-'}</div>
              </div>`;
            });

            html += '</div>';
            tableDiv.innerHTML = html;
            container.style.display = 'block';
          })
          .getTroopHistory(playerName);
      }

      function loadPlayerHistory() {
        const playerName = document.getElementById('troopHistoryPlayerSelect').value;
        const contentDiv = document.getElementById('troopPlayerHistoryContent');

        if (!playerName) {
          contentDiv.innerHTML = '';
          return;
        }

        google.script.run
          .withSuccessHandler(history => {
            if (history.length === 0) {
              contentDiv.innerHTML = '<div class="no-data">No history found for this player</div>';
              return;
            }

            google.script.run
              .withSuccessHandler(latest => {
                let html = '<div style="margin-bottom: 20px;">';
                html += '<h2 style="font-size: 14px; margin-bottom: 12px;">Latest Levels</h2>';
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px;">';

                const types = ['G', 'M', 'S', 'E', 'C'];
                types.forEach(type => {
                  const level = latest[type];
                  const display = level !== null ? level : '-';
                  const bgColor = type === 'C' ? '#fff3e0' : 'white';
                  const borderColor = type === 'C' ? '#ffe0b2' : '#e8eaed';
                  const textColor = type === 'C' ? '#e65100' : '#5f6368';
                  const textWeight = type === 'C' ? 'bold' : '500';
                  html += `<div style="padding: 12px; background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 4px; text-align: center;">
                    <div style="font-size: 12px; color: ${textColor}; font-weight: ${textWeight};">${type}</div>
                    <div style="font-size: 20px; font-weight: 600; color: #1a73e8;">${display}</div>
                  </div>`;
                });

                html += '</div></div>';

                html += '<div class="history-table">';
                html += '<div class="table-header"><div>Date</div><div>Type</div><div>Level</div><div>Notes</div></div>';

                history.forEach(entry => {
                  const date = new Date(entry.timestamp).toLocaleString();
                  html += `<div class="table-row">
                    <div class="table-cell timestamp">${date}</div>
                    <div class="table-cell">${entry.type}</div>
                    <div class="table-cell level">${entry.level}</div>
                    <div class="table-cell">${entry.notes || '-'}</div>
                  </div>`;
                });

                html += '</div>';
                contentDiv.innerHTML = html;
              })
              .getLatestTroopLevels(playerName);
          })
          .getTroopHistory(playerName);
      }

      function loadTroopSummary() {
        const contentDiv = document.getElementById('troopSummaryContent');
        const tableDiv = document.getElementById('troopMembersTable');
        const tbody = document.getElementById('troopMembersTableBody');

        contentDiv.className = 'loading';
        contentDiv.textContent = 'Loading...';
        tableDiv.style.display = 'none';

        google.script.run
          .withSuccessHandler(summary => {
            console.log('[loadTroopSummary] Received summary:', summary, 'Type:', typeof summary, 'IsArray:', Array.isArray(summary), 'Length:', summary?.length);
            // Defensive null check - ensure summary is an array
            if (!summary || !Array.isArray(summary) || summary.length === 0) {
              google.script.run
                .withSuccessHandler(debug => {
                  if (debug && debug.ok) {
                    const lines = [
                      'No troop data available yet.',
                      `Members: ${debug.membersCount || 0}`,
                      `TroopData rows: ${debug.troopDataRowCount || 0}`,
                      `Spreadsheet: ${debug.spreadsheetName || 'unknown'}`
                    ];
                    contentDiv.innerHTML = `<div class="no-data" style="white-space: pre-line;">${lines.join('\n')}</div>`;
                    tableDiv.style.display = 'none';
                    return;
                  }

                  const err = debug && debug.error ? debug.error : 'Debug check failed';
                  contentDiv.innerHTML = `<div class="no-data">No troop data available yet. (${err})</div>`;
                  tableDiv.style.display = 'none';
                })
                .withFailureHandler(error => {
                  contentDiv.innerHTML = '<div class="no-data">No troop data available yet</div>';
                  tableDiv.style.display = 'none';
                  console.error('getTroopSummaryDebug failed:', error);
                })
                .getTroopSummaryDebug();
              return;
            }

            summaryData = summary;
            renderTroopSummary();

            contentDiv.className = '';
            contentDiv.textContent = '';
          })
          .withFailureHandler(error => {
            contentDiv.innerHTML = '<div class="no-data">Error loading summary: ' + error.toString() + '</div>';
            tableDiv.style.display = 'none';
          })
          .getAllTroopLevelsSummary();
      }

      return { init, switchSubTab, submitTroopEntry, resetTroopForm, updatePlayerHistory, loadPlayerHistory, loadTroopSummary };
    })();

    // Progress Tab
    const ProgressTab = (() => {
      let progressData=[]; let filteredData=[]; let currentSort={column:'recentGrowthPercent',direction:'desc'}; let currentEvents=[]; let currentParticipationMap={}; let currentPeriod='week'; const PARTICIPATION_CACHE_KEY='moo_participation_cache'; const PARTICIPATION_TIMESTAMP_KEY='moo_participation_timestamp';
      function init() {
        loadProgress(); document.getElementById('progSearchInput').addEventListener('input',(e)=>filterMembers(e.target.value)); document.querySelectorAll('#progress th[data-column]').forEach(th=>{ th.addEventListener('click',()=>sortTable(th.dataset.column)); });
      }
      function loadProgress() { showLoading(); google.script.run.withSuccessHandler(onProgressLoaded).withFailureHandler(onError).getProgressData(currentPeriod); }
      function setPeriod(period) { 
        currentPeriod=period; 
        // Update button styles
        document.querySelectorAll('.period-btn').forEach(btn=>{ 
          if (btn.dataset.period===period) { 
            btn.style.color='#1a73e8'; 
            btn.style.borderBottomColor='#1a73e8'; 
            btn.style.borderBottom='3px solid #1a73e8'; 
          } else { 
            btn.style.color='#5f6368'; 
            btn.style.borderBottom='none'; 
          } 
        }); 
        // Update period display label
        const today = new Date();
        const formatDisplayDate = (date) => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        let periodLabel = '';
        if (period === 'week') {
          const start = new Date(today);
          start.setDate(start.getDate() - start.getDay());
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          periodLabel = `Viewing: This Week (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        } else if (period === 'prevweek') {
          const start = new Date(today);
          start.setDate(start.getDate() - start.getDay());
          start.setDate(start.getDate() - 7);
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          periodLabel = `Viewing: Previous Week (Sun‚ÄìSat): ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        } else if (period === 'month') {
          const start = new Date(today.getFullYear(), today.getMonth(), 1);
          const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          periodLabel = `Viewing: This Month: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        } else if (period === '2months') {
          const start = new Date(today.getFullYear(), today.getMonth() - 2, 1);
          const end = today;
          periodLabel = `Viewing: Last 2 Months: ${formatDisplayDate(start)} ‚Äì ${formatDisplayDate(end)}`;
        }
        document.getElementById('progressPeriodDisplay').textContent = periodLabel;
        clearParticipationCache(); 
        loadProgress(); 
      }
      function clearCacheAndRefresh() { sessionStorage.removeItem(PARTICIPATION_CACHE_KEY); sessionStorage.removeItem(PARTICIPATION_TIMESTAMP_KEY); loadProgress(); }
      function onProgressLoaded(result) {
        if (!result || !result.success) { onError(result?.error||'Failed to load progress data'); return; }
        console.log('[DEBUG] onProgressLoaded: result.members=%s, result.events=%s', result.members?.length||0, result.events?.length||0);
        if (result.events && result.events.length > 0) {
          console.log('[DEBUG] First event: %s, participationDetails=%s', result.events[0].name, result.events[0].participationDetails?.length||0);
        }
        progressData=result.members; filteredData=[...progressData]; filteredData.sort((a,b)=>b.recentGrowthPercent-a.recentGrowthPercent); if (progressData.length===0) { showEmpty(); return; }
        updateSummary(result.summary); updateHighlights(result.summary); loadParticipationAndRender(result.events||[], result.members||[]); showTable(); const growthHeader=document.querySelector('#progress th[data-column="recentGrowthPercent"]'); if (growthHeader) growthHeader.classList.add('sorted-desc');
      }
      function onError(error) { console.error('Error loading progress:',error); document.getElementById('progLoading').innerHTML='<p style="color:#c33;">Error loading progress data. Please try again.</p>'; }
      function updateSummary(summary) { 
        document.getElementById('progTotalMembers').textContent=summary.totalMembers.toLocaleString(); 
        document.getElementById('progAverageGrowth').textContent=summary.averageGrowth.toFixed(1)+'%'; 
        document.getElementById('progEventParticipationRate').textContent=summary.eventParticipationRate.toFixed(1)+'%'; 
        document.getElementById('progTopEventName').textContent=summary.topEvent?.name||'-'; 
        document.getElementById('progTopEventStats').textContent=(summary.topEvent?.participation||0).toFixed(1)+'% participating'; 
      }
      function updateHighlights(summary) { if (summary.mostActive) { document.getElementById('progMostActiveName').textContent=summary.mostActive.name; document.getElementById('progMostActiveStats').textContent=`${summary.mostActive.chestCount} chest contributions`; } if (summary.fastestGrowing) { document.getElementById('progFastestGrowingName').textContent=summary.fastestGrowing.name; document.getElementById('progFastestGrowingStats').textContent=`${summary.fastestGrowing.growthPercent.toFixed(1)}% growth (${formatMight(summary.fastestGrowing.mightGrowth)})`; } if (summary.highestMight) { document.getElementById('progHighestMightName').textContent=summary.highestMight.name; document.getElementById('progHighestMightStats').textContent=`${formatMight(summary.highestMight.latestMight)} might`; } }
      function clearParticipationCache() { sessionStorage.removeItem(PARTICIPATION_CACHE_KEY); sessionStorage.removeItem(PARTICIPATION_TIMESTAMP_KEY); }
      function loadParticipationAndRender(events,members) {
        currentEvents=events||[]; 
        // Sort events by start date (earliest first, most recent last)
        currentEvents.sort((a,b)=>{
          const dateA=new Date(a.startDate);
          const dateB=new Date(b.startDate);
          return dateA-dateB;
        });
        console.log('[DEBUG] loadParticipationAndRender: events=%s (sorted by start date), members=%s', currentEvents.length, members?.length||0);
        if (currentEvents.length===0) { 
          console.log('[DEBUG] No events, rendering table without participation columns');
          currentParticipationMap={}; 
          renderTable(); 
          return; 
        }
        
        // Build participation map from event participationDetails instead of calling getAllEventParticipation
        currentParticipationMap = {};
        currentEvents.forEach(event => {
          console.log('[DEBUG] Processing event: %s, participationDetails=%s', event.name, event.participationDetails?.length||0);
          if (event.participationDetails && Array.isArray(event.participationDetails)) {
            event.participationDetails.forEach(detail => {
              const key = `${detail.member}_${event.name}`;
              currentParticipationMap[key] = {
                member: detail.member,
                event: event.name,
                value: detail.value,
                threshold: detail.threshold,
                met: detail.met
              };
            });
          }
        });
        console.log('[DEBUG] Built participation map from event details: %s records', Object.keys(currentParticipationMap).length);
        renderTable();
      }
      function filterMembers(searchTerm) { const term=searchTerm.toLowerCase().trim(); filteredData = term ? progressData.filter(m=>m.name.toLowerCase().includes(term)) : [...progressData]; renderTable(); if (filteredData.length===0) showEmpty(); else showTable(); }
      function sortTable(column) { if (currentSort.column===column) currentSort.direction = currentSort.direction==='asc'?'desc':'asc'; else { currentSort.column=column; currentSort.direction='asc'; }
        filteredData.sort((a,b)=>{ let aVal=a[column]; let bVal=b[column]; if (column==='joinDate'||column==='latestDate') { aVal=new Date(aVal); bVal=new Date(bVal); } if (aVal<bVal) return currentSort.direction==='asc'?-1:1; if (aVal>bVal) return currentSort.direction==='asc'?1:-1; return 0; });
        document.querySelectorAll('#progress th[data-column]').forEach(th=>th.classList.remove('sorted-asc','sorted-desc')); const currentTh=document.querySelector(`#progress th[data-column="${column}"]`); if (currentTh) currentTh.classList.add(`sorted-${currentSort.direction}`); renderTable(); }
      function renderTable() {
        console.log('[DEBUG] renderTable: currentEvents=%s, filteredData=%s, participationMap keys=%s', currentEvents.length, filteredData.length, Object.keys(currentParticipationMap).length);
        const headerRow=document.getElementById('progressTableHeader'); headerRow.innerHTML=`<th data-column="name">Member Name</th><th data-column="chestCount">Chests</th><th data-column="latestMight">Latest Might</th><th data-column="growthPercent">Growth %</th><th data-column="recentGrowthPercent">Recent %</th>`;
        currentEvents.forEach((event,idx)=>{ 
          console.log('[DEBUG] Adding event header: event=%s (method=%s)', event.name, event.participationMethod);
          const th=document.createElement('th'); th.className='event-column'; th.title=`${event.name} (${event.participationMethod})`; th.innerHTML=`${escapeHtml(event.name)}<br><small style="font-size:9px; opacity:0.7;">‚úì/‚ö†/‚úï</small>`; headerRow.appendChild(th); 
        });
        const tbody=document.getElementById('progressTableBody'); tbody.innerHTML='';
        filteredData.forEach(member=>{
          const row=document.createElement('tr'); let html=`<td class="member-name">${escapeHtml(member.name)}</td><td class="stat-cell">${member.chestCount||0}</td><td class="stat-cell">${formatMight(member.latestMight)}</td><td class="stat-cell">${member.growthPercent.toFixed(1)}%</td><td class="stat-cell">${member.recentGrowthPercent.toFixed(1)}%</td>`;
          currentEvents.forEach(event=>{ 
            const key=`${member.name}_${event.name}`; 
            const participation=currentParticipationMap[key]; 
            console.log('[DEBUG] Row cell: member=%s, event=%s, key=%s, found=%s, value=%s, met=%s', member.name, event.name, key, !!participation, participation?.value, participation?.met);
            
            // Check if event hasn't started yet OR member joined after event started
            const eventStart = new Date(event.startDate);
            const memberJoinDate = new Date(member.joinDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const hasNotStarted = eventStart > today;
            const memberJoinedAfterEvent = memberJoinDate > eventStart;
            
            if (hasNotStarted || memberJoinedAfterEvent) {
              // Event hasn't started yet OR member wasn't in clan when event occurred - show gray line
              html += '<td class="event-cell"><span class="not-started" style="color:#999;">‚àí</span></td>';
            } else if (event.participationMethod==='chest-based') { 
              if (!participation || participation.value===0) {
                html += '<td class="event-cell"><span class="cross">‚úï</span></td>';
              } else if (!participation.met) {
                html += '<td class="event-cell"><span class="warning">‚ö†</span></td>';
              } else {
                html += '<td class="event-cell"><span class="checkmark">‚úì</span></td>';
              }
            } else if (event.participationMethod==='manual-entry') { 
              if (!participation || participation.value===0) {
                html += '<td class="event-cell"><span class="cross">‚úï</span></td>';
              } else if (!participation.met) {
                html += '<td class="event-cell"><span class="warning">‚ö†</span></td>';
              } else {
                html += '<td class="event-cell"><span class="checkmark">‚úì</span></td>';
              }
            } else { 
              html+='<td class="event-cell">-</td>'; 
            } 
          });
          row.innerHTML=html; tbody.appendChild(row);
        });
        console.log('[DEBUG] Table render complete: %s event headers, %s data rows', currentEvents.length, filteredData.length);
        // Re-attach click handlers to the newly created header cells
        document.querySelectorAll('#progress th[data-column]').forEach(th=>{ th.addEventListener('click',()=>sortTable(th.dataset.column)); });
      }
      function formatMight(might) { if (!might||might===0) return '-'; return might.toLocaleString(); }
      function escapeHtml(text) { const div=document.createElement('div'); div.textContent=text; return div.innerHTML; }
      function showLoading() { document.getElementById('progLoading').style.display='block'; document.getElementById('progressTable').style.display='none'; document.getElementById('progEmpty').style.display='none'; }
      function showTable() { document.getElementById('progLoading').style.display='none'; document.getElementById('progressTable').style.display='table'; document.getElementById('progEmpty').style.display='none'; }
      function showEmpty() { document.getElementById('progLoading').style.display='none'; document.getElementById('progressTable').style.display='none'; document.getElementById('progEmpty').style.display='block'; }
      return { init, clearCacheAndRefresh, setPeriod };
    })();

    const CompensationTab = (() => {
      // Silver values per unit by troop type
      const TROOP_VALUES = {
        guardsmen: 80,
        specialists: 80,
        siege: 400,
        mercenary: 400
      };

      const MONSTER_VALUES = {
        'III': 2600, 'IV': 4800, 'V': 7040, 'VI': 9720,
        'VII': 12570, 'VIII': 15600, 'IX': 18850
      };

      const GRIFFIN_VALUES = {
        'V': 1000, 'VI': 1800, 'VII': 2600,
        'Corax I': 3400, 'Corax II': 4200
      };

      const BUILDING_VALUES = {
        'Clan Capital': 100000000,
        'Other Buildings': 3000000,
        'Portals': 2000000,
        'City Wall': 200000,
        'Gold': 2000,
        'Tar': 1000
      };

      // Track the currently editing report (null if new)
      let currentEditingReport = null;

      function calculate() {
        const name = document.getElementById('compensationName').value.trim();
        if (!name) {
          showStatus('Please enter an incident name', 'err');
          return;
        }

        let herosCaptains = 0;
        let troops = 0;
        let monsters = 0;
        let buildings = 0;

        // Heroes and Captains: level √ó count √ó 1200
        for (let level = 1; level <= 30; level++) {
          const heroCount = parseInt(document.getElementById(`heroL${level}`).value) || 0;
          herosCaptains += level * heroCount * 1200;
          
          const captainCount = parseInt(document.getElementById(`captainL${level}`).value) || 0;
          herosCaptains += level * captainCount * 1200;
        }

        // Guardsmen by level: level √ó count √ó 80
        for (let level = 1; level <= 9; level++) {
          const count = parseInt(document.getElementById(`guardsmenL${level}`).value) || 0;
          troops += level * count * TROOP_VALUES.guardsmen;
        }

        // Specialists by level: level √ó count √ó 80
        for (let level = 1; level <= 9; level++) {
          const count = parseInt(document.getElementById(`specialistsL${level}`).value) || 0;
          troops += level * count * TROOP_VALUES.specialists;
        }

        // Siege Engines by level: level √ó count √ó 400
        for (let level = 1; level <= 9; level++) {
          const count = parseInt(document.getElementById(`siegeL${level}`).value) || 0;
          troops += level * count * TROOP_VALUES.siege;
        }

        // Mercenaries by level: level √ó count √ó 400
        for (let level = 1; level <= 9; level++) {
          const count = parseInt(document.getElementById(`mercenaryL${level}`).value) || 0;
          troops += level * count * TROOP_VALUES.mercenary;
        }

        // Monsters
        monsters += (parseInt(document.getElementById('monsterIII').value) || 0) * MONSTER_VALUES['III'];
        monsters += (parseInt(document.getElementById('monsterIV').value) || 0) * MONSTER_VALUES['IV'];
        monsters += (parseInt(document.getElementById('monsterV').value) || 0) * MONSTER_VALUES['V'];
        monsters += (parseInt(document.getElementById('monsterVI').value) || 0) * MONSTER_VALUES['VI'];
        monsters += (parseInt(document.getElementById('monsterVII').value) || 0) * MONSTER_VALUES['VII'];
        monsters += (parseInt(document.getElementById('monsterVIII').value) || 0) * MONSTER_VALUES['VIII'];
        monsters += (parseInt(document.getElementById('monsterIX').value) || 0) * MONSTER_VALUES['IX'];

        // Griffins
        monsters += (parseInt(document.getElementById('griffinV').value) || 0) * GRIFFIN_VALUES['V'];
        monsters += (parseInt(document.getElementById('griffinVI').value) || 0) * GRIFFIN_VALUES['VI'];
        monsters += (parseInt(document.getElementById('griffinVII').value) || 0) * GRIFFIN_VALUES['VII'];
        monsters += (parseInt(document.getElementById('coraxI').value) || 0) * GRIFFIN_VALUES['Corax I'];
        monsters += (parseInt(document.getElementById('coraxII').value) || 0) * GRIFFIN_VALUES['Corax II'];

        // Buildings
        buildings += (parseInt(document.getElementById('clanCapital').value) || 0) * BUILDING_VALUES['Clan Capital'];
        buildings += (parseInt(document.getElementById('otherBuildingsCount').value) || 0) * BUILDING_VALUES['Other Buildings'];
        buildings += (parseInt(document.getElementById('portalsCount').value) || 0) * BUILDING_VALUES['Portals'];
        buildings += (parseInt(document.getElementById('cityWallCount').value) || 0) * BUILDING_VALUES['City Wall'];
        buildings += (parseInt(document.getElementById('goldAmount').value) || 0) * BUILDING_VALUES['Gold'];
        buildings += (parseInt(document.getElementById('tarAmount').value) || 0) * BUILDING_VALUES['Tar'];

        const grandTotal = herosCaptains + troops + monsters + buildings;
        const breakdown = {
          herosCaptains: herosCaptains,
          troops: troops,
          monsters: monsters,
          buildings: buildings
        };

        showStatus('‚è≥ Saving...', '');

        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              document.getElementById('resultHeroes').textContent = breakdown.herosCaptains.toLocaleString();
              document.getElementById('resultTroops').textContent = breakdown.troops.toLocaleString();
              document.getElementById('resultMonsters').textContent = breakdown.monsters.toLocaleString();
              document.getElementById('resultBuildings').textContent = breakdown.buildings.toLocaleString();
              document.getElementById('resultGrandTotal').textContent = grandTotal.toLocaleString() + ' silver';
              document.getElementById('resultSheetName').textContent = result.sheetName;
              document.getElementById('compensationResult').style.display = 'block';
              showStatus('‚úì Compensation calculated and saved!', 'ok');
            } else {
              showStatus('‚úï Error: ' + (result.error || 'Unknown error'), 'err');
            }
          })
          .withFailureHandler((error) => {
            showStatus('‚úï Error: ' + error.message, 'err');
          })
          .saveCompensation(name, breakdown, grandTotal);
      }

      function clearForm() {
        document.getElementById('compensationName').value = '';
        // Clear heroes and captains (level 1-30)
        for (let level = 1; level <= 30; level++) {
          document.getElementById(`heroL${level}`).value = '';
          document.getElementById(`captainL${level}`).value = '';
        }
        // Clear troops (level 1-9)
        for (let level = 1; level <= 9; level++) {
          document.getElementById(`guardsmenL${level}`).value = '';
          document.getElementById(`specialistsL${level}`).value = '';
          document.getElementById(`siegeL${level}`).value = '';
          document.getElementById(`mercenaryL${level}`).value = '';
        }
        // Clear monsters and creatures
        document.getElementById('monsterIII').value = '';
        document.getElementById('monsterIV').value = '';
        document.getElementById('monsterV').value = '';
        document.getElementById('monsterVI').value = '';
        document.getElementById('monsterVII').value = '';
        document.getElementById('monsterVIII').value = '';
        document.getElementById('monsterIX').value = '';
        document.getElementById('griffinV').value = '';
        document.getElementById('griffinVI').value = '';
        document.getElementById('griffinVII').value = '';
        document.getElementById('coraxI').value = '';
        document.getElementById('coraxII').value = '';
        // Clear buildings
        document.getElementById('clanCapital').value = '';
        document.getElementById('otherBuildingsCount').value = '';
        document.getElementById('portalsCount').value = '';
        document.getElementById('cityWallCount').value = '';
        document.getElementById('goldAmount').value = '';
        document.getElementById('tarAmount').value = '';
        document.getElementById('compensationStatus').textContent = '';
        document.getElementById('compensationResult').style.display = 'none';
        // Clear editing state
        currentEditingReport = null;
      }

      function showStatus(message, type) {
        const status = document.getElementById('compensationStatus');
        status.textContent = message;
        status.className = 'status ' + type;
      }

      function showQuickStatus(message, type) {
        const status = document.getElementById('quickAddStatus');
        status.textContent = message;
        status.className = 'status ' + type;
        setTimeout(() => { status.textContent = ''; }, 3000);
      }

      function quickAddLeader() {
        const type = document.getElementById('quickLeaderType').value;
        const level = parseInt(document.getElementById('quickLeaderLevel').value) || 0;
        const amount = parseInt(document.getElementById('quickLeaderAmount').value) || 0;

        if (level < 1 || level > 30) {
          showQuickStatus('Level must be between 1 and 30', 'err');
          return;
        }

        if (amount <= 0) {
          showQuickStatus('Amount must be greater than 0', 'err');
          return;
        }

        // Update the corresponding field
        const fieldId = `${type}L${level}`;
        const field = document.getElementById(fieldId);
        if (field) {
          const currentValue = parseInt(field.value) || 0;
          field.value = currentValue + amount;
          field.style.background = '#e8f5e9';
          setTimeout(() => field.style.background = '#fff', 500);
          
          const typeName = type.charAt(0).toUpperCase() + type.slice(1);
          showQuickStatus(`‚úì Added ${amount} level ${level} ${typeName}(s)`, 'ok');
          document.getElementById('quickLeaderAmount').value = '';
          document.getElementById('quickLeaderAmount').focus();
        }
      }

      function quickAddTroop() {
        const type = document.getElementById('quickTroopType').value;
        const level = parseInt(document.getElementById('quickTroopLevel').value) || 0;
        const amount = parseInt(document.getElementById('quickTroopAmount').value) || 0;

        if (level < 1 || level > 9) {
          showQuickStatus('Level must be between 1 and 9', 'err');
          return;
        }

        if (amount <= 0) {
          showQuickStatus('Amount must be greater than 0', 'err');
          return;
        }

        // Update the corresponding field
        const fieldId = `${type}L${level}`;
        const field = document.getElementById(fieldId);
        if (field) {
          const currentValue = parseInt(field.value) || 0;
          field.value = currentValue + amount;
          field.style.background = '#e8f5e9';
          setTimeout(() => field.style.background = '#fff', 500);
          
          showQuickStatus(`‚úì Added ${amount} level ${level} ${type}`, 'ok');
          document.getElementById('quickTroopAmount').value = '';
          document.getElementById('quickTroopAmount').focus();
        }
      }

      function quickAddMonster() {
        const type = document.getElementById('quickMonsterType').value;
        const amount = parseInt(document.getElementById('quickMonsterAmount').value) || 0;

        if (amount <= 0) {
          showQuickStatus('Amount must be greater than 0', 'err');
          return;
        }

        const field = document.getElementById(type);
        if (field) {
          const currentValue = parseInt(field.value) || 0;
          field.value = currentValue + amount;
          field.style.background = '#e8f5e9';
          setTimeout(() => field.style.background = '#fff', 500);
          
          const typeName = document.querySelector(`#quickMonsterType option[value="${type}"]`).textContent;
          showQuickStatus(`‚úì Added ${amount} ${typeName}`, 'ok');
          document.getElementById('quickMonsterAmount').value = '';
          document.getElementById('quickMonsterAmount').focus();
        }
      }

      function quickAddBuilding() {
        const type = document.getElementById('quickBuildingType').value;
        const amount = parseInt(document.getElementById('quickBuildingAmount').value) || 0;

        if (type === 'clanCapital') {
          // For clan capital, just mark it as yes (1)
          if (amount > 0) {
            document.getElementById(type).value = '1';
            document.getElementById(type).style.background = '#e8f5e9';
            setTimeout(() => document.getElementById(type).style.background = '#fff', 500);
            showQuickStatus(`‚úì Clan Capital marked as lost`, 'ok');
            document.getElementById('quickBuildingAmount').value = '';
          } else {
            showQuickStatus('Set amount to 1 to mark Clan Capital as lost', 'err');
          }
          return;
        }

        if (amount <= 0) {
          showQuickStatus('Amount must be greater than 0', 'err');
          return;
        }

        const field = document.getElementById(type);
        if (field) {
          const currentValue = parseInt(field.value) || 0;
          field.value = currentValue + amount;
          field.style.background = '#e8f5e9';
          setTimeout(() => field.style.background = '#fff', 500);
          
          const typeName = document.querySelector(`#quickBuildingType option[value="${type}"]`).textContent;
          showQuickStatus(`‚úì Added ${amount} ${typeName}`, 'ok');
          document.getElementById('quickBuildingAmount').value = '';
          document.getElementById('quickBuildingAmount').focus();
        }
      }

      function loadReports() {
        document.getElementById('compensationReportsLoading').style.display = 'block';
        document.getElementById('compensationReportsList').innerHTML = '';
        document.getElementById('compensationReportsEmpty').style.display = 'none';

        google.script.run
          .withSuccessHandler((result) => {
            document.getElementById('compensationReportsLoading').style.display = 'none';
            
            if (result.success && result.reports.length > 0) {
              const container = document.getElementById('compensationReportsList');
              container.innerHTML = result.reports.map(report => `
                <div onclick="CompensationTab.viewDetail('${report.sheetName}')" style="background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); cursor: pointer; transition: all 0.2s; border-left: 4px solid #1a73e8;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.12)'; this.style.transform='translateY(0)'">
                  <div style="font-size: 14px; font-weight: 600; color: #202124; margin-bottom: 4px;">${report.incidentName}</div>
                  <div style="font-size: 12px; color: #5f6368;">üìÖ ${report.date}</div>
                  <div style="margin-top: 8px; font-size: 11px; color: #1a73e8; font-weight: 600;">Click to view details ‚Üí</div>
                </div>
              `).join('');
            } else {
              document.getElementById('compensationReportsEmpty').style.display = 'block';
            }
          })
          .withFailureHandler((error) => {
            document.getElementById('compensationReportsLoading').style.display = 'none';
            document.getElementById('compensationReportsEmpty').style.display = 'block';
            document.getElementById('compensationReportsEmpty').textContent = 'Error loading reports: ' + error.message;
          })
          .getCompensationReports();
      }

      function viewDetail(sheetName) {
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success) {
              const content = document.getElementById('compensationDetailContent');
              content.innerHTML = `
                <div style="margin-bottom: 20px;">
                  <div style="font-size: 13px; color: #5f6368; margin-bottom: 4px;">INCIDENT</div>
                  <div style="font-size: 20px; font-weight: 600; color: #202124;">${result.incidentName}</div>
                  <div style="font-size: 13px; color: #5f6368; margin-top: 4px;">üìÖ ${result.date}</div>
                </div>

                <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                  <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; display: flex; justify-content: space-between;">
                    <span style="color: #5f6368; font-size: 13px;">Heroes & Captains</span>
                    <span style="font-weight: 600; color: #1a73e8;">${result.breakdown.herosCaptains.toLocaleString()}</span>
                  </div>
                  <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; display: flex; justify-content: space-between;">
                    <span style="color: #5f6368; font-size: 13px;">Troops</span>
                    <span style="font-weight: 600; color: #34a853;">${result.breakdown.troops.toLocaleString()}</span>
                  </div>
                  <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; display: flex; justify-content: space-between;">
                    <span style="color: #5f6368; font-size: 13px;">Monsters & Creatures</span>
                    <span style="font-weight: 600; color: #fbbc04;">${result.breakdown.monsters.toLocaleString()}</span>
                  </div>
                  <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; display: flex; justify-content: space-between;">
                    <span style="color: #5f6368; font-size: 13px;">Buildings & Resources</span>
                    <span style="font-weight: 600; color: #ea4335;">${result.breakdown.buildings.toLocaleString()}</span>
                  </div>
                </div>

                <div style="background: linear-gradient(135deg, #1a73e8 0%, #1765c1 100%); color: white; border-radius: 8px; padding: 20px; text-align: center;">
                  <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">GRAND TOTAL</div>
                  <div style="font-size: 36px; font-weight: 700;">${result.grandTotal.toLocaleString()} silver</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                  <button onclick="CompensationTab.editReport('${result.sheetName}')" style="padding: 10px 16px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">‚úèÔ∏è Edit</button>
                  <button onclick="CompensationTab.deleteReport('${result.sheetName}')" style="padding: 10px 16px; background: #ea4335; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">üóëÔ∏è Delete</button>
                </div>
              `;
              document.getElementById('compensationDetailModal').style.display = 'block';
            }
          })
          .withFailureHandler((error) => {
            alert('Error loading report details: ' + error.message);
          })
          .getCompensationReportDetails(sheetName);
      }

      function closeDetail() {
        document.getElementById('compensationDetailModal').style.display = 'none';
      }

      function editReport(sheetName) {
        showStatus('‚è≥ Loading report data...', '');
        
        google.script.run
          .withSuccessHandler((result) => {
            if (result.success && result.parameters) {
              // Load parameters back into form
              const params = result.parameters;
              
              // Load heroes
              if (params.heroes) {
                Object.entries(params.heroes).forEach(([level, count]) => {
                  document.getElementById(`heroL${level}`).value = count;
                });
              }
              
              // Load captains
              if (params.captains) {
                Object.entries(params.captains).forEach(([level, count]) => {
                  document.getElementById(`captainL${level}`).value = count;
                });
              }
              
              // Load guardsmen
              if (params.guardsmen) {
                Object.entries(params.guardsmen).forEach(([level, count]) => {
                  document.getElementById(`guardsmenL${level}`).value = count;
                });
              }
              
              // Load specialists
              if (params.specialists) {
                Object.entries(params.specialists).forEach(([level, count]) => {
                  document.getElementById(`specialistsL${level}`).value = count;
                });
              }
              
              // Load siege
              if (params.siege) {
                Object.entries(params.siege).forEach(([level, count]) => {
                  document.getElementById(`siegeL${level}`).value = count;
                });
              }
              
              // Load mercenary
              if (params.mercenary) {
                Object.entries(params.mercenary).forEach(([level, count]) => {
                  document.getElementById(`mercenaryL${level}`).value = count;
                });
              }
              
              // Load monsters
              if (params.monsters) {
                Object.entries(params.monsters).forEach(([type, count]) => {
                  const field = document.getElementById(type);
                  if (field) field.value = count;
                });
              }
              
              // Load buildings
              if (params.buildings) {
                if (params.buildings.clanCapital) {
                  document.getElementById('clanCapital').checked = true;
                }
                if (params.buildings.otherBuildings) {
                  document.getElementById('otherBuildingsCount').value = params.buildings.otherBuildings;
                }
                if (params.buildings.portals) {
                  document.getElementById('portalsCount').value = params.buildings.portals;
                }
                if (params.buildings.cityWalls) {
                  document.getElementById('cityWallCount').value = params.buildings.cityWalls;
                }
                if (params.buildings.gold) {
                  document.getElementById('goldAmount').value = params.buildings.gold;
                }
                if (params.buildings.tar) {
                  document.getElementById('tarAmount').value = params.buildings.tar;
                }
              }
              
              // Update incident name
              document.getElementById('compensationName').value = result.incidentName;
              
              // Set tracking variable
              currentEditingReport = sheetName;
              
              // Close detail modal and scroll to form
              closeDetail();
              document.getElementById('incidentsSection').scrollIntoView({ behavior: 'smooth' });
              showStatus('‚úì Report loaded! Make changes and click Calculate to save.', 'ok');
            } else {
              showStatus('‚úï Error loading report parameters', 'err');
            }
          })
          .withFailureHandler((error) => {
            showStatus('‚úï Error: ' + error.message, 'err');
          })
          .getCompensationReportParameters(sheetName);
      }

      function deleteReport(sheetName) {
        if (confirm('‚ö†Ô∏è Delete this compensation report? This cannot be undone.')) {
          showStatus('‚è≥ Deleting...', '');
          
          google.script.run
            .withSuccessHandler((result) => {
              if (result.success) {
                closeDetail();
                loadReports();
                showStatus('‚úì Report deleted successfully!', 'ok');
              } else {
                showStatus('‚úï Error: ' + (result.error || 'Unknown error'), 'err');
              }
            })
            .withFailureHandler((error) => {
              showStatus('‚úï Error: ' + error.message, 'err');
            })
            .deleteCompensationReport(sheetName);
        }
      }

      function init() {
        loadReports();
      }

      return { calculate, clearForm, quickAddLeader, quickAddTroop, quickAddMonster, quickAddBuilding, loadReports, viewDetail, closeDetail, editReport, deleteReport, init };
    })();
  </script>
</body>
</html>
